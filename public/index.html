<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <title>Money Diary</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

        <style>
        /* Interフォントの読み込み（Tailwindのデフォルトに合わせる） */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --color-bg: #f6f7fb;
            --color-panel: #ffffff;
            --color-panel-muted: #f2f4fa;
            --color-elevated: #eef2ff;
            --color-border: #e2e8f0;
            --color-border-strong: #cbd5e1;
            --color-text: #0f172a;
            --color-text-muted: #64748b;
            --color-accent: #2563eb;
            --color-accent-strong: #1d4ed8;
            --color-accent-soft: rgba(37, 99, 235, 0.12);
            --color-income: #0ea5e9;
            --color-expense: #f43f5e;
            --color-income-muted: rgba(14, 165, 233, 0.12);
            --color-expense-muted: rgba(244, 63, 94, 0.15);
            --color-overlay: rgba(8, 12, 24, 0.78);
        }

        body.dark-mode {
            --color-bg: #1e1f22;
            --color-panel: #2b2d31;
            --color-panel-muted: #313338;
            --color-elevated: #3c3f44;
            --color-border: #3f4149;
            --color-border-strong: #4d5058;
            --color-text: #f2f3f5;
            --color-text-muted: #b5bac1;
            --color-accent: #5865f2;
            --color-accent-strong: #4752c4;
            --color-accent-soft: rgba(88, 101, 242, 0.2);
            --color-income: #5ed0fa;
            --color-expense: #ff7ca3;
            --color-income-muted: rgba(94, 208, 250, 0.2);
            --color-expense-muted: rgba(255, 124, 163, 0.22);
            --color-overlay: rgba(5, 7, 13, 0.9);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color 0.25s ease, color 0.25s ease;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }
        body.dark-mode {
            color-scheme: dark;
        }

        body.auth-locked,
        body.date-picker-locked {
            overflow: hidden;
            height: 100vh;
            touch-action: none;
        }

        #app-container {
            padding-top: var(--safe-area-inset-top);
            padding-bottom: calc(var(--safe-area-inset-bottom) + 12px);
            background-color: var(--color-panel);
            overscroll-behavior-y: contain;
            min-height: 100vh;
            max-width: 28rem;
        }

        #main-content {
            background-color: transparent;
            min-height: calc(100vh - var(--safe-area-inset-top));
            padding-bottom: calc(130px + var(--safe-area-inset-bottom));
            scroll-padding-bottom: 160px;
        }

        #bottom-nav {
            height: calc(76px + var(--safe-area-inset-bottom));
            padding-bottom: calc(var(--safe-area-inset-bottom) + 12px);
            background-color: var(--color-panel);
            border-top: 1px solid var(--color-border);
            box-shadow: 0 -10px 32px rgba(15, 23, 42, 0.12);
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 28rem;
        }

        body.dark-mode .text-gray-800,
        body.dark-mode .text-gray-700 {
            color: var(--color-text) !important;
        }
        body.dark-mode .text-gray-600,
        body.dark-mode .text-gray-500 {
            color: var(--color-text-muted) !important;
        }
        body.dark-mode .bg-gray-100,
        body.dark-mode .bg-gray-50 {
            background-color: var(--color-panel-muted) !important;
        }
        body.dark-mode .bg-white {
            background-color: var(--color-panel) !important;
        }
        body.dark-mode .border-gray-200,
        body.dark-mode .border-gray-300 {
            border-color: var(--color-border) !important;
        }

        #month-year-header {
            background: transparent;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            color: inherit;
            cursor: pointer;
        }
        #month-year-header:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.35);
            border-radius: 0.5rem;
        }

        .date-picker-card {
            background-color: var(--color-panel);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.35);
        }
        body.dark-mode .date-picker-card {
            box-shadow: 0 30px 70px rgba(2, 6, 23, 0.85);
        }
        .date-picker-months button {
            background-color: var(--color-panel-muted);
            color: var(--color-text);
            border: 1px solid transparent;
            border-radius: 0.85rem;
            padding: 0.65rem 0;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .date-picker-months button.active {
            background: linear-gradient(135deg, var(--color-accent), var(--color-accent-strong));
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 12px 30px rgba(88, 101, 242, 0.35);
        }

        .date-picker-year-btn {
            background-color: var(--color-panel-muted);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .date-picker-year-btn:hover {
            background-color: var(--color-elevated);
        }

        .date-picker-input {
            padding: 0.8rem 1.25rem;
            border-radius: 0.9rem;
            border: 1px solid var(--color-border);
            background-color: var(--color-panel-muted);
            color: var(--color-text);
            font-size: 1.15rem;
            font-weight: 600;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .date-picker-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.35);
        }

        .date-picker-secondary {
            background-color: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .date-picker-secondary:hover {
            background-color: var(--color-panel-muted);
            color: var(--color-text);
        }

        .date-picker-primary {
            background: linear-gradient(135deg, var(--color-accent), var(--color-accent-strong));
            color: #ffffff;
            font-weight: 600;
            border: none;
            box-shadow: 0 15px 30px rgba(88, 101, 242, 0.35);
            transition: filter 0.2s ease;
        }
        .date-picker-primary:hover {
            filter: brightness(1.05);
        }

        body.dark-mode #logout-btn {
            background-color: var(--color-panel-muted) !important;
            color: var(--color-text) !important;
            border: 1px solid var(--color-border) !important;
        }

        .summary-card {
            background-color: var(--color-panel);
            border-radius: 0.9rem;
            border: 1px solid var(--color-border);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }
        .analysis-card {
            background-color: var(--color-panel);
            border-radius: 1rem;
            border: 1px solid var(--color-border);
            box-shadow: 0 15px 40px rgba(15, 23, 42, 0.12);
        }
        .analysis-card h4,
        .summary-card h3,
        .analysis-card p {
            color: var(--color-text);
        }

        #summary-income,
        #analysis-income {
            color: var(--color-income);
        }
        #summary-expense,
        #analysis-expense {
            color: var(--color-expense);
        }
        #summary-balance,
        #analysis-balance {
            color: var(--color-text);
        }

        #diary-filter-panel,
        #diary-finance-filter-panel,
        #settings-view .bg-white {
            background-color: var(--color-panel);
            border: 1px solid var(--color-border);
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
        }

        input,
        select,
        textarea {
            background-color: var(--color-panel);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }
        input::placeholder,
        textarea::placeholder {
            color: var(--color-text-muted);
        }

        #input-modal {
            background-color: var(--color-panel);
            color: var(--color-text);
            box-shadow: 0 18px 60px rgba(15, 23, 42, 0.35);
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 100%;
        }
        #input-modal header {
            border-color: var(--color-border);
        }
        #input-modal input,
        #input-modal select,
        #input-modal textarea {
            background-color: var(--color-panel-muted);
            border-color: var(--color-border);
        }

        #type-toggle-control {
            border: 1px solid var(--color-border);
            background-color: var(--color-panel-muted) !important;
            transition: background-color 0.2s ease;
        }
        #type-toggle-control.mode-income {
            background-color: var(--color-income-muted) !important;
        }
        #type-toggle-control.mode-expense {
            background-color: var(--color-expense-muted) !important;
        }

        #toggle-expense,
        #toggle-income {
            background: transparent !important;
            color: var(--color-text-muted) !important;
            border-radius: 9999px;
            transition: all 0.2s ease;
        }
        #toggle-expense.active,
        #toggle-income.active {
            background-color: var(--color-panel) !important;
            color: var(--color-accent) !important;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.18);
        }
        #toggle-expense.active {
            color: var(--color-expense) !important;
        }
        #toggle-income.active {
            color: var(--color-income) !important;
        }

        #add-transaction-btn {
            background: linear-gradient(135deg, var(--color-accent), var(--color-accent-strong)) !important;
            color: #ffffff !important;
            border: none;
            box-shadow: 0 15px 30px rgba(88, 101, 242, 0.35);
        }
        #add-transaction-btn:hover {
            filter: brightness(1.05);
        }

        #daily-transactions li {
            background-color: var(--color-panel-muted) !important;
            border: 1px solid var(--color-border);
        }

        .category-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background-color: var(--color-panel-muted);
            color: var(--color-text);
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.85rem;
        }
        .category-chip button {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            border: none;
            background: transparent;
            color: inherit;
            cursor: pointer;
            line-height: 1;
        }

        .diary-card {
            background-color: var(--color-panel);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .diary-card:hover {
            transform: translateY(-2px);
            background-color: var(--color-panel-muted);
        }

        .filter-toggle-btn {
            width: 42px;
            height: 42px;
            border-radius: 9999px;
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-panel);
            box-shadow: 0 5px 20px rgba(15, 23, 42, 0.15);
            transition: all 0.2s ease;
        }
        .filter-toggle-btn.active {
            background-color: var(--color-accent-soft);
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .photo-modal-overlay {
            background: var(--color-overlay);
            z-index: 60;
        }
        .photo-modal-content {
            background-color: #000;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .calendar-day {
            aspect-ratio: 1 / 1;
        }
        .calendar-day:hover {
            background-color: var(--color-panel-muted);
        }
        body.dark-mode .calendar-day:hover {
            background-color: #2f3340;
            color: var(--color-text);
        }
        .calendar-day.other-month {
            opacity: 0.3;
        }

        #input-modal-content {
            max-height: calc(100vh - 120px);
        }
        
        .mood-icon {
            border: 1px solid var(--color-border);
            background-color: var(--color-panel);
            transition: transform 0.15s ease, background-color 0.15s ease, border-color 0.15s ease;
        }
        .mood-icon.selected {
            transform: scale(1.07);
            background-color: var(--color-accent-soft);
            border-color: var(--color-accent);
        }

        .auth-overlay {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            background: var(--color-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.25rem;
            padding: 2rem;
            text-align: center;
            z-index: 50;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        .auth-overlay.hidden {
            display: none;
        }
        #auth-screen button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .auth-loading-spinner {
            width: 48px;
            height: 48px;
            border-radius: 9999px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-accent);
            animation: auth-spinner 0.9s linear infinite;
        }
        @keyframes auth-spinner {
            to {
                transform: rotate(360deg);
            }
        }

        /* グローバルな使い勝手向上 */
        button,
        label,
        input,
        select,
        textarea {
            touch-action: manipulation;
        }
        #input-modal,
        #main-content {
            overscroll-behavior-y: contain;
        }
        #date-picker-modal {
            z-index: 60;
        }

        @media (min-width: 1024px) {
            #app-container,
            #bottom-nav {
                max-width: 1100px;
            }
            #input-modal {
                left: auto;
                right: 16px;
                top: var(--safe-area-inset-top);
                bottom: var(--safe-area-inset-bottom);
                width: min(480px, 42vw);
                max-width: 560px;
                transform: translateX(0);
                border-left: 1px solid var(--color-border);
                border-radius: 1rem 0 0 1rem;
            }
        }

        /* ナビゲーション */
        #bottom-nav button {
            transition: color 0.18s ease, transform 0.18s ease;
        }
        #bottom-nav button:active {
            transform: translateY(1px);
        }
        .nav-icon {
            width: 26px;
            height: 26px;
        }

        .settings-card {
            background-color: var(--color-panel);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }
        .settings-section-header {
            width: 100%;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.5rem;
            text-align: left;
        }
        .settings-section-content {
            border-top: 1px solid var(--color-border);
            margin-top: 0.5rem;
            padding-top: 0.75rem;
        }
        .settings-card.collapsed .settings-section-content {
            display: none;
        }
        .settings-card .chevron {
            transition: transform 0.2s ease, color 0.2s ease;
            color: var(--color-text-muted);
        }
        .settings-card.collapsed .chevron {
            transform: rotate(-90deg);
        }

        /* カテゴリ行・操作 */
        .category-action-btn {
            padding: 6px;
            border-radius: 0.5rem;
            border: 1px solid var(--color-border);
            background-color: var(--color-panel);
            color: var(--color-text-muted);
            transition: all 0.15s ease;
        }
        .category-action-btn:hover:not(:disabled) {
            color: var(--color-accent);
            border-color: var(--color-border-strong);
        }
        .category-action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* 定額: 曜日選択 */
        .recurring-weekday-btn {
            border: 1px solid var(--color-border);
            background-color: var(--color-panel);
            color: var(--color-text);
            transition: all 0.15s ease;
        }
        .recurring-weekday-btn.active {
            background-color: var(--color-accent-soft);
            border-color: var(--color-accent);
            color: var(--color-accent-strong);
            box-shadow: 0 6px 18px rgba(37, 99, 235, 0.15);
        }

        /* 日記モード切替 */
        #diary-mode-toggle button {
            transition: all 0.2s ease;
        }

        /* カテゴリ編集モーダル */
        .simple-modal-overlay {
            background: var(--color-overlay);
            z-index: 70;
        }
        .simple-modal-card {
            background-color: var(--color-panel);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            box-shadow: 0 25px 60px rgba(15, 23, 42, 0.35);
        }
        .simple-modal-card input {
            background-color: var(--color-panel-muted);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }
        .simple-modal-card input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.2);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- アプリ全体のコンテナ（スマホ幅に制限） -->
    <div id="app-container" class="max-w-md mx-auto min-h-screen bg-white flex flex-col overflow-hidden relative">

        <!-- 1. メインコンテンツエリア -->
        <main id="main-content" class="flex-grow overflow-y-auto">
            
            <!-- 1-1. カレンダービュー -->
            <div id="calendar-view" class="p-4 space-y-4">
                <!-- ヘッダー: 月移動 -->
                <div class="flex justify-between items-center px-2">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <button type="button" id="month-year-header" aria-label="年月を選択" class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span id="month-year-header-text"></span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <!-- 曜日ヘッダー -->
                <div class="calendar-grid text-center text-sm font-medium text-gray-500">
                    <div class="text-red-500">日</div>
                    <div>月</div>
                    <div>火</div>
                    <div>水</div>
                    <div>木</div>
                    <div>金</div>
                    <div class="text-blue-500">土</div>
                </div>

                <!-- カレンダー本体 -->
                <div id="calendar-grid-body" class="calendar-grid">
                    <!-- JSで動的に生成されます -->
                </div>

                <!-- 月次サマリー -->
                <div class="space-y-2 p-4 summary-card">
                    <h3 class="text-lg font-semibold text-gray-700">今月のサマリー</h3>
                    <div class="flex justify-around text-center">
                        <div>
                            <span class="text-sm text-gray-500">収入</span>
                            <p id="summary-income" class="text-lg font-bold text-blue-600">¥0</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">支出</span>
                            <p id="summary-expense" class="text-lg font-bold text-red-600">¥0</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">収支</span>
                            <p id="summary-balance" class="text-lg font-bold text-gray-800">¥0</p>
                        </div>
                    </div>
                    <div class="mt-2 space-y-1">
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>月の予算</span>
                            <span id="summary-budget-label" class="font-semibold text-gray-700">未設定</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                            <div id="summary-budget-bar" class="h-1.5 rounded-full bg-gray-200 transition-all duration-300" style="width:0%;"></div>
                        </div>
                        <p id="summary-budget-remaining" class="text-xs text-gray-500">設定すると今月の進捗が見られます。</p>
                    </div>
                </div>
            </div>

            <!-- 入力方法選択モーダル (アクションシート風) -->
            <div id="entry-method-modal" class="hidden fixed inset-0 z-[70] flex items-end sm:items-center justify-center">
                <div class="fixed inset-0 bg-black bg-opacity-40 transition-opacity" id="entry-method-overlay"></div>
                <div class="relative bg-white w-full max-w-sm mx-4 mb-6 sm:mb-0 rounded-xl p-4 space-y-3 shadow-xl transform transition-transform">
                    <h3 class="text-center font-bold text-gray-700 py-2">記録方法を選択</h3>
                    <div class="space-y-2">
                        <button id="method-manual-btn" class="w-full flex items-center justify-center gap-3 py-3 bg-blue-50 text-blue-700 font-bold rounded-xl active:bg-blue-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            手動で入力
                        </button>
                        <button id="method-scan-btn" class="w-full flex items-center justify-center gap-3 py-3 bg-blue-600 text-white font-bold rounded-xl active:bg-blue-700 transition-colors shadow-md">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            画像から自動入力
                        </button>
                    </div>
                    <button id="method-cancel-btn" class="w-full py-3 text-gray-500 text-sm font-medium">キャンセル</button>
                </div>
            </div>

            <!-- 1-2. 集計ビュー -->
            <div id="analysis-view" class="hidden p-4 space-y-4">
                <h2 class="text-xl font-bold text-gray-800 px-2">集計・分析</h2>

                <!-- 週/月/年 タブ -->
                <div class="flex rounded-lg bg-gray-100 p-1">
                    <button id="tab-week" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-600">週</button>
                    <button id="tab-month" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white shadow text-blue-600">月</button>
                    <button id="tab-year" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-600">年</button>
                </div>
                
                <!-- 日付/期間 移動 -->
                <div class="flex justify-between items-center px-2">
                    <button id="prev-period-analysis-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h3 id="month-year-analysis-header" class="text-lg font-semibold text-gray-700"></h3>
                    <button id="next-period-analysis-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <!-- 期間サマリー -->
                <div class="grid grid-cols-3 gap-2">
                    <div class="summary-card p-3 text-center">
                        <p class="text-xs text-gray-500">収入</p>
                        <p id="analysis-income" class="text-lg font-bold text-blue-600">¥0</p>
                    </div>
                    <div class="summary-card p-3 text-center">
                        <p class="text-xs text-gray-500">支出</p>
                        <p id="analysis-expense" class="text-lg font-bold text-red-600">¥0</p>
                    </div>
                    <div class="summary-card p-3 text-center">
                        <p class="text-xs text-gray-500">収支</p>
                        <p id="analysis-balance" class="text-lg font-bold text-gray-800">¥0</p>
                    </div>
                </div>
                <p id="analysis-budget-note" class="text-xs text-gray-500 text-center"></p>

                <!-- 支出カテゴリー（円グラフ） -->
                <div class="analysis-card p-4">
                    <h4 class="text-md font-semibold text-gray-700 mb-2">支出カテゴリー</h4>
                    <div class="w-full max-w-xs mx-auto">
                        <canvas id="expense-chart"></canvas>
                    </div>
                </div>
                
                <!-- 収支推移（棒グラフ） -->
                <div class="analysis-card p-4">
                    <h4 id="balance-chart-title" class="text-md font-semibold text-gray-700 mb-2">今月の日別収支</h4>
                    <div class="w-full mx-auto">
                        <canvas id="balance-chart"></canvas>
                    </div>
                </div>

                <!-- AIアドバイス -->
                <div class="analysis-card p-4 space-y-3">
                    <div class="flex items-center justify-between gap-3">
                        <div>
                            <h4 class="text-md font-semibold text-gray-700">AIによる収支アドバイス</h4>
                            <p class="text-xs text-gray-500">Geminiが期間内の傾向を分析します</p>
                        </div>
                        <button id="analysis-ai-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-500 transition">AIに聞く</button>
                    </div>
                    <div id="analysis-ai-output" class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg min-h-[80px] whitespace-pre-wrap">期間を選択して「AIに聞く」を押すとアドバイスが表示されます。</div>
                </div>
            </div>

            <!-- 1-3. 日記ビュー -->
            <div id="diary-view" class="hidden p-4 space-y-4">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-xl font-bold text-gray-800">記録</h2>
                    <button id="toggle-diary-filters" class="filter-toggle-btn" aria-expanded="false" aria-label="記録フィルターを切り替え">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707l-5.414 5.414A1 1 0 0015 12v5l-2 2-2-2v-5a1 1 0 00-.293-.707L5.293 6.707A1 1 0 015 6V4z"></path></svg>
                    </button>
                </div>

                <div class="flex rounded-xl bg-gray-100 p-1" id="diary-mode-toggle">
                    <button id="diary-mode-diary" class="flex-1 py-2 px-4 rounded-lg text-sm font-semibold bg-white shadow text-blue-600">日記</button>
                    <button id="diary-mode-finance" class="flex-1 py-2 px-4 rounded-lg text-sm font-semibold text-gray-600">収支</button>
                </div>

                <!-- フィルター -->
                <div id="diary-filter-panel" class="bg-white p-4 rounded-lg shadow-sm space-y-3 hidden">
                    <div>
                        <label for="diary-filter-mood" class="text-sm font-medium text-gray-600">気分</label>
                        <select id="diary-filter-mood" class="w-full mt-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                            <option value="all">すべて</option>
                        </select>
                    </div>
                    <div>
                        <label for="diary-filter-photo" class="text-sm font-medium text-gray-600">写真</label>
                        <select id="diary-filter-photo" class="w-full mt-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                            <option value="all">すべて</option>
                            <option value="with">写真あり</option>
                            <option value="without">写真なし</option>
                        </select>
                    </div>
                    <div>
                        <label for="diary-filter-search" class="text-sm font-medium text-gray-600">キーワード</label>
                        <input type="search" id="diary-filter-search" placeholder="例: 楽しかった" class="w-full mt-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    </div>
                </div>

                <!-- 日記リスト -->
                <div id="diary-list" class="space-y-3 pb-24">
                    <!-- JSで動的に表示 -->
                </div>

                <!-- 収支フィルター（記録モード用） -->
                <div id="diary-finance-filter-panel" class="hidden bg-white p-4 rounded-lg shadow-sm space-y-3">
                    <div>
                        <label for="diary-finance-category-filter" class="text-sm font-medium text-gray-600">カテゴリ</label>
                        <select id="diary-finance-category-filter" class="w-full mt-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                            <option value="all">すべて</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label for="diary-finance-min" class="text-sm font-medium text-gray-600">金額 (下限)</label>
                            <input type="number" id="diary-finance-min" class="w-full mt-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" placeholder="例: 1000">
                        </div>
                        <div>
                            <label for="diary-finance-max" class="text-sm font-medium text-gray-600">金額 (上限)</label>
                            <input type="number" id="diary-finance-max" class="w-full mt-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" placeholder="例: 5000">
                        </div>
                    </div>
                </div>

                <!-- 収支タイムライン -->
                <div id="diary-finance-list" class="hidden space-y-3 pb-24">
                    <!-- JSで動的に表示 -->
                </div>
            </div>

            <!-- 1-4. 設定ビュー -->
            <div id="settings-view" class="hidden p-4 space-y-4">
                <h2 class="text-xl font-bold text-gray-800 px-2">設定</h2>

                <!-- アカウント情報 -->
                <div class="bg-white p-4 rounded-lg shadow-sm flex items-center justify-between gap-4">
                    <div class="flex items-center gap-3 text-left">
                        <img id="account-photo" src="" alt="Avatar" class="w-12 h-12 rounded-full object-cover bg-gray-200 hidden">
                        <div>
                            <p id="account-name" class="text-md font-semibold text-gray-800">未ログイン</p>
                            <p id="account-email" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                    <button id="logout-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hidden">ログアウト</button>
                </div>

                <!-- テーマ設定 -->
                <div class="settings-card p-4 space-y-3 collapsed" data-settings-section data-default-open="false">
                    <button type="button" class="settings-section-header" data-settings-toggle>
                        <div>
                            <h3 class="text-md font-semibold text-gray-800">テーマ</h3>
                            <p class="text-sm text-gray-500">ライト / ダークモードを切り替えできます</p>
                        </div>
                        <svg class="chevron w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="settings-section-content space-y-3">
                        <div class="flex items-center gap-2">
                            <button id="theme-light-btn" type="button" class="theme-toggle-btn flex-1 px-3 py-2 rounded-lg border border-gray-200 bg-gray-100 text-gray-700 text-sm font-medium transition hover:bg-white hover:border-gray-300">
                                ライト
                            </button>
                            <button id="theme-dark-btn" type="button" class="theme-toggle-btn flex-1 px-3 py-2 rounded-lg border border-gray-200 bg-gray-100 text-gray-700 text-sm font-medium transition hover:bg-white hover:border-gray-300">
                                ダーク
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 月の予算 -->
                <div class="settings-card p-4 space-y-3" data-settings-section data-default-open="false">
                    <button type="button" class="settings-section-header" data-settings-toggle>
                        <div>
                            <h3 class="text-md font-semibold text-gray-800">月の予算</h3>
                            <p class="text-sm text-gray-500">毎月の支出上限を設定して進捗をチェック</p>
                        </div>
                        <svg class="chevron w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="settings-section-content space-y-3">
                        <div class="space-y-1">
                            <label for="monthly-budget-input" class="text-sm font-medium text-gray-600">月の予算 (円)</label>
                            <input type="number" id="monthly-budget-input" class="w-full mt-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" placeholder="例: 150000">
                            <p class="text-xs text-gray-500" id="monthly-budget-status">予算が未設定です。</p>
                        </div>
                        <div class="flex gap-2">
                            <button id="monthly-budget-save" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">保存</button>
                            <button id="monthly-budget-clear" class="px-4 py-2 rounded-lg text-sm font-medium border border-gray-200 text-gray-700 whitespace-nowrap">リセット</button>
                        </div>
                    </div>
                </div>

                <!-- 支出カテゴリ管理 -->
                <div class="settings-card p-4 space-y-3 collapsed" data-settings-section data-default-open="false">
                    <button type="button" class="settings-section-header" data-settings-toggle>
                        <div>
                            <h3 class="text-md font-semibold text-gray-800">支出カテゴリ</h3>
                            <p class="text-sm text-gray-500">ドラッグまたは矢印で並び替えできます</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500" id="expense-category-count"></span>
                            <svg class="chevron w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </button>
                    <div class="settings-section-content space-y-3">
                        <ul id="expense-category-list" class="space-y-2"></ul>
                        <div class="flex gap-2 items-center">
                            <input type="text" id="expense-category-input" placeholder="カテゴリ名" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                            <button id="add-expense-category" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">追加</button>
                        </div>
                    </div>
                </div>

                <!-- 収入カテゴリ管理 -->
                <div class="settings-card p-4 space-y-3 collapsed" data-settings-section data-default-open="false">
                    <button type="button" class="settings-section-header" data-settings-toggle>
                        <div>
                            <h3 class="text-md font-semibold text-gray-800">収入カテゴリ</h3>
                            <p class="text-sm text-gray-500">整理して入力を素早く</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500" id="income-category-count"></span>
                            <svg class="chevron w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </button>
                    <div class="settings-section-content space-y-3">
                        <ul id="income-category-list" class="space-y-2"></ul>
                        <div class="flex gap-2 items-center">
                            <input type="text" id="income-category-input" placeholder="カテゴリ名" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                            <button id="add-income-category" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">追加</button>
                        </div>
                    </div>
                </div>

                <!-- 定額の自動記録 -->
                <div class="settings-card p-4 space-y-3 collapsed" data-settings-section data-default-open="false">
                    <button type="button" class="settings-section-header" data-settings-toggle>
                        <div>
                            <h3 class="text-md font-semibold text-gray-800">定額の自動記録</h3>
                            <p class="text-sm text-gray-500">毎月の固定費・定期収入を自動で登録します</p>
                        </div>
                        <svg class="chevron w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="settings-section-content space-y-3">
                        <div class="grid grid-cols-1 gap-3 text-sm">
                            <div class="flex gap-2">
                                <label class="w-24 text-gray-600 font-medium">種別</label>
                                <select id="recurring-type-select" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="expense">支出</option>
                                    <option value="income">収入</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <label class="w-24 text-gray-600 font-medium">登録タイミング</label>
                                <select id="recurring-schedule-type" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="date">毎月の日付で登録</option>
                                    <option value="weekday">曜日で登録</option>
                                </select>
                            </div>
                            <div class="flex gap-2" id="recurring-day-row">
                                <label class="w-24 text-gray-600 font-medium">日付</label>
                                <input type="number" id="recurring-day-input" min="1" max="31" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="1〜31">
                            </div>
                            <div class="flex gap-2 items-start hidden" id="recurring-weekdays-row">
                                <label class="w-24 text-gray-600 font-medium">曜日</label>
                                <div class="flex-1 grid grid-cols-4 sm:grid-cols-7 gap-2">
                                    <button type="button" class="recurring-weekday-btn rounded-lg px-3 py-2 text-sm font-semibold" data-recurring-weekday="0" aria-pressed="false">日</button>
                                    <button type="button" class="recurring-weekday-btn rounded-lg px-3 py-2 text-sm font-semibold" data-recurring-weekday="1" aria-pressed="false">月</button>
                                    <button type="button" class="recurring-weekday-btn rounded-lg px-3 py-2 text-sm font-semibold" data-recurring-weekday="2" aria-pressed="false">火</button>
                                    <button type="button" class="recurring-weekday-btn rounded-lg px-3 py-2 text-sm font-semibold" data-recurring-weekday="3" aria-pressed="false">水</button>
                                    <button type="button" class="recurring-weekday-btn rounded-lg px-3 py-2 text-sm font-semibold" data-recurring-weekday="4" aria-pressed="false">木</button>
                                    <button type="button" class="recurring-weekday-btn rounded-lg px-3 py-2 text-sm font-semibold" data-recurring-weekday="5" aria-pressed="false">金</button>
                                    <button type="button" class="recurring-weekday-btn rounded-lg px-3 py-2 text-sm font-semibold" data-recurring-weekday="6" aria-pressed="false">土</button>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <label class="w-24 text-gray-600 font-medium">金額</label>
                                <input type="number" id="recurring-amount-input" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-24 text-gray-600 font-medium">カテゴリ</label>
                                <select id="recurring-category-input" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                            </div>
                            <div class="flex gap-2">
                                <label class="w-24 text-gray-600 font-medium">メモ</label>
                                <input type="text" id="recurring-memo-input" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="（任意）">
                            </div>
                            <div class="flex gap-2 items-center">
                                <label class="w-24 text-gray-600 font-medium">開始日</label>
                                <input type="date" id="recurring-start-input" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="flex gap-2 items-center">
                                <label class="w-24 text-gray-600 font-medium">終了日</label>
                                <div class="flex-1 flex gap-2 items-center">
                                    <input type="date" id="recurring-end-input" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <label class="flex items-center gap-1 text-xs text-gray-600">
                                        <input type="checkbox" id="recurring-no-end" class="rounded border-gray-300">
                                        終了なし
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button id="recurring-save-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">追加</button>
                        </div>
                        <div id="recurring-list" class="space-y-2">
                            <!-- JSで動的に生成 -->
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- 2. 下部ナビゲーション -->
        <nav id="bottom-nav" class="w-full max-w-md mx-auto bg-white border-t border-gray-200 flex justify-around items-center fixed bottom-0">
            <!-- カレンダーボタン -->
            <button id="nav-calendar" class="text-blue-600 p-3 flex flex-col items-center">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span class="text-xs">カレンダー</span>
            </button>

            <!-- 日記ボタン -->
            <button id="nav-diary" class="text-gray-500 p-3 flex flex-col items-center">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                <span class="text-xs">記録</span>
            </button>
            
            <!-- 新規追加ボタン -->
            <button id="add-new-btn" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg -mt-8 flex justify-center items-center">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14"></path></svg>
            </button>
            
            <!-- 集計ボタン -->
            <button id="nav-analysis" class="text-gray-500 p-3 flex flex-col items-center">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                <span class="text-xs">集計</span>
            </button>

            <!-- 設定ボタン -->
            <button id="nav-settings" class="text-gray-500 p-3 flex flex-col items-center">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                <span class="text-xs">設定</span>
            </button>
        </nav>

        <!-- 認証スクリーン -->
        <div id="auth-loading-screen" class="auth-overlay hidden text-center space-y-4" role="status" aria-live="polite">
            <div class="auth-loading-spinner" aria-hidden="true"></div>
            <p id="auth-loading-message" class="text-sm text-gray-500">アカウントを確認しています...</p>
        </div>
        <div id="auth-screen" class="auth-overlay px-6 text-center space-y-4 hidden" role="dialog" aria-modal="true" aria-live="assertive">
            <div class="space-y-2">
                <h1 class="text-2xl font-bold text-gray-800">Money Diary</h1>
                <p id="auth-message" class="text-sm text-gray-500">Googleアカウントでログインして、あなた専用の家計簿をはじめましょう。</p>
            </div>
            <button id="google-login-btn" class="bg-blue-600 text-white px-6 py-3 rounded-full text-sm font-semibold shadow-lg hover:bg-blue-500 transition-colors">Googleでログイン</button>
            <p id="auth-config-warning" class="text-xs text-red-400 hidden">Firebase構成を設定するとログインできます。</p>
        </div>

        <!-- カテゴリ編集モーダル -->
        <div id="category-edit-modal" class="hidden fixed inset-0 flex items-center justify-center px-4 simple-modal-overlay" aria-hidden="true" role="dialog" aria-modal="true">
            <div class="simple-modal-card w-full max-w-sm p-5 space-y-4">
                <div class="space-y-1">
                    <h3 id="category-edit-title" class="text-lg font-semibold">カテゴリ名を編集</h3>
                    <p id="category-edit-helper" class="text-sm" style="color: var(--color-text-muted);">支出または収入のカテゴリ名を変更します。</p>
                </div>
                <div class="space-y-2">
                    <label for="category-edit-input" class="text-xs font-semibold" style="color: var(--color-text-muted);">カテゴリ名</label>
                    <input id="category-edit-input" type="text" class="w-full py-2 px-3 rounded-lg" placeholder="新しいカテゴリ名">
                    <p id="category-edit-error" class="text-xs text-red-500 hidden"></p>
                </div>
                <div class="flex justify-end gap-2">
                    <button id="category-edit-cancel" type="button" class="category-action-btn">キャンセル</button>
                    <button id="category-edit-save" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">保存</button>
                </div>
            </div>
        </div>

    </div>

    <!-- 3. 入力モーダル -->
    <div id="input-modal" class="hidden fixed inset-0 max-w-md mx-auto h-screen bg-white flex flex-col z-50">
        <!-- モーダルヘッダー -->
        <header class="flex justify-between items-center p-4 border-b border-gray-200">
            <button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-100">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 id="modal-date-header" class="text-lg font-bold text-gray-800"></h2>
            <button id="save-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">保存</button>
        </header>

        <!-- モーダルコンテンツ -->
        <div id="input-modal-content" class="flex-grow p-4 overflow-y-auto space-y-4">
            <!-- 収支・日記タブ -->
            <div class="flex rounded-lg bg-gray-100 p-1">
                <button id="tab-expense" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white shadow text-blue-600">収支</button>
                <button id="tab-diary" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-600">日記</button>
            </div>

            <!-- 収支入力フォーム -->
            <div id="expense-form" class="space-y-4">
                <!-- 収入/支出 トグル -->
                <div class="flex items-center justify-center">
                    <input type="checkbox" id="type-toggle" class="sr-only" />
                    <div id="type-toggle-control" class="grid grid-cols-2 gap-1 bg-red-100 rounded-full p-1 w-48">
                        <button type="button" id="toggle-expense" class="py-2 rounded-full text-sm font-semibold text-red-600 bg-white shadow">支出</button>
                        <button type="button" id="toggle-income" class="py-2 rounded-full text-sm font-semibold text-gray-500">収入</button>
                    </div>
                </div>

                <!-- レシートスキャン -->
                <div class="flex justify-end">
                    <input type="file" id="receipt-upload" class="hidden" accept="image/*">
                    <button type="button" id="scan-receipt-btn" class="flex items-center gap-1 text-sm text-blue-600 hover:text-blue-800 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        画像を読取る
                    </button>
                    <div id="scan-loading" class="hidden flex items-center gap-2 text-sm text-gray-500">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent"></div>
                        解析中...
                    </div>
                </div>

                <!-- 金額 -->
                <div>
                    <label for="amount" class="text-sm font-medium text-gray-700">金額</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">¥</span>
                        <input type="number" id="amount" placeholder="0" class="w-full pl-8 pr-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-2xl font-bold">
                    </div>
                </div>

                <!-- カテゴリー -->
                <div>
                    <label for="category" class="text-sm font-medium text-gray-700">カテゴリー</label>
                    <select id="category" class="w-full mt-1 py-3 px-4 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option>食費</option>
                        <option>交通費</option>
                        <option>日用品</option>
                        <option>趣味</option>
                        <option>交際費</option>
                        <option>固定費</option>
                        <option>その他</option>
                        <option class="text-green-600" value="income-salary">給与</option>
                        <option class="text-green-600" value="income-other">その他収入</option>
                    </select>
                </div>

                <!-- メモ -->
                <div>
                    <label for="memo" class="text-sm font-medium text-gray-700">メモ</label>
                    <input type="text" id="memo" placeholder="（任意）例: 〇〇スーパー" class="w-full mt-1 py-3 px-4 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- 収支追加ボタン -->
                <div>
                    <button id="add-transaction-btn" class="w-full bg-blue-100 text-blue-700 py-3 rounded-lg font-medium hover:bg-blue-200 transition-colors">
                        この収支を追加
                    </button>
                </div>

                <!-- その日の収支一覧 -->
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">この日の収支</h4>
                    <ul id="daily-transactions" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- JSで動的に生成 -->
                    </ul>
                </div>
            </div>

            <!-- 日記入力フォーム -->
            <div id="diary-form" class="hidden space-y-4">
                <!-- 感情 -->
                <div>
                    <label class="text-sm font-medium text-gray-700">今日の気分</label>
                    <div id="mood-selector" class="flex justify-around mt-2">
                        <!-- JSで動的に生成 -->
                    </div>
                </div>
                
                <!-- 日記本文 -->
                <div>
                    <label for="diary-text" class="text-sm font-medium text-gray-700">日記</label>
                    <textarea id="diary-text" rows="5" placeholder="今日の出来事や感想..." class="w-full mt-1 p-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>

                <!-- 写真アップロード -->
                <div>
                    <label class="text-sm font-medium text-gray-700">写真 (1枚まで)</label>
                    <div class="mt-1">
                        <input type="file" id="photo-upload" class="hidden" accept="image/*">
                        <label for="photo-upload" class="cursor-pointer w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex justify-center items-center text-gray-500 hover:bg-gray-50">
                            <span id="photo-preview-text">
                                <svg class="w-10 h-10 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01M3 10a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V10z"></path></svg>
                                写真を選択
                            </span>
                            <img id="photo-preview" src="" class="hidden w-full h-full object-cover rounded-lg">
                        </label>
                        <button id="photo-remove-btn" class="hidden text-sm text-red-500 mt-1">写真を削除</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 写真プレビューモーダル -->
    <div id="photo-preview-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 photo-modal-overlay">
        <div class="photo-modal-content relative rounded-lg overflow-hidden max-w-md w-full">
            <button id="photo-preview-close" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <img id="photo-preview-image" src="" alt="日記写真" class="w-full max-h-[80vh] object-contain bg-black">
        </div>
    </div>

    <!-- 年月ジャンプモーダル -->
    <div id="date-picker-modal" class="hidden fixed inset-0 flex items-center justify-center px-4">
        <div id="date-picker-overlay" class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="relative z-10 w-full max-w-md">
            <div class="date-picker-card">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <p class="text-xs uppercase tracking-wide text-gray-500">ジャンプ</p>
                        <h3 class="text-lg font-semibold text-gray-800">年月を選択</h3>
                    </div>
                    <button id="date-picker-close" class="date-picker-secondary rounded-full p-2" aria-label="閉じる">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="space-y-5">
                    <div>
                        <label for="date-picker-year" class="text-sm font-medium text-gray-700">年</label>
                        <div class="flex items-center gap-3 mt-2">
                            <button type="button" id="date-picker-year-minus" class="date-picker-year-btn" aria-label="前年へ">−</button>
                            <input type="number" id="date-picker-year" class="date-picker-input flex-1" min="1900" max="3000" />
                            <button type="button" id="date-picker-year-plus" class="date-picker-year-btn" aria-label="次の年へ">＋</button>
                        </div>
                    </div>

                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2">月</p>
                        <div class="date-picker-months grid grid-cols-3 gap-2">
                            <button type="button" data-month-option="0">1月</button>
                            <button type="button" data-month-option="1">2月</button>
                            <button type="button" data-month-option="2">3月</button>
                            <button type="button" data-month-option="3">4月</button>
                            <button type="button" data-month-option="4">5月</button>
                            <button type="button" data-month-option="5">6月</button>
                            <button type="button" data-month-option="6">7月</button>
                            <button type="button" data-month-option="7">8月</button>
                            <button type="button" data-month-option="8">9月</button>
                            <button type="button" data-month-option="9">10月</button>
                            <button type="button" data-month-option="10">11月</button>
                            <button type="button" data-month-option="11">12月</button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="date-picker-cancel" class="px-4 py-2 rounded-lg date-picker-secondary">キャンセル</button>
                    <button type="button" id="date-picker-confirm" class="px-4 py-2 rounded-lg date-picker-primary">移動</button>
                </div>
            </div>
        </div>
    </div>

    <!-- スキャン結果確認モーダル -->
    <div id="scan-result-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center px-4 bg-black bg-opacity-60">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <div>
                    <h3 class="font-bold text-lg text-gray-800">スキャン結果</h3>
                    <p class="text-xs text-gray-500">内容を確認して登録してください</p>
                </div>
                <button id="scan-result-close" class="p-2 rounded-full hover:bg-gray-200 text-gray-500">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-4 bg-gray-50">
                <div id="scan-result-list" class="space-y-3">
                    <!-- JSで動的に生成 -->
                </div>
                <button id="scan-result-add-row" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 text-sm font-medium hover:bg-gray-100 transition-colors">
                    + 行を追加
                </button>
            </div>

            <div class="p-4 border-t border-gray-200 bg-white flex justify-end gap-3">
                <button id="scan-result-cancel" class="px-5 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50">キャンセル</button>
                <button id="scan-result-save" class="px-5 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 shadow-md">
                    選択した項目を追加
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 状態管理 ---

            // 定数
            const FIREBASE_CONFIG = {
                apiKey: "AIzaSyAL4m9Ixjq9hETKad_esPvWqUkdIWxt1nY",
                authDomain: "moneydiary-web.firebaseapp.com",
                projectId: "moneydiary-web",
                storageBucket: "moneydiary-web.firebasestorage.app",
                messagingSenderId: "79130877798",
                appId: "1:79130877798:web:68504c48d434bc815bf2a7"
            };
            const FIREBASE_PLACEHOLDERS = [
                'YOUR_FIREBASE_API_KEY',
                'YOUR_API_KEY',
                'YOUR_FIREBASE_AUTH_DOMAIN',
                'YOUR_AUTH_DOMAIN',
                'YOUR_FIREBASE_PROJECT_ID',
                'YOUR_PROJECT_ID',
                'YOUR_FIREBASE_STORAGE_BUCKET',
                'YOUR_STORAGE_BUCKET',
                'YOUR_FIREBASE_MESSAGING_SENDER_ID',
                'YOUR_MESSAGING_SENDER_ID',
                'YOUR_FIREBASE_APP_ID',
                'YOUR_APP_ID'
            ];
            const isFirebaseConfigured = Object.values(FIREBASE_CONFIG).every((value) => {
                return typeof value === 'string'
                    && value.trim() !== ''
                    && !FIREBASE_PLACEHOLDERS.some((placeholder) => value.includes(placeholder));
            });
            const GEMINI_API_BASE = 'https://generativelanguage.googleapis.com';
            const GEMINI_API_VERSION = 'v1beta';
            const GEMINI_API_KEY = 'AIzaSyAKCCB53WYGXb2pAHIY0j6WrKljyETJEhY';
            const GEMINI_PREFERRED_MODELS = [
                'models/gemini-1.5-flash-latest',
                'models/gemini-1.5-flash-002',
                'models/gemini-1.5-flash',
                'models/gemini-1.5-flash-8b-latest',
                'models/gemini-1.5-pro-latest',
                'models/gemini-1.5-pro',
                'models/gemini-1.0-pro',
                'models/gemini-1.0-pro-001',
                'models/gemini-pro'
            ];
            let geminiModelOrderCache = null;
            const isGeminiConfigured = GEMINI_API_KEY && !GEMINI_API_KEY.includes('YOUR_GEMINI_API_KEY');
            const MOODS = ['😄', '😊', '😐', '😞', '😡']; // 5段階に変更
            const WEEKDAY_LABELS = ['日', '月', '火', '水', '木', '金', '土'];
            const DEFAULT_CATEGORIES = {
                expense: ['食費', '交通費', '日用品', '趣味', '交際費', '固定費', 'その他'],
                income: ['給与', 'その他収入']
            };
            const SETTINGS_KEY = 'moneyDiarySettings';
            const AUTH_SUCCESS_FLAG_KEY = 'moneyDiaryAuthSuccess';
            const DIARY_MODES = { diary: 'diary', finance: 'finance' };

            let currentView = 'calendar'; // 'calendar' | 'analysis' | 'diary' | 'settings'
            let currentAnalysisView = 'month'; // 'week', 'month', 'year'
            let currentDate = new Date(); // 表示用の現在月・週・年
            let selectedDateStr = formatDate(new Date()); // 選択された日付 (YYYY-MM-DD)
            let records = {}; // データストア
            let tempPhotoData = null; // 一時的な写真データ(Base64)
            let selectedMood = null; // 選択中の感情
            let diaryFilters = { mood: 'all', photo: 'all', search: '' };
            let financeFilters = { category: 'all', min: '', max: '' };
            let appSettings = {
                theme: 'light',
                categories: {
                    expense: [...DEFAULT_CATEGORIES.expense],
                    income: [...DEFAULT_CATEGORIES.income]
                },
                recurringEntries: [], // { id, type, amount, category, memo, schedule, day?, weekdays? }
                recurringSkipInstances: [], // ['recurringId:YYYY-MM-DD']
                monthlyBudget: null
            };
            let categoryEditTarget = { type: null, oldName: null };
            let isDiaryFilterOpen = false;
            let currentDiaryMode = DIARY_MODES.diary;
            let editingTransactionId = null;
            let editingRecurringId = null;
            let firebaseApp = null;
            let auth = null;
            let db = null;
            let currentUser = null;
            const STORAGE_BASE_KEY = 'moneyDiaryRecords';
            const USER_AGENT = typeof navigator !== 'undefined' ? navigator.userAgent || '' : '';
            const IS_MOBILE_DEVICE = /Android|iPhone|iPad|iPod/i.test(USER_AGENT);
            const IS_IOS = /iPad|iPhone|iPod/i.test(USER_AGENT);
            let pendingDatePickerMonth = null;

            // グラフインスタンス
            let expenseChartInstance = null;
            let balanceChartInstance = null;

            // --- DOM要素 ---
            const calendarView = document.getElementById('calendar-view');
            const analysisView = document.getElementById('analysis-view');
            const diaryView = document.getElementById('diary-view');
            const settingsView = document.getElementById('settings-view');
            const navCalendar = document.getElementById('nav-calendar');
            const navAnalysis = document.getElementById('nav-analysis');
            const navDiary = document.getElementById('nav-diary');
            const navSettings = document.getElementById('nav-settings');
            const addNewBtn = document.getElementById('add-new-btn');
            const inputModal = document.getElementById('input-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const saveBtn = document.getElementById('save-btn');
            const modalDateHeader = document.getElementById('modal-date-header');
            const tabExpense = document.getElementById('tab-expense');
            const tabDiary = document.getElementById('tab-diary');
            const expenseForm = document.getElementById('expense-form');
            const diaryForm = document.getElementById('diary-form');
            const typeToggle = document.getElementById('type-toggle');
            const typeToggleControl = document.getElementById('type-toggle-control');
            const toggleExpenseBtn = document.getElementById('toggle-expense');
            const toggleIncomeBtn = document.getElementById('toggle-income');
            const amountInput = document.getElementById('amount');
            const categorySelect = document.getElementById('category');
            const memoInput = document.getElementById('memo');
            const receiptUpload = document.getElementById('receipt-upload');
            const scanReceiptBtn = document.getElementById('scan-receipt-btn');
            const scanLoading = document.getElementById('scan-loading');
            // 入力方法選択モーダル
            const entryMethodModal = document.getElementById('entry-method-modal');
            const entryMethodOverlay = document.getElementById('entry-method-overlay');
            const methodManualBtn = document.getElementById('method-manual-btn');
            const methodScanBtn = document.getElementById('method-scan-btn');
            const methodCancelBtn = document.getElementById('method-cancel-btn');

            let isScanningFromCalendar = false;
            const addTransactionBtn = document.getElementById('add-transaction-btn'); // 追加
            const dailyTransactionsList = document.getElementById('daily-transactions');
            const moodSelector = document.getElementById('mood-selector');
            const diaryTextInput = document.getElementById('diary-text');
            const photoUpload = document.getElementById('photo-upload');
            const photoPreview = document.getElementById('photo-preview');
            const photoPreviewText = document.getElementById('photo-preview-text');
            const photoRemoveBtn = document.getElementById('photo-remove-btn');
            const diaryList = document.getElementById('diary-list');
            const diaryFinanceList = document.getElementById('diary-finance-list');
            const diaryFinanceFilterPanel = document.getElementById('diary-finance-filter-panel');
            const diaryFinanceCategoryFilter = document.getElementById('diary-finance-category-filter');
            const diaryFinanceMinInput = document.getElementById('diary-finance-min');
            const diaryFinanceMaxInput = document.getElementById('diary-finance-max');
            const diaryFilterMood = document.getElementById('diary-filter-mood');
            const diaryFilterPhoto = document.getElementById('diary-filter-photo');
            const diaryFilterSearch = document.getElementById('diary-filter-search');
            const toggleDiaryFiltersBtn = document.getElementById('toggle-diary-filters');
            const diaryFilterPanel = document.getElementById('diary-filter-panel');
            const diaryModeDiaryBtn = document.getElementById('diary-mode-diary');
            const diaryModeFinanceBtn = document.getElementById('diary-mode-finance');
            const authScreen = document.getElementById('auth-screen');
            const authLoadingScreen = document.getElementById('auth-loading-screen');
            const authLoadingMessage = document.getElementById('auth-loading-message');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const authMessage = document.getElementById('auth-message');
            const authConfigWarning = document.getElementById('auth-config-warning');
            const monthYearHeader = document.getElementById('month-year-header');
            const monthYearHeaderText = document.getElementById('month-year-header-text');
            const datePickerModal = document.getElementById('date-picker-modal');
            const datePickerOverlay = document.getElementById('date-picker-overlay');
            const datePickerCloseBtn = document.getElementById('date-picker-close');
            const datePickerCancelBtn = document.getElementById('date-picker-cancel');
            const datePickerConfirmBtn = document.getElementById('date-picker-confirm');
            const datePickerYearInput = document.getElementById('date-picker-year');
            const datePickerYearMinus = document.getElementById('date-picker-year-minus');
            const datePickerYearPlus = document.getElementById('date-picker-year-plus');
            const datePickerMonthButtons = Array.from(document.querySelectorAll('[data-month-option]'));
            const accountNameEl = document.getElementById('account-name');
            const accountEmailEl = document.getElementById('account-email');
            const accountPhotoEl = document.getElementById('account-photo');
            const logoutBtn = document.getElementById('logout-btn');
            const analysisIncomeEl = document.getElementById('analysis-income');
            const analysisExpenseEl = document.getElementById('analysis-expense');
            const analysisBalanceEl = document.getElementById('analysis-balance');
            const themeLightBtn = document.getElementById('theme-light-btn');
            const themeDarkBtn = document.getElementById('theme-dark-btn');
            const categoryEditModal = document.getElementById('category-edit-modal');
            const categoryEditTitle = document.getElementById('category-edit-title');
            const categoryEditHelper = document.getElementById('category-edit-helper');
            const categoryEditInput = document.getElementById('category-edit-input');
            const categoryEditError = document.getElementById('category-edit-error');
            const categoryEditCancel = document.getElementById('category-edit-cancel');
            const categoryEditSave = document.getElementById('category-edit-save');
            
            // スキャン結果モーダル
            const scanResultModal = document.getElementById('scan-result-modal');
            const scanResultList = document.getElementById('scan-result-list');
            const scanResultClose = document.getElementById('scan-result-close');
            const scanResultCancel = document.getElementById('scan-result-cancel');
            const scanResultSave = document.getElementById('scan-result-save');
            const scanResultAddRow = document.getElementById('scan-result-add-row');

            const expenseCategoryList = document.getElementById('expense-category-list');
            const incomeCategoryList = document.getElementById('income-category-list');
            const expenseCategoryInput = document.getElementById('expense-category-input');
            const incomeCategoryInput = document.getElementById('income-category-input');
            const addExpenseCategoryBtn = document.getElementById('add-expense-category');
            const addIncomeCategoryBtn = document.getElementById('add-income-category');
            const expenseCategoryCount = document.getElementById('expense-category-count');
            const incomeCategoryCount = document.getElementById('income-category-count');
            const recurringTypeSelect = document.getElementById('recurring-type-select');
            const recurringScheduleType = document.getElementById('recurring-schedule-type');
            const recurringDayInput = document.getElementById('recurring-day-input');
            const recurringDayRow = document.getElementById('recurring-day-row');
            const recurringWeekdaysRow = document.getElementById('recurring-weekdays-row');
            const recurringWeekdayButtons = Array.from(document.querySelectorAll('[data-recurring-weekday]'));
            const recurringAmountInput = document.getElementById('recurring-amount-input');
            const recurringCategoryInput = document.getElementById('recurring-category-input');
            const recurringMemoInput = document.getElementById('recurring-memo-input');
            const recurringStartInput = document.getElementById('recurring-start-input');
            const recurringEndInput = document.getElementById('recurring-end-input');
            const recurringNoEndInput = document.getElementById('recurring-no-end');
            const recurringSaveBtn = document.getElementById('recurring-save-btn');
            const recurringListContainer = document.getElementById('recurring-list');
            const photoPreviewModal = document.getElementById('photo-preview-modal');
            const photoPreviewModalImg = document.getElementById('photo-preview-image');
            const photoPreviewModalClose = document.getElementById('photo-preview-close');
            const analysisAiButton = document.getElementById('analysis-ai-button');
            const analysisAiOutput = document.getElementById('analysis-ai-output');
            const summaryBudgetLabel = document.getElementById('summary-budget-label');
            const summaryBudgetRemaining = document.getElementById('summary-budget-remaining');
            const summaryBudgetBar = document.getElementById('summary-budget-bar');
            const analysisBudgetNote = document.getElementById('analysis-budget-note');
            const monthlyBudgetInput = document.getElementById('monthly-budget-input');
            const monthlyBudgetSaveBtn = document.getElementById('monthly-budget-save');
            const monthlyBudgetClearBtn = document.getElementById('monthly-budget-clear');
            const monthlyBudgetStatus = document.getElementById('monthly-budget-status');
            const settingsSections = Array.from(document.querySelectorAll('[data-settings-section]'));

            // --- 初期化 ---
            function initialize() {
                loadSettings();
                renderCalendar();
                renderAnalysis(); // 初期描画
                renderMoodSelector();
                initializeDiaryFilters();
                updateDiaryFilterPanelVisibility();
                renderDiaryList();
                setDiaryMode(currentDiaryMode);
                renderSettingsView();
                setupSettingsAccordions();
                resetRecurringForm();
                updateTypeToggleUI();
                setupEventListeners();
                updateNavUI();
                const returningUser = hasSuccessfulAuthHistory();
                showLoadingScreen(returningUser ? '前回のセッションを復元しています...' : 'アプリを準備しています...');
                updateAuthAvailabilityUI();
                initializeFirebase();
            }

            // --- データ操作 ---
            function getUserStorageKey() {
                return currentUser ? `${STORAGE_BASE_KEY}_${currentUser.uid}` : `${STORAGE_BASE_KEY}_guest`;
            }

            function getSettingsStorageKey(userOverride = null) {
                const targetUser = userOverride || currentUser;
                return targetUser && targetUser.uid ? `${SETTINGS_KEY}_${targetUser.uid}` : `${SETTINGS_KEY}_guest`;
            }

            function hasSuccessfulAuthHistory() {
                try {
                    return localStorage.getItem(AUTH_SUCCESS_FLAG_KEY) === 'true';
                } catch (error) {
                    return false;
                }
            }

            function setAuthSuccessFlag(isAuthenticated) {
                try {
                    if (isAuthenticated) {
                        localStorage.setItem(AUTH_SUCCESS_FLAG_KEY, 'true');
                    } else {
                        localStorage.removeItem(AUTH_SUCCESS_FLAG_KEY);
                    }
                } catch (error) {
                    console.warn('認証状態の保存に失敗しました', error);
                }
            }

            function cacheRecordsLocally() {
                if (!currentUser) return;
                try {
                    localStorage.setItem(getUserStorageKey(), JSON.stringify(records));
                } catch (error) {
                    console.warn('ローカルキャッシュの保存に失敗しました', error);
                }
            }

            async function loadRecords() {
                if (!currentUser) {
                    records = {};
                    return;
                }

                try {
                    const cached = localStorage.getItem(getUserStorageKey());
                    records = cached ? JSON.parse(cached) || {} : {};
                } catch (error) {
                    records = {};
                }

                if (!db) return;
                try {
                    const doc = await db.collection('users').doc(currentUser.uid).get();
                    if (doc.exists && doc.data().records) {
                        records = doc.data().records;
                        cacheRecordsLocally();
                    }
                } catch (error) {
                    console.error('Firestoreからの読み込みに失敗しました', error);
                }
            }

            async function saveRecords() {
                if (!currentUser) return;
                cacheRecordsLocally();
                if (!db) return;
                try {
                    await db.collection('users').doc(currentUser.uid).set({
                        records,
                        profile: {
                            displayName: currentUser.displayName || '',
                            email: currentUser.email || '',
                            photoURL: currentUser.photoURL || ''
                        },
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } catch (error) {
                    console.error('Firestoreへの保存に失敗しました', error);
                }
            }

            function updateAuthAvailabilityUI() {
                if (!googleLoginBtn) return;
                if (isFirebaseConfigured) {
                    googleLoginBtn.disabled = false;
                    if (authConfigWarning) {
                        authConfigWarning.classList.add('hidden');
                    }
                } else {
                    googleLoginBtn.disabled = true;
                    if (authConfigWarning) {
                        authConfigWarning.classList.remove('hidden');
                    }
                    showAuthScreen('Firebaseの設定が完了していません。設定後にログインできます。');
                }
            }

            function lockAuthScreenScroll() {
                document.body?.classList.add('auth-locked');
            }

            function unlockAuthScreenScroll() {
                const authVisible = (authScreen && !authScreen.classList.contains('hidden')) || (authLoadingScreen && !authLoadingScreen.classList.contains('hidden'));
                if (!authVisible) {
                    document.body?.classList.remove('auth-locked');
                }
            }

            function showLoadingScreen(message = 'アカウントを確認しています...') {
                if (!authLoadingScreen) return;
                if (message && authLoadingMessage) {
                    authLoadingMessage.textContent = message;
                }
                authLoadingScreen.classList.remove('hidden');
                lockAuthScreenScroll();
            }

            function hideLoadingScreen() {
                if (!authLoadingScreen) return;
                authLoadingScreen.classList.add('hidden');
                unlockAuthScreenScroll();
            }

            function lockDatePickerScroll() {
                document.body?.classList.add('date-picker-locked');
            }

            function unlockDatePickerScroll() {
                document.body?.classList.remove('date-picker-locked');
            }

            function showAuthScreen(message = 'Googleアカウントでログインして、あなた専用の家計簿をはじめましょう。') {
                if (authLoadingScreen) {
                    authLoadingScreen.classList.add('hidden');
                }
                if (!authScreen) return;
                if (message && authMessage) {
                    authMessage.textContent = message;
                }
                authScreen.classList.remove('hidden');
                authScreen.removeAttribute('aria-hidden');
                lockAuthScreenScroll();
            }

            function hideAuthScreen() {
                if (!authScreen) return;
                authScreen.classList.add('hidden');
                authScreen.setAttribute('aria-hidden', 'true');
                unlockAuthScreenScroll();
            }

            function openDatePicker() {
                if (!datePickerModal) return;
                pendingDatePickerMonth = currentDate.getMonth();
                if (datePickerYearInput) {
                    datePickerYearInput.value = currentDate.getFullYear();
                }
                updateDatePickerMonthUI();
                datePickerModal.classList.remove('hidden');
                lockDatePickerScroll();
            }

            function closeDatePicker() {
                if (!datePickerModal) return;
                datePickerModal.classList.add('hidden');
                unlockDatePickerScroll();
            }

            function updateDatePickerMonthUI() {
                datePickerMonthButtons.forEach((btn) => {
                    const month = Number(btn.dataset.monthOption);
                    btn.classList.toggle('active', month === pendingDatePickerMonth);
                });
            }

            function setDatePickerMonth(month) {
                pendingDatePickerMonth = month;
                updateDatePickerMonthUI();
            }

            function adjustDatePickerYear(delta) {
                if (!datePickerYearInput) return;
                const baseYear = parseInt(datePickerYearInput.value, 10) || new Date().getFullYear();
                datePickerYearInput.value = baseYear + delta;
            }

            function confirmDatePickerSelection() {
                if (!datePickerYearInput) return;
                const year = parseInt(datePickerYearInput.value, 10);
                if (!Number.isFinite(year) || year < 1900 || year > 3000) {
                    alert('有効な年を入力してください。');
                    return;
                }
                const month = typeof pendingDatePickerMonth === 'number' ? pendingDatePickerMonth : currentDate.getMonth();
                currentDate = new Date(year, month, 1);
                renderCalendar();
                renderAnalysis();
                updateNavUI();
                closeDatePicker();
            }

            function handleGlobalKeydown(event) {
                if (event.key === 'Escape') {
                    if (categoryEditModal && !categoryEditModal.classList.contains('hidden')) {
                        closeCategoryEditModal();
                        return;
                    }
                    if (datePickerModal && !datePickerModal.classList.contains('hidden')) {
                        closeDatePicker();
                    }
                }
            }

            function initializeFirebase() {
                if (!window.firebase) {
                    showAuthScreen('Firebase SDKが読み込めませんでした。ページを再読み込みしてください。');
                    updateAuthAvailabilityUI();
                    return;
                }
                if (!isFirebaseConfigured) {
                    updateAuthAvailabilityUI();
                    return;
                }
                try {
                    firebaseApp = firebase.apps && firebase.apps.length > 0 ? firebase.app() : firebase.initializeApp(FIREBASE_CONFIG);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            setAuthSuccessFlag(true);
                            showLoadingScreen('データを読み込んでいます...');
                            currentUser = user;
                            loadSettings(currentUser);
                            await hydrateSettingsFromCloud(currentUser);
                            await loadRecords();
                            renderCalendar();
                            renderAnalysis();
                            renderDiaryList();
                            renderSettingsView();
                            updateAccountInfoUI();
                            updateNavUI();
                            hideAuthScreen();
                            hideLoadingScreen();
                        } else {
                            setAuthSuccessFlag(false);
                            currentUser = null;
                            loadSettings();
                            records = {};
                            renderCalendar();
                            renderAnalysis();
                            renderDiaryList();
                            renderSettingsView();
                            hideLoadingScreen();
                            showAuthScreen();
                            updateNavUI();
                        }
                    });
                    handleRedirectResult();
                } catch (error) {
                    console.error('Firebase初期化に失敗しました', error);
                    showAuthScreen('Firebaseの初期化に失敗しました。設定を確認してください。');
                    if (googleLoginBtn) {
                        googleLoginBtn.disabled = true;
                    }
                    if (authConfigWarning) {
                        authConfigWarning.classList.remove('hidden');
                    }
                }
            }

            async function handleRedirectResult() {
                if (!auth || typeof auth.getRedirectResult !== 'function') return;
                try {
                    const result = await auth.getRedirectResult();
                    if (result && result.user) {
                        // onAuthStateChanged handles the heavy lifting, but ensure UI unlocks immediately
                        hideAuthScreen();
                        hideLoadingScreen();
                    }
                } catch (error) {
                    const ignorableCodes = new Set([
                        'auth/user-cancelled',
                        'auth/operation-not-supported-in-this-environment'
                    ]);
                    if (error && ignorableCodes.has(error.code)) {
                        return;
                    }
                    console.error('Googleリダイレクトログインに失敗しました', error);
                    showAuthScreen('Googleログインに失敗しました。もう一度お試しください。');
                }
            }

            async function handleGoogleLogin() {
                if (!auth) {
                    showAuthScreen('Firebaseの準備中です。少し待ってから再試行してください。');
                    return;
                }
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                try {
                    const popupUnsupportedErrors = new Set([
                        'auth/operation-not-supported-in-this-environment',
                        'auth/popup-blocked'
                    ]);

                    let popupWorked = true;
                    try {
                        // Always try popup first so that mobile browsers keep the SPA alive.
                        await auth.signInWithPopup(provider);
                    } catch (popupError) {
                        popupWorked = false;
                        if (!popupError || !popupUnsupportedErrors.has(popupError.code)) {
                            throw popupError;
                        }
                    }

                    if (popupWorked) {
                        return;
                    }

                    showAuthScreen('Googleログインページに移動しています...');
                    await auth.signInWithRedirect(provider);
                } catch (error) {
                    console.error('Googleログインに失敗しました', error);
                    alert('Googleログインに失敗しました。通信状況をご確認の上、再度お試しください。');
                }
            }

            async function handleLogout() {
                if (!auth) return;
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('ログアウトに失敗しました', error);
                    alert('ログアウトできませんでした。ネットワークをご確認ください。');
                }
            }

            function getDayRecord(dateStr) {
                // YYYY-MM-DD
                if (!records[dateStr]) {
                    records[dateStr] = {
                        transactions: [], // { id, type, amount, category, memo }
                        diary: { text: '', mood: null, photo: null }
                    };
                }
                return records[dateStr];
            }

            function getDefaultSettings() {
                return {
                    theme: 'light',
                    categories: {
                    expense: [...DEFAULT_CATEGORIES.expense],
                    income: [...DEFAULT_CATEGORIES.income]
                },
                    recurringEntries: [],
                    recurringSkipInstances: [],
                    monthlyBudget: null
            };
            }

            function getRecurringScheduleType(entry) {
                return entry && entry.schedule === 'weekday' ? 'weekday' : 'date';
            }

            function getRecurringWeekdays(entry) {
                if (!entry) return [];
                const raw = Array.isArray(entry.weekdays) ? entry.weekdays : [];
                return raw
                    .map((w) => parseInt(w, 10))
                    .filter((w) => Number.isInteger(w) && w >= 0 && w <= 6);
            }

            function normalizeRecurringEntry(entry) {
                if (!entry || typeof entry !== 'object') return null;
                const schedule = getRecurringScheduleType(entry);
                const normalized = {
                    ...entry,
                    schedule,
                    weekdays: schedule === 'weekday' ? getRecurringWeekdays(entry) : [],
                    day: schedule === 'date' ? (Number.parseInt(entry.day, 10) || 1) : null
                };
                return normalized;
            }

            function normalizeRecurringEntries(entries) {
                if (!Array.isArray(entries)) return [];
                return entries
                    .map(normalizeRecurringEntry)
                    .filter(Boolean);
            }

            function getRecurringSortValue(entry) {
                const schedule = getRecurringScheduleType(entry);
                if (schedule === 'weekday') {
                    const weekdays = getRecurringWeekdays(entry);
                    const first = weekdays.length ? Math.min(...weekdays) : 7;
                    return { priority: 1, value: first };
                }
                const day = Number.isFinite(entry?.day) ? entry.day : 32;
                return { priority: 0, value: day };
            }

            function compareRecurringEntries(a, b) {
                const aKey = getRecurringSortValue(a);
                const bKey = getRecurringSortValue(b);
                if (aKey.priority !== bKey.priority) {
                    return aKey.priority - bKey.priority;
                }
                if (aKey.value !== bKey.value) {
                    return aKey.value - bKey.value;
                }
                return (a?.category || '').localeCompare(b?.category || '');
            }

            function formatRecurringScheduleText(entry) {
                const schedule = getRecurringScheduleType(entry);
                if (schedule === 'weekday') {
                    const weekdays = getRecurringWeekdays(entry);
                    const weekdayLabel = weekdays.length
                        ? weekdays.map((w) => WEEKDAY_LABELS[w]).join('・')
                        : '曜日未設定';
                    return `毎週${weekdayLabel}`;
                }
                const dayText = Number.isFinite(entry?.day) ? `${entry.day}日` : '日付未設定';
                return dayText;
            }

            function mergeSettings(base, source) {
                const merged = {
                    ...base,
                    categories: { ...base.categories },
                    recurringEntries: normalizeRecurringEntries(base.recurringEntries),
                    recurringSkipInstances: Array.isArray(base.recurringSkipInstances) ? [...base.recurringSkipInstances] : [],
                    monthlyBudget: base.monthlyBudget ?? null
                };
                if (!source) return merged;
                merged.theme = source.theme === 'dark' ? 'dark' : merged.theme;
                merged.categories.expense = Array.isArray(source.categories?.expense) && source.categories.expense.length > 0
                    ? [...source.categories.expense]
                    : merged.categories.expense;
                merged.categories.income = Array.isArray(source.categories?.income) && source.categories.income.length > 0
                    ? [...source.categories.income]
                    : merged.categories.income;
                merged.recurringEntries = Array.isArray(source.recurringEntries)
                    ? normalizeRecurringEntries(source.recurringEntries)
                    : merged.recurringEntries;
                merged.recurringSkipInstances = Array.isArray(source.recurringSkipInstances)
                    ? [...source.recurringSkipInstances]
                    : merged.recurringSkipInstances;
                merged.monthlyBudget = Number.isFinite(source.monthlyBudget) && source.monthlyBudget > 0
                    ? Number(source.monthlyBudget)
                    : merged.monthlyBudget;
                merged.recurringEntries = normalizeRecurringEntries(merged.recurringEntries);
                return merged;
            }

            function getMonthlyBudget() {
                const value = Number(appSettings.monthlyBudget);
                if (Number.isFinite(value) && value > 0) {
                    return Math.round(value);
                }
                return null;
            }

            function formatCurrency(value) {
                const num = Number.isFinite(value) ? value : 0;
                return `¥${num.toLocaleString()}`;
            }

            function loadSettings(userOverride = null) {
                const defaults = getDefaultSettings();
                const storageKey = getSettingsStorageKey(userOverride);
                let loaded = mergeSettings(defaults, null);
                try {
                    let raw = localStorage.getItem(storageKey);
                    if (!raw && storageKey !== SETTINGS_KEY) {
                        raw = localStorage.getItem(SETTINGS_KEY); // 旧キーからの移行用
                    }
                    if (raw) {
                        const saved = JSON.parse(raw);
                        loaded = mergeSettings(loaded, saved);
                    }
                } catch (error) {
                    console.warn('設定の読み込みに失敗しました', error);
                }
                appSettings = loaded;
                applyTheme(appSettings.theme);
            }

            async function hydrateSettingsFromCloud(user) {
                if (!user || !db) return;
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    const cloudSettings = doc.exists ? doc.data().settings : null;
                    if (cloudSettings) {
                        const defaults = getDefaultSettings();
                        const merged = mergeSettings(mergeSettings(defaults, appSettings), cloudSettings);
                        appSettings = merged;
                        saveSettings({ syncCloud: false, userOverride: user });
                        applyTheme(appSettings.theme);
                    }
                } catch (error) {
                    console.error('設定の取得に失敗しました', error);
                }
            }

            function saveSettings(options = {}) {
                const { syncCloud = true, userOverride = null } = options;
                const storageKey = getSettingsStorageKey(userOverride);
                try {
                    localStorage.setItem(storageKey, JSON.stringify(appSettings));
                } catch (error) {
                    console.warn('設定の保存に失敗しました', error);
                }
                if (syncCloud && currentUser && db) {
                    db.collection('users').doc(currentUser.uid).set({
                        settings: appSettings
                    }, { merge: true }).catch((error) => {
                        console.error('設定の保存に失敗しました', error);
                    });
                }
            }

            function applyTheme(theme) {
                if (!document.body) return;
                document.body.classList.toggle('dark-mode', theme === 'dark');
                document.documentElement.setAttribute('data-theme', theme);
                document.documentElement.style.colorScheme = theme === 'dark' ? 'dark' : 'light';
                if (window.Chart && Chart.defaults) {
                    const textColor = theme === 'dark' ? '#e2e8f0' : '#0f172a';
                    const gridColor = theme === 'dark' ? '#334155' : '#e5e7eb';
                    Chart.defaults.color = textColor;
                    Chart.defaults.borderColor = gridColor;
                    if (Chart.defaults.scale && Chart.defaults.scale.grid) {
                        Chart.defaults.scale.grid.color = gridColor;
                    }
                    if (Chart.defaults.plugins && Chart.defaults.plugins.legend && Chart.defaults.plugins.legend.labels) {
                        Chart.defaults.plugins.legend.labels.color = textColor;
                    }
                }
            }

            function updateThemeControls() {
                if (!themeLightBtn || !themeDarkBtn) return;
                const isDark = appSettings.theme === 'dark';
                const activeClasses = ['bg-blue-600', 'text-white', 'shadow', 'border-blue-600'];
                const inactiveClasses = ['bg-gray-100', 'text-gray-700', 'border-gray-200'];

                [themeLightBtn, themeDarkBtn].forEach((btn) => {
                    btn.classList.remove(...activeClasses, ...inactiveClasses);
                    btn.classList.add('theme-toggle-btn', 'flex-1', 'px-3', 'py-2', 'rounded-lg', 'border', 'text-sm', 'font-medium', 'transition');
                });

                if (isDark) {
                    themeDarkBtn.classList.add(...activeClasses);
                    themeLightBtn.classList.add(...inactiveClasses);
                } else {
                    themeLightBtn.classList.add(...activeClasses);
                    themeDarkBtn.classList.add(...inactiveClasses);
                }
            }

            function setThemePreference(theme) {
                const nextTheme = theme === 'dark' ? 'dark' : 'light';
                if (appSettings.theme === nextTheme) {
                    updateThemeControls();
                    return;
                }
                appSettings.theme = nextTheme;
                applyTheme(nextTheme);
                updateThemeControls();
                saveSettings();
                if (currentView === 'analysis') {
                    renderAnalysis();
                }
            }

            function getCategoryOptions(type) {
                return appSettings.categories[type] ? [...appSettings.categories[type]] : [];
            }

            // --- 描画 ---

            // カレンダー描画
            function renderCalendar() {
                const calendarGridBody = document.getElementById('calendar-grid-body');
                applyRecurringEntriesForMonth(currentDate);
                
                calendarGridBody.innerHTML = '';
                const headerText = `${currentDate.getFullYear()}年 ${currentDate.getMonth() + 1}月`;
                if (monthYearHeaderText) {
                    monthYearHeaderText.textContent = headerText;
                } else if (monthYearHeader) {
                    monthYearHeader.textContent = headerText;
                }

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // 前月の日付
                const prevDaysInMonth = new Date(year, month, 0).getDate();
                for (let i = firstDay - 1; i >= 0; i--) {
                    const day = prevDaysInMonth - i;
                    calendarGridBody.appendChild(createDayElement(day, true));
                }

                // 今月の日付
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = formatDate(new Date(year, month, day));
                    const record = records[dateStr];
                    calendarGridBody.appendChild(createDayElement(day, false, record, dateStr));
                }

                // 来月の日付
                const totalCells = firstDay + daysInMonth;
                const nextDays = (7 - (totalCells % 7)) % 7;
                for (let day = 1; day <= nextDays; day++) {
                    calendarGridBody.appendChild(createDayElement(day, true));
                }
                
                renderMonthSummary();
            }
            
            // カレンダーの日付セル作成
            function createDayElement(day, isOtherMonth, record, dateStr) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day p-1 text-sm cursor-pointer relative flex flex-col items-center justify-start rounded-lg';
                
                if (isOtherMonth) {
                    dayEl.classList.add('other-month');
                    dayEl.innerHTML = `<span>${day}</span>`;
                } else {
                    dayEl.dataset.date = dateStr;
                    
                    // 日付
                    const dateNum = document.createElement('span');
                    dateNum.textContent = day;
                    dateNum.className = 'font-medium';
                    
                    // 今日の日付をマーク
                    const todayStr = formatDate(new Date());
                    if (dateStr === todayStr) {
                        dateNum.className = 'bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold';
                    }
                    dayEl.appendChild(dateNum);

                    // 記録アイコン
                    if (record) {
                        const iconsWrapper = document.createElement('div');
                        iconsWrapper.className = 'flex flex-wrap justify-center items-center gap-1 mt-1';
                        
                        // 感情
                        if (record.diary && record.diary.mood) {
                            const moodIcon = document.createElement('span');
                            moodIcon.textContent = record.diary.mood;
                            moodIcon.className = 'text-xs';
                            iconsWrapper.appendChild(moodIcon);
                        }

                        // 写真
                        if (record.diary && record.diary.photo) {
                            const photoIcon = document.createElement('span');
                            photoIcon.innerHTML = '📷';
                            photoIcon.className = 'text-xs';
                            iconsWrapper.appendChild(photoIcon);
                        }

                        // 収支 (支出/収入)
                        const totalExpense = record.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                        const totalIncome = record.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);

                        if (totalExpense > 0) {
                            const expenseDot = document.createElement('span');
                            expenseDot.className = 'w-1.5 h-1.5 bg-red-500 rounded-full';
                            iconsWrapper.appendChild(expenseDot);
                        }
                        if (totalIncome > 0) {
                            const incomeDot = document.createElement('span');
                            incomeDot.className = 'w-1.5 h-1.5 bg-blue-500 rounded-full';
                            iconsWrapper.appendChild(incomeDot);
                        }

                        dayEl.appendChild(iconsWrapper);
                    }
                    
                    // クリックイベント
                    dayEl.addEventListener('click', () => {
                        selectedDateStr = dateStr;
                        showInputModal();
                    });
                }
                return dayEl;
            }

            function getMonthTotals(year, month) {
                let totalIncome = 0;
                let totalExpense = 0;

                for (const dateStr in records) {
                    const date = new Date(dateStr);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                totalIncome += t.amount;
                            } else {
                                totalExpense += t.amount;
                            }
                        });
                    }
                }

                return { income: totalIncome, expense: totalExpense };
            }

            function getBudgetStatus(expenseTotal = 0) {
                const budget = getMonthlyBudget();
                if (!budget) return null;
                const spent = Number(expenseTotal) || 0;
                const remaining = budget - spent;
                const usedPercent = budget > 0 ? Math.round((spent / budget) * 100) : 0;
                return { amount: budget, remaining, usedPercent, spent, isOver: remaining < 0 };
            }

            function updateBudgetSummary(totals) {
                if (!summaryBudgetLabel || !summaryBudgetRemaining || !summaryBudgetBar) return;
                const status = getBudgetStatus(totals?.expense || 0);
                if (!status) {
                    summaryBudgetLabel.textContent = '未設定';
                    summaryBudgetRemaining.textContent = '設定すると今月の進捗が見られます。';
                    summaryBudgetBar.style.width = '0%';
                    summaryBudgetBar.classList.remove('bg-blue-600', 'bg-red-500');
                    summaryBudgetBar.classList.add('bg-gray-200');
                    return;
                }

                summaryBudgetLabel.textContent = formatCurrency(status.amount);
                const usage = Math.max(0, Math.min(status.usedPercent, 999));
                summaryBudgetBar.style.width = `${Math.min(usage, 100)}%`;
                summaryBudgetBar.classList.remove('bg-gray-200');
                summaryBudgetBar.classList.remove('bg-blue-600', 'bg-red-500');
                summaryBudgetBar.classList.add(status.isOver ? 'bg-red-500' : 'bg-blue-600');

                if (status.isOver) {
                    summaryBudgetRemaining.textContent = `${formatCurrency(Math.abs(status.remaining))}オーバー (${usage}% 使用)`;
                } else {
                    summaryBudgetRemaining.textContent = `残り ${formatCurrency(status.remaining)} (${usage}% 使用)`;
                }
            }

            // 月次サマリー描画
            function renderMonthSummary() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const totals = getMonthTotals(year, month);

                document.getElementById('summary-income').textContent = `¥${totals.income.toLocaleString()}`;
                document.getElementById('summary-expense').textContent = `¥${totals.expense.toLocaleString()}`;
                document.getElementById('summary-balance').textContent = `¥${(totals.income - totals.expense).toLocaleString()}`;
                updateBudgetSummary(totals);
            }
            
            // 集計画面描画 (ディスパッチャ)
            function renderAnalysis() {
                applyRecurringEntriesForMonth(currentDate);
                updateAnalysisTabUI();

                // 期間ヘッダーの更新
                const header = document.getElementById('month-year-analysis-header');
                let summary = { income: 0, expense: 0 };
                if (currentAnalysisView === 'week') {
                    const week = getWeekRange(currentDate);
                    header.textContent = `${formatDate(week.start, 'short')} ~ ${formatDate(week.end, 'short')}`;
                    document.getElementById('balance-chart-title').textContent = '今週の日別収支';
                    summary = renderWeekAnalysis(week) || summary;
                } else if (currentAnalysisView === 'year') {
                    header.textContent = `${currentDate.getFullYear()}年`;
                    document.getElementById('balance-chart-title').textContent = '今年の月別収支';
                    summary = renderYearAnalysis() || summary;
                } else { // month
                    header.textContent = `${currentDate.getFullYear()}年 ${currentDate.getMonth() + 1}月`;
                    document.getElementById('balance-chart-title').textContent = '今月の日別収支';
                    summary = renderMonthAnalysis() || summary;
                }

                updateAnalysisSummary(summary);
                updateAnalysisBudgetNote(summary);
            }

            function updateAnalysisSummary(summary = { income: 0, expense: 0 }) {
                if (!analysisIncomeEl || !analysisExpenseEl || !analysisBalanceEl) return;
                const income = summary.income || 0;
                const expense = summary.expense || 0;
                const balance = income - expense;

                analysisIncomeEl.textContent = `¥${income.toLocaleString()}`;
                analysisExpenseEl.textContent = `¥${expense.toLocaleString()}`;
                analysisBalanceEl.textContent = `¥${balance.toLocaleString()}`;

                analysisBalanceEl.classList.remove('text-green-600', 'text-red-600', 'text-gray-800');
                if (balance > 0) {
                    analysisBalanceEl.classList.add('text-green-600');
                } else if (balance < 0) {
                    analysisBalanceEl.classList.add('text-red-600');
                } else {
                    analysisBalanceEl.classList.add('text-gray-800');
                }
            }

            function updateAnalysisBudgetNote(summary = { expense: 0 }) {
                if (!analysisBudgetNote) return;
                if (currentAnalysisView !== 'month') {
                    analysisBudgetNote.classList.add('hidden');
                    analysisBudgetNote.textContent = '';
                    return;
                }

                analysisBudgetNote.classList.remove('hidden');
                const status = getBudgetStatus(summary.expense || 0);
                if (!status) {
                    analysisBudgetNote.textContent = '月の予算は未設定です。設定タブで設定すると進捗が表示されます。';
                    return;
                }

                const usage = Math.max(0, Math.min(status.usedPercent, 999));
                const statusText = status.isOver
                    ? `${formatCurrency(Math.abs(status.remaining))}オーバー`
                    : `残り ${formatCurrency(status.remaining)}`;
                analysisBudgetNote.textContent = `予算 ${formatCurrency(status.amount)} / 使った ${formatCurrency(summary.expense || 0)}（${usage}%）・${statusText}`;
            }

            function getCurrentAnalysisRange() {
                const base = new Date(currentDate);
                if (currentAnalysisView === 'week') {
                    const range = getWeekRange(base);
                    return { start: range.start, end: range.end, label: `${formatDate(range.start, 'short')}〜${formatDate(range.end, 'short')}` };
                }
                if (currentAnalysisView === 'year') {
                    const start = new Date(base.getFullYear(), 0, 1);
                    const end = new Date(base.getFullYear(), 11, 31);
                    return { start, end, label: `${base.getFullYear()}年` };
                }
                // month
                const start = new Date(base.getFullYear(), base.getMonth(), 1);
                const end = new Date(base.getFullYear(), base.getMonth() + 1, 0);
                return { start, end, label: `${base.getFullYear()}年${base.getMonth() + 1}月` };
            }

            function getAnalysisSnapshot() {
                const range = getCurrentAnalysisRange();
                if (!range) return null;
                const transactions = [];
                const diaries = [];
                const perDayTotals = {};
                for (const [dateStr, record] of Object.entries(records)) {
                    const date = new Date(dateStr);
                    if (Number.isNaN(date.getTime())) continue;
                    if (date < range.start || date > range.end) continue;
                    record.transactions.forEach(t => {
                        transactions.push({ ...t, date: dateStr });
                    });
                    if (record.diary && (record.diary.text || record.diary.mood)) {
                        diaries.push({ date: dateStr, mood: record.diary.mood, text: record.diary.text });
                    }
                }
                const daySet = new Set(transactions.map(t => t.date));
                let totalIncome = 0;
                let totalExpense = 0;
                const categoryTotals = {};
                const recurringCount = { income: 0, expense: 0 };
                transactions.forEach(t => {
                    if (!perDayTotals[t.date]) {
                        perDayTotals[t.date] = { income: 0, expense: 0 };
                    }
                    if (t.type === 'income') {
                        totalIncome += t.amount;
                        perDayTotals[t.date].income += t.amount;
                    } else {
                        totalExpense += t.amount;
                        categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                        perDayTotals[t.date].expense += t.amount;
                    }
                    if (t.recurringId) {
                        recurringCount[t.type] = (recurringCount[t.type] || 0) + 1;
                    }
                });
                const topCategories = Object.entries(categoryTotals)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, amount]) => ({ name, amount }));
                const sortedExpenses = [...transactions].filter(t => t.type === 'expense').sort((a, b) => b.amount - a.amount);
                const notableBigExpense = sortedExpenses[0];
                const moodCounts = diaries.reduce((acc, d) => {
                    if (d.mood) {
                        acc[d.mood] = (acc[d.mood] || 0) + 1;
                    }
                    return acc;
                }, {});
                const averageExpense = daySet.size > 0 ? Math.round(totalExpense / daySet.size) : 0;
                const averageIncome = daySet.size > 0 ? Math.round(totalIncome / daySet.size) : 0;
                const calmDays = Object.entries(perDayTotals).filter(([, totals]) => totals.expense === 0 && totals.income === 0).length;
                let budget = null;
                if (currentAnalysisView === 'month') {
                    const status = getBudgetStatus(totalExpense);
                    if (status) {
                        budget = {
                            amount: status.amount,
                            remaining: status.remaining,
                            usedPercent: status.usedPercent,
                            spent: status.spent
                        };
                    }
                }

                return {
                    label: range.label,
                    view: currentAnalysisView,
                    transactionCount: transactions.length,
                    dayCount: daySet.size,
                    totalIncome,
                    totalExpense,
                    net: totalIncome - totalExpense,
                    topCategories,
                    recurringCount,
                    averageExpense,
                    averageIncome,
                    quietDays: calmDays,
                    biggestExpense: notableBigExpense ? {
                        amount: notableBigExpense.amount,
                        category: notableBigExpense.category,
                        date: notableBigExpense.date,
                        memo: notableBigExpense.memo
                    } : null,
                    moods: moodCounts,
                    diaries,
                    budget
                };
            }

            function buildGeminiPrompt(snapshot) {
                const categoryLine = snapshot.topCategories.map(cat => `${cat.name}:${cat.amount}円`).join(', ') || 'データなし';
                const moodLine = Object.entries(snapshot.moods || {}).map(([mood, count]) => `${mood}×${count}`).join(' / ') || '気分記録なし';
                const diaryLine = (snapshot.diaries || [])
                    .filter(d => d.text)
                    .slice(0, 3)
                    .map(d => `${d.date}: ${d.text.substring(0, 80)}`)
                    .join('\n');
                const biggestExpenseLine = snapshot.biggestExpense
                    ? `${snapshot.biggestExpense.date}「${snapshot.biggestExpense.category}」で${snapshot.biggestExpense.amount}円 ${snapshot.biggestExpense.memo || ''}`
                    : '特筆すべき大きな支出はありません';
                const budgetLine = snapshot.budget
                    ? `- 月の予算: ${snapshot.budget.amount}円 / 支出: ${snapshot.budget.spent}円 / 残り: ${snapshot.budget.remaining}円`
                    : '- 月の予算: 設定なし';

                return `あなたは日本語で答えるお金と生活のコーチです。以下は日記と家計簿のスナップショットです。節約や使い方の改善策に加え、続けたい良い習慣も入れてください。

### 期間
- ラベル: ${snapshot.label}
- 日数: ${snapshot.dayCount}日 / 取引数: ${snapshot.transactionCount}件 / 何も記録がない日: ${snapshot.quietDays}日

### 数値サマリー
- 収入合計: ${snapshot.totalIncome}円 (平均: ${snapshot.averageIncome}円/日)
- 支出合計: ${snapshot.totalExpense}円 (平均: ${snapshot.averageExpense}円/日)
- 収支: ${snapshot.net}円
- 定額記録: 収入${snapshot.recurringCount.income || 0}件 / 支出${snapshot.recurringCount.expense || 0}件
- 最も大きな支出: ${biggestExpenseLine}
${budgetLine}

### 傾向
- 主な支出カテゴリ: ${categoryLine}
- 気分の分布: ${moodLine}
- 日記メモ抜粋:
${diaryLine || '記録なし'}

このデータを読んで、次の形式で短く答えてください:
1) 褒めるべき点
2) 改善できる点（理由付き）
3) すぐできるアクション（具体的な金額や頻度を提案）
4) 気分と支出の関係で気づいたこと`;
            }

            async function getGeminiModelInvocationOrder() {
                if (geminiModelOrderCache) {
                    return geminiModelOrderCache;
                }

                const fallbackOrder = GEMINI_PREFERRED_MODELS.map(name => `${GEMINI_API_VERSION}/${name}:generateContent`);
                if (!isGeminiConfigured) {
                    geminiModelOrderCache = fallbackOrder;
                    return geminiModelOrderCache;
                }

                try {
                    const response = await fetch(`${GEMINI_API_BASE}/${GEMINI_API_VERSION}/models?key=${GEMINI_API_KEY}`);
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.error?.message || `Gemini model list error (${response.status})`);
                    }
                    const models = Array.isArray(data?.models) ? data.models : [];
                    const supported = models
                        .filter(model => Array.isArray(model?.supportedGenerationMethods) && model.supportedGenerationMethods.includes('generateContent'))
                        .map(model => model.name);

                    if (supported.length === 0) {
                        throw new Error('Gemini APIに利用可能なモデルがありません。');
                    }

                    const ordered = [];
                    GEMINI_PREFERRED_MODELS.forEach(name => {
                        if (supported.includes(name)) {
                            ordered.push(name);
                        }
                    });
                    supported.forEach(name => {
                        if (!ordered.includes(name)) {
                            ordered.push(name);
                        }
                    });

                    geminiModelOrderCache = ordered.map(name => `${GEMINI_API_VERSION}/${name}:generateContent`);
                    return geminiModelOrderCache;
                } catch (error) {
                    console.warn('Geminiモデルリストの取得に失敗しました', error);
                    geminiModelOrderCache = fallbackOrder;
                    return geminiModelOrderCache;
                }
            }

            async function fetchGeminiAdvice(prompt) {
                const modelPaths = await getGeminiModelInvocationOrder();
                let lastError = 'アドバイスを取得できませんでした。';

                for (const path of modelPaths) {
                    try {
                        const response = await fetch(`${GEMINI_API_BASE}/${path}?key=${GEMINI_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ role: 'user', parts: [{ text: prompt }] }]
                            })
                        });
                        const data = await response.json().catch(() => ({}));
                        if (!response.ok) {
                            const message = data?.error?.message || `Gemini API error (${response.status})`;
                            const shouldTryNext =
                                response.status === 404 || /not found/i.test(message) || /not supported/i.test(message);
                            if (shouldTryNext) {
                                lastError = message;
                                continue;
                            }
                            throw new Error(message);
                        }
                        const text = data?.candidates?.[0]?.content?.parts?.map(part => part?.text).filter(Boolean).join('\n');
                        if (text) {
                            return text;
                        }
                        lastError = 'アドバイスを取得できませんでした。';
                    } catch (error) {
                        lastError = error?.message || 'Gemini APIとの通信に失敗しました。';
                    }
                }

                throw new Error(lastError);
            }

            async function analyzeReceiptWithGemini(imageBase64, mimeType) {
                const modelPaths = await getGeminiModelInvocationOrder();
                let lastError = 'レシートを解析できませんでした。';

                // アプリ内のカテゴリ一覧を取得してプロンプトに埋め込む
                const categoryListStr = appSettings.categories.expense.join(', ');

                const prompt = `
                Analyze this image (receipt or purchase history). Extract ALL individual transaction items.
                For each item, extract:
                1. "amount": The amount (number only).
                2. "date": The date in "YYYY-MM-DD" format. If missing, use null.
                3. "description": Item name or store name (short summary).
                4. "category": Choose the best fit from this list: [${categoryListStr}]. If unsure, use "その他" (or the last item in the list).
                
                Return a JSON ARRAY of objects. Do not wrap in markdown.
                Example: [{"amount": 1200, "date": "2023-10-25", "description": "Lunch", "category": "食費"}]
                `;

                for (const path of modelPaths) {
                    try {
                        const response = await fetch(`${GEMINI_API_BASE}/${path}?key=${GEMINI_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: prompt },
                                        {
                                            inline_data: {
                                                mime_type: mimeType,
                                                data: imageBase64
                                            }
                                        }
                                    ]
                                }]
                            })
                        });

                        const data = await response.json().catch(() => ({}));
                        if (!response.ok) {
                            const message = data?.error?.message || `Gemini API error (${response.status})`;
                            const shouldTryNext =
                                response.status === 404 || /not found/i.test(message) || /not supported/i.test(message);
                            if (shouldTryNext) {
                                lastError = message;
                                continue;
                            }
                            throw new Error(message);
                        }

                        const textPart = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!textPart) {
                            lastError = 'Gemini APIからの応答がありませんでした。';
                            continue;
                        }

                        // JSONパース
                        const jsonString = textPart.replace(/```json/g, '').replace(/```/g, '').trim();
                        try {
                            const result = JSON.parse(jsonString);
                            // 配列か単一オブジェクトかを正規化して配列にする
                            return Array.isArray(result) ? result : [result];
                        } catch (e) {
                            lastError = 'Geminiの応答を解析できませんでした。';
                            continue;
                        }

                    } catch (error) {
                        lastError = error?.message || 'Gemini APIとの通信に失敗しました。';
                    }
                }

                throw new Error(lastError);
            }

            function escapeHtml(text) {
                return text.replace(/[&<>"']/g, (char) => {
                    switch (char) {
                        case '&':
                            return '&amp;';
                        case '<':
                            return '&lt;';
                        case '>':
                            return '&gt;';
                        case '"':
                            return '&quot;';
                        case '\'':
                            return '&#39;';
                        default:
                            return char;
                    }
                });
            }

            function applyBasicFormatting(text) {
                return text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            }

            function renderAiAdvice(text) {
                if (!analysisAiOutput) return;
                if (!text) {
                    analysisAiOutput.textContent = 'アドバイスを取得できませんでした。';
                    return;
                }
                const lines = text.split('\n');
                const htmlParts = [];
                let inList = false;

                const closeList = () => {
                    if (inList) {
                        htmlParts.push('</ul>');
                        inList = false;
                    }
                };

                lines.forEach((line) => {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('### ')) {
                        closeList();
                        const content = applyBasicFormatting(escapeHtml(trimmed.replace(/^###\s+/, '')));
                        htmlParts.push(`<div class="font-semibold text-gray-800">${content}</div>`);
                        return;
                    }
                    if (/^[-*]\s+/.test(trimmed)) {
                        if (!inList) {
                            htmlParts.push('<ul class="list-disc list-inside space-y-1">');
                            inList = true;
                        }
                        const content = applyBasicFormatting(escapeHtml(trimmed.replace(/^[-*]\s+/, '')));
                        htmlParts.push(`<li>${content}</li>`);
                        return;
                    }
                    if (trimmed === '') {
                        closeList();
                        htmlParts.push('<br>');
                        return;
                    }

                    closeList();
                    const content = applyBasicFormatting(escapeHtml(trimmed));
                    htmlParts.push(`<p class="mb-1">${content}</p>`);
                });
                closeList();
                analysisAiOutput.innerHTML = htmlParts.join('\n');
            }

            async function handleAnalysisAdviceRequest() {
                if (!analysisAiOutput) return;
                if (!isGeminiConfigured) {
                    analysisAiOutput.textContent = 'Gemini APIキーが設定されていません。`GEMINI_API_KEY` を設定してください。';
                    return;
                }
                const snapshot = getAnalysisSnapshot();
                if (!snapshot || snapshot.transactionCount === 0) {
                    analysisAiOutput.textContent = 'この期間には分析できるデータがありません。';
                    return;
                }
                analysisAiOutput.textContent = 'Geminiが分析しています…';
                try {
                    const prompt = buildGeminiPrompt(snapshot);
                    const text = await fetchGeminiAdvice(prompt);
                    renderAiAdvice(text);
                } catch (error) {
                    console.error('Gemini分析の取得に失敗しました', error);
                    analysisAiOutput.textContent = error?.message
                        ? `アドバイスの取得に失敗しました: ${error.message}`
                        : 'アドバイスの取得に失敗しました。ネットワークやAPIキーをご確認ください。';
                }
            }

            // 月次集計
            function renderMonthAnalysis() {
                // document.getElementById('month-year-analysis-header').textContent = `${currentDate.getFullYear()}年 ${currentDate.getMonth() + 1}月`;
                
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                // データ集計
                const expenseData = {};
                const dailyData = {}; // 日別の収支
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let day = 1; day <= daysInMonth; day++) {
                    dailyData[day] = { income: 0, expense: 0 };
                }

                for (const dateStr in records) {
                    const date = new Date(dateStr);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        const day = date.getDate();
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                dailyData[day].income += t.amount;
                            } else {
                                dailyData[day].expense += t.amount;
                                expenseData[t.category] = (expenseData[t.category] || 0) + t.amount;
                            }
                        });
                    }
                }

                // 1. 支出円グラフ
                const expenseCtx = document.getElementById('expense-chart').getContext('2d');
                const labels = Object.keys(expenseData);
                const data = Object.values(expenseData);
                
                if (expenseChartInstance) {
                    expenseChartInstance.destroy();
                }

                if (labels.length > 0) {
                    expenseChartInstance = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '支出',
                                data: data,
                                backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#8b5cf6', '#64748b'],
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                },
                            }
                        }
                    });
                } else {
                     expenseCtx.clearRect(0, 0, expenseCtx.canvas.width, expenseCtx.canvas.height);
                     expenseCtx.fillText("この月の支出データはありません", expenseCtx.canvas.width/2, expenseCtx.canvas.height/2);
                     expenseCtx.textAlign = 'center';
                }

                // 2. 日別収支棒グラフ
                const balanceCtx = document.getElementById('balance-chart').getContext('2d');
                const dayLabels = Object.keys(dailyData).map(day => `${day}日`);
                const incomeValues = Object.values(dailyData).map(d => d.income);
                const expenseValues = Object.values(dailyData).map(d => d.expense);
                const totalIncome = incomeValues.reduce((sum, value) => sum + value, 0);
                const totalExpense = expenseValues.reduce((sum, value) => sum + value, 0);

                if (balanceChartInstance) {
                    balanceChartInstance.destroy();
                }

                balanceChartInstance = new Chart(balanceCtx, {
                    type: 'bar',
                    data: {
                        labels: dayLabels,
                        datasets: [
                            {
                                label: '収入',
                                data: incomeValues,
                                backgroundColor: '#3b82f6', // blue-500
                            },
                            {
                                label: '支出',
                                data: expenseValues,
                                backgroundColor: '#ef4444', // red-500
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });

                return { income: totalIncome, expense: totalExpense };
            }

            // 週次集計
            function renderWeekAnalysis(week) {
                const expenseData = {};
                const dailyData = {};
                const labels = [];

                // 週の各日を初期化
                for (let d = new Date(week.start); d <= week.end; d.setDate(d.getDate() + 1)) {
                    const dateStr = formatDate(d);
                    labels.push(`${d.getMonth() + 1}/${d.getDate()}日`);
                    dailyData[dateStr] = { income: 0, expense: 0 };
                }

                // データを集計
                for (const dateStr in dailyData) {
                    if (records[dateStr]) {
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                dailyData[dateStr].income += t.amount;
                            } else {
                                dailyData[dateStr].expense += t.amount;
                                expenseData[t.category] = (expenseData[t.category] || 0) + t.amount;
                            }
                        });
                    }
                }

                // 1. 支出円グラフ
                const expenseCtx = document.getElementById('expense-chart').getContext('2d');
                const expenseLabels = Object.keys(expenseData);
                const doughnutData = Object.values(expenseData); // 変数名を 'expenseValues' から 'doughnutData' に変更
                
                if (expenseChartInstance) expenseChartInstance.destroy();
                if (expenseLabels.length > 0) {
                    expenseChartInstance = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: {
                            labels: expenseLabels,
                            datasets: [{ data: doughnutData, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#8b5cf6', '#64748b'] }] // 'doughnutData' を使用
                        },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });
                } else {
                     expenseCtx.clearRect(0, 0, expenseCtx.canvas.width, expenseCtx.canvas.height);
                     expenseCtx.fillText("この週の支出データはありません", expenseCtx.canvas.width/2, expenseCtx.canvas.height/2);
                     expenseCtx.textAlign = 'center';
                }

                // 2. 日別収支棒グラフ
                const balanceCtx = document.getElementById('balance-chart').getContext('2d');
                const incomeValues = Object.values(dailyData).map(d => d.income);
                const expenseValues = Object.values(dailyData).map(d => d.expense);
                const totalIncome = incomeValues.reduce((sum, value) => sum + value, 0);
                const totalExpense = expenseValues.reduce((sum, value) => sum + value, 0);

                if (balanceChartInstance) balanceChartInstance.destroy();
                balanceChartInstance = new Chart(balanceCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: '収入', data: incomeValues, backgroundColor: '#3b82f6' },
                            { label: '支出', data: expenseValues, backgroundColor: '#ef4444' }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: { x: { stacked: true }, y: { stacked: true } },
                        plugins: { legend: { position: 'bottom' } }
                    }
                });

                return { income: totalIncome, expense: totalExpense };
            }

            // 年次集計
            function renderYearAnalysis() {
                const year = currentDate.getFullYear();
                const expenseData = {};
                const monthlyData = {};
                const labels = [];

                for (let m = 0; m < 12; m++) {
                    labels.push(`${m + 1}月`);
                    monthlyData[m] = { income: 0, expense: 0 };
                }

                for (const dateStr in records) {
                    const date = new Date(dateStr);
                    if (date.getFullYear() === year) {
                        const month = date.getMonth();
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                monthlyData[month].income += t.amount;
                            } else {
                                monthlyData[month].expense += t.amount;
                                expenseData[t.category] = (expenseData[t.category] || 0) + t.amount;
                            }
                        });
                    }
                }

                // 1. 支出円グラフ
                const expenseCtx = document.getElementById('expense-chart').getContext('2d');
                const expenseLabels = Object.keys(expenseData);
                const yearDoughnutData = Object.values(expenseData); // 変数名を 'expenseValues' から 'yearDoughnutData' に変更
                
                if (expenseChartInstance) expenseChartInstance.destroy();
                if (expenseLabels.length > 0) {
                    expenseChartInstance = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: {
                            labels: expenseLabels,
                            datasets: [{ data: yearDoughnutData, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#8b5cf6', '#64748b'] }] // 'yearDoughnutData' を使用
                        },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });
                } else {
                     expenseCtx.clearRect(0, 0, expenseCtx.canvas.width, expenseCtx.canvas.height);
                     expenseCtx.fillText("この年の支出データはありません", expenseCtx.canvas.width/2, expenseCtx.canvas.height/2);
                     expenseCtx.textAlign = 'center';
                }

                // 2. 月別収支棒グラフ
                const balanceCtx = document.getElementById('balance-chart').getContext('2d');
                const incomeValues = Object.values(monthlyData).map(d => d.income);
                const expenseValues = Object.values(monthlyData).map(d => d.expense);
                const totalIncome = incomeValues.reduce((sum, value) => sum + value, 0);
                const totalExpense = expenseValues.reduce((sum, value) => sum + value, 0);

                if (balanceChartInstance) balanceChartInstance.destroy();
                balanceChartInstance = new Chart(balanceCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: '収入', data: incomeValues, backgroundColor: '#3b82f6' },
                            { label: '支出', data: expenseValues, backgroundColor: '#ef4444' }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: { x: { stacked: true }, y: { stacked: true } },
                        plugins: { legend: { position: 'bottom' } }
                    }
                });

                return { income: totalIncome, expense: totalExpense };
            }

            // 日記フィルター初期化
            function initializeDiaryFilters() {
                if (diaryFilterMood) {
                    // 既存オプションは「すべて」のみ想定
                    MOODS.forEach(mood => {
                        const option = document.createElement('option');
                        option.value = mood;
                        option.textContent = mood;
                        diaryFilterMood.appendChild(option);
                    });
                    diaryFilterMood.value = diaryFilters.mood;
                }
                if (diaryFilterPhoto) {
                    diaryFilterPhoto.value = diaryFilters.photo;
                }
                if (diaryFilterSearch) {
                    diaryFilterSearch.value = diaryFilters.search;
                }
            }

            // 日記リスト描画
            function renderDiaryList() {
                if (!diaryList) return;
                if (!currentUser) {
                    diaryList.innerHTML = '<div class="text-center text-sm text-gray-500 bg-white p-4 rounded-lg shadow-sm">ログインすると日記一覧を閲覧できます。</div>';
                    return;
                }

                const entries = Object.entries(records)
                    .map(([dateStr, record]) => ({
                        dateStr,
                        diary: record.diary || {}
                    }))
                    .filter(({ diary }) => {
                        const hasText = diary.text && diary.text.trim().length > 0;
                        return hasText || diary.mood || diary.photo;
                    })
                    .sort((a, b) => new Date(b.dateStr) - new Date(a.dateStr));

                const filteredEntries = entries.filter(({ diary }) => {
                    if (diaryFilters.mood !== 'all' && diary.mood !== diaryFilters.mood) {
                        return false;
                    }
                    if (diaryFilters.photo === 'with' && !diary.photo) {
                        return false;
                    }
                    if (diaryFilters.photo === 'without' && diary.photo) {
                        return false;
                    }
                    if (diaryFilters.search) {
                        const text = (diary.text || '').toLowerCase();
                        if (!text.includes(diaryFilters.search)) {
                            return false;
                        }
                    }
                    return true;
                });

                diaryList.innerHTML = '';

                if (filteredEntries.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'text-center text-sm text-gray-500 bg-white p-4 rounded-lg shadow-sm';
                    empty.textContent = '条件に合う日記がありません';
                    diaryList.appendChild(empty);
                    return;
                }

                filteredEntries.forEach(({ dateStr, diary }) => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-sm space-y-3 diary-card cursor-pointer transition-colors duration-150 hover:bg-blue-50';
                    card.dataset.date = dateStr;

                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-start';

                    const dateEl = document.createElement('div');
                    dateEl.innerHTML = `
                        <p class="text-sm font-semibold text-gray-800">${formatDiaryDate(dateStr)}</p>
                    `;
                    header.appendChild(dateEl);

                    const moodEl = document.createElement('span');
                    moodEl.className = 'text-2xl';
                    moodEl.textContent = diary.mood || '—';
                    header.appendChild(moodEl);

                    card.appendChild(header);

                    const textEl = document.createElement('p');
                    textEl.className = 'text-sm text-gray-700 whitespace-pre-wrap leading-relaxed';
                    textEl.textContent = diary.text && diary.text.trim().length > 0 ? diary.text : 'テキストの記録はありません';
                    card.appendChild(textEl);

                    if (diary.photo) {
                        const photoEl = document.createElement('img');
                        photoEl.src = diary.photo;
                        photoEl.alt = `${dateStr} の日記写真`;
                        photoEl.className = 'w-full h-40 object-cover rounded-lg cursor-zoom-in';
                        photoEl.dataset.photoPreview = 'true';
                        photoEl.addEventListener('click', (event) => {
                            event.stopPropagation();
                            openPhotoPreview(diary.photo);
                        });
                        card.appendChild(photoEl);
                    }

                    card.addEventListener('click', () => handleDiaryCardOpen(dateStr));

                    diaryList.appendChild(card);
                });
            }

            function renderDiaryFinanceList() {
                if (!diaryFinanceList) return;
                diaryFinanceList.innerHTML = '';
                if (!currentUser) {
                    diaryFinanceList.innerHTML = '<div class="text-center text-sm text-gray-500 bg-white p-4 rounded-lg shadow-sm">ログインすると収支タイムラインを閲覧できます。</div>';
                    return;
                }

                const entries = [];
                Object.entries(records).forEach(([dateStr, record]) => {
                    record.transactions.forEach(t => {
                        entries.push({
                            ...t,
                            dateStr,
                            createdAt: t.createdAt || Number(t.id) || 0
                        });
                    });
                });

                entries.sort((a, b) => {
                    const dateDiff = new Date(b.dateStr) - new Date(a.dateStr);
                    if (dateDiff !== 0) return dateDiff;
                    return (b.createdAt || 0) - (a.createdAt || 0);
                });

                // フィルター適用
                const min = financeFilters.min ? parseInt(financeFilters.min, 10) : null;
                const max = financeFilters.max ? parseInt(financeFilters.max, 10) : null;
                const filteredEntries = entries.filter(entry => {
                    if (financeFilters.category && financeFilters.category !== 'all') {
                        const [filterType, filterName] = financeFilters.category.split(':');
                        if (filterType && filterName) {
                            if (entry.type !== filterType || entry.category !== filterName) {
                                return false;
                            }
                        }
                    }
                    if (Number.isFinite(min) && entry.amount < min) return false;
                    if (Number.isFinite(max) && entry.amount > max) return false;
                    return true;
                });

                if (filteredEntries.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'text-center text-sm text-gray-500 bg-white p-4 rounded-lg shadow-sm';
                    empty.textContent = '条件に合う収支の記録がありません';
                    diaryFinanceList.appendChild(empty);
                    return;
                }

                filteredEntries.forEach(entry => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-3 rounded-lg shadow-sm flex justify-between items-center border border-gray-100 hover:shadow-md transition cursor-pointer';
                    card.dataset.transactionId = entry.id;
                    card.dataset.date = entry.dateStr;

                    const left = document.createElement('div');
                    left.className = 'space-y-1';
                    const dateLine = document.createElement('p');
                    dateLine.className = 'text-xs text-gray-500';
                    dateLine.textContent = formatDiaryDate(entry.dateStr);
                    const memoLine = document.createElement('p');
                    memoLine.className = 'text-sm font-medium text-gray-800';
                    memoLine.textContent = entry.category;
                    const note = document.createElement('p');
                    note.className = 'text-xs text-gray-500';
                    note.textContent = entry.memo || 'メモなし';
                    left.appendChild(dateLine);
                    left.appendChild(memoLine);
                    left.appendChild(note);

                    const right = document.createElement('div');
                    right.className = 'text-right';
                    const amount = document.createElement('p');
                    amount.className = `text-base font-bold ${entry.type === 'income' ? 'text-blue-600' : 'text-red-600'}`;
                    amount.textContent = `${entry.type === 'income' ? '+' : '-'}¥${Number(entry.amount || 0).toLocaleString()}`;
                    const badge = document.createElement('span');
                    badge.className = `inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] font-semibold ${entry.type === 'income' ? 'bg-blue-50 text-blue-700' : 'bg-red-50 text-red-700'}`;
                    badge.textContent = entry.type === 'income' ? '収入' : '支出';
                    right.appendChild(amount);
                    right.appendChild(badge);

                    card.appendChild(left);
                    card.appendChild(right);
                    card.addEventListener('click', () => {
                        selectedDateStr = entry.dateStr;
                        showInputModal(entry.dateStr, { transactionId: entry.id, focusTab: 'expense' });
                    });
                    diaryFinanceList.appendChild(card);
                });
            }

            function setDiaryMode(nextMode) {
                currentDiaryMode = nextMode === DIARY_MODES.finance ? DIARY_MODES.finance : DIARY_MODES.diary;
                if (diaryModeDiaryBtn && diaryModeFinanceBtn) {
                    diaryModeDiaryBtn.classList.toggle('bg-white', currentDiaryMode === DIARY_MODES.diary);
                    diaryModeDiaryBtn.classList.toggle('shadow', currentDiaryMode === DIARY_MODES.diary);
                    diaryModeDiaryBtn.classList.toggle('text-blue-600', currentDiaryMode === DIARY_MODES.diary);
                    diaryModeDiaryBtn.classList.toggle('text-gray-600', currentDiaryMode !== DIARY_MODES.diary);
                    diaryModeFinanceBtn.classList.toggle('bg-white', currentDiaryMode === DIARY_MODES.finance);
                    diaryModeFinanceBtn.classList.toggle('shadow', currentDiaryMode === DIARY_MODES.finance);
                    diaryModeFinanceBtn.classList.toggle('text-blue-600', currentDiaryMode === DIARY_MODES.finance);
                    diaryModeFinanceBtn.classList.toggle('text-gray-600', currentDiaryMode !== DIARY_MODES.finance);
                }

                if (diaryList && diaryFinanceList) {
                    if (currentDiaryMode === DIARY_MODES.diary) {
                        diaryList.classList.remove('hidden');
                        diaryFinanceList.classList.add('hidden');
                        renderDiaryList();
                    } else {
                        diaryList.classList.add('hidden');
                        diaryFinanceList.classList.remove('hidden');
                        populateFinanceCategoryFilter();
                        renderDiaryFinanceList();
                    }
                    updateDiaryFilterPanelVisibility();
                }
            }

            function handleDiaryCardOpen(dateStr) {
                if (!dateStr) return;
                if (!currentUser) {
                    showAuthScreen();
                    return;
                }
                showInputModal(dateStr, { focusTab: 'diary' });
            }

            function toggleDiaryFilters() {
                isDiaryFilterOpen = !isDiaryFilterOpen;
                updateDiaryFilterPanelVisibility();
            }

            function updateDiaryFilterPanelVisibility() {
                if (!toggleDiaryFiltersBtn) return;
                const isDiaryMode = currentDiaryMode === DIARY_MODES.diary;
                const targetPanel = isDiaryMode ? diaryFilterPanel : diaryFinanceFilterPanel;
                const otherPanel = isDiaryMode ? diaryFinanceFilterPanel : diaryFilterPanel;

                if (targetPanel) {
                    targetPanel.classList.toggle('hidden', !isDiaryFilterOpen);
                }
                if (otherPanel) {
                    otherPanel.classList.add('hidden');
                }
                toggleDiaryFiltersBtn.classList.toggle('active', isDiaryFilterOpen);
                toggleDiaryFiltersBtn.classList.remove('hidden');
                toggleDiaryFiltersBtn.setAttribute('aria-expanded', isDiaryFilterOpen.toString());
            }

            function openPhotoPreview(photoData) {
                if (!photoData || !photoPreviewModal || !photoPreviewModalImg) return;
                photoPreviewModalImg.src = photoData;
                photoPreviewModal.classList.remove('hidden');
            }

            function closePhotoPreview() {
                if (!photoPreviewModal || !photoPreviewModalImg) return;
                photoPreviewModalImg.src = '';
                photoPreviewModal.classList.add('hidden');
            }

            function formatDiaryDate(dateStr) {
                const date = new Date(dateStr);
                if (Number.isNaN(date.getTime())) {
                    return dateStr;
                }
                return date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    weekday: 'short'
                });
            }

            function setSettingsSectionState(section, isOpen) {
                const toggle = section.querySelector('[data-settings-toggle]');
                const content = section.querySelector('.settings-section-content');
                if (!toggle || !content) return;
                section.classList.toggle('collapsed', !isOpen);
                toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            }

            function setupSettingsAccordions() {
                settingsSections.forEach((section) => {
                    const toggle = section.querySelector('[data-settings-toggle]');
                    const content = section.querySelector('.settings-section-content');
                    if (!toggle || !content) return;
                    const defaultOpen = section.dataset.defaultOpen === 'true';
                    setSettingsSectionState(section, defaultOpen);
                    toggle.addEventListener('click', () => {
                        const isOpen = !section.classList.contains('collapsed');
                        setSettingsSectionState(section, !isOpen);
                    });
                });
            }

            function renderSettingsView() {
                updateAccountInfoUI();
                updateThemeControls();
                renderBudgetSetting();
                renderCategoryList('expense', expenseCategoryList, expenseCategoryCount);
                renderCategoryList('income', incomeCategoryList, incomeCategoryCount);
                renderRecurringList();
                updateRecurringCategoryOptions();
                populateFinanceCategoryFilter();
            }

            function renderBudgetSetting() {
                if (!monthlyBudgetInput || !monthlyBudgetStatus) return;
                const budget = getMonthlyBudget();
                monthlyBudgetInput.value = budget ?? '';
                monthlyBudgetStatus.textContent = budget
                    ? `今月の予算: ${formatCurrency(budget)}`
                    : '予算が未設定です。支出の上限額を入力してください。';
            }

            function renderCategoryList(type, container, countElement) {
                if (!container) return;
                container.innerHTML = '';
                const categories = getCategoryOptions(type);
                const canRemove = categories.length > 1;

                categories.forEach((name, index) => {
                    const item = document.createElement('li');
                    item.className = 'flex items-center justify-between gap-2 rounded-lg border border-gray-200 bg-gray-50 px-3 py-2';
                    item.dataset.categoryName = name;
                    item.dataset.categoryIndex = index.toString();

                    const left = document.createElement('div');
                    left.className = 'flex items-center gap-2';
                    const pill = document.createElement('span');
                    pill.className = 'inline-flex items-center justify-center w-8 h-8 rounded-full bg-white border border-gray-200 text-xs font-semibold';
                    pill.textContent = index + 1;
                    const label = document.createElement('span');
                    label.className = 'font-medium text-sm';
                    label.textContent = name;
                    left.appendChild(pill);
                    left.appendChild(label);

                    const actions = document.createElement('div');
                    actions.className = 'flex items-center gap-1';

                    const upBtn = document.createElement('button');
                    upBtn.type = 'button';
                    upBtn.className = 'category-action-btn';
                    upBtn.dataset.categoryAction = 'move-up';
                    upBtn.dataset.categoryName = name;
                    upBtn.title = '上に移動';
                    upBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5l-7 7h4v7h6v-7h4l-7-7z"></path></svg>';
                    upBtn.disabled = index === 0;

                    const downBtn = document.createElement('button');
                    downBtn.type = 'button';
                    downBtn.className = 'category-action-btn';
                    downBtn.dataset.categoryAction = 'move-down';
                    downBtn.dataset.categoryName = name;
                    downBtn.title = '下に移動';
                    downBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l7-7h-4V5H9v7H5l7 7z"></path></svg>';
                    downBtn.disabled = index === categories.length - 1;

                    actions.appendChild(upBtn);
                    actions.appendChild(downBtn);

                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'category-action-btn';
                    editBtn.dataset.categoryAction = 'edit';
                    editBtn.dataset.categoryName = name;
                    editBtn.title = '名前を編集';
                    editBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 11l6.232-6.232a2 2 0 012.828 0l1.172 1.172a2 2 0 010 2.828L13 15l-4 1 1-4z"></path></svg>';
                    actions.appendChild(editBtn);

                    if (canRemove) {
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'category-action-btn text-red-500 hover:text-red-600';
                        removeBtn.dataset.categoryAction = 'remove';
                        removeBtn.dataset.categoryName = name;
                        removeBtn.title = '削除';
                        removeBtn.innerHTML = '&times;';
                        actions.appendChild(removeBtn);
                    }

                    item.appendChild(left);
                    item.appendChild(actions);
                    container.appendChild(item);
                });

                if (countElement) {
                    countElement.textContent = `${categories.length} 件`;
                }
            }

            function updateAccountInfoUI() {
                if (!accountNameEl || !accountEmailEl || !logoutBtn) return;
                if (currentUser) {
                    accountNameEl.textContent = currentUser.displayName || 'ゲスト';
                    accountEmailEl.textContent = currentUser.email || '';
                    if (accountPhotoEl) {
                        if (currentUser.photoURL) {
                            accountPhotoEl.src = currentUser.photoURL;
                            accountPhotoEl.classList.remove('hidden');
                        } else {
                            accountPhotoEl.classList.add('hidden');
                        }
                    }
                    logoutBtn.classList.remove('hidden');
                } else {
                    accountNameEl.textContent = 'ログインしていません';
                    accountEmailEl.textContent = '';
                    if (accountPhotoEl) {
                        accountPhotoEl.classList.add('hidden');
                    }
                    logoutBtn.classList.add('hidden');
                }
            }

            function handleBudgetSave() {
                if (!monthlyBudgetInput) return;
                const value = Number(monthlyBudgetInput.value);
                if (!Number.isFinite(value) || value <= 0) {
                    appSettings.monthlyBudget = null;
                    monthlyBudgetInput.value = '';
                    if (monthlyBudgetStatus) {
                        monthlyBudgetStatus.textContent = '0より大きい金額を入力してください。';
                    }
                    return;
                }

                appSettings.monthlyBudget = Math.round(value);
                saveSettings();
                renderSettingsView();
                renderMonthSummary();
                if (currentView === 'analysis') {
                    renderAnalysis();
                }
            }

            function handleBudgetClear() {
                appSettings.monthlyBudget = null;
                if (monthlyBudgetInput) {
                    monthlyBudgetInput.value = '';
                }
                saveSettings();
                renderSettingsView();
                renderMonthSummary();
                if (currentView === 'analysis') {
                    renderAnalysis();
                }
            }

            function handleCategoryAdd(type) {
                const input = type === 'expense' ? expenseCategoryInput : incomeCategoryInput;
                if (!input) return;
                const newName = input.value.trim();
                if (!newName) return;

                const normalized = newName.toLowerCase();
                const categories = getCategoryOptions(type);
                const exists = categories.some(cat => cat.toLowerCase() === normalized);
                if (exists) {
                    input.value = '';
                    return;
                }

                appSettings.categories[type] = [...categories, newName];
                input.value = '';
                saveSettings();
                renderSettingsView();
                updateCategorySelect();
            }

            function handleCategoryRemove(type, name) {
                const categories = getCategoryOptions(type);
                if (categories.length <= 1) {
                    alert('カテゴリは少なくとも1つ必要です');
                    return;
                }

                const updated = categories.filter(cat => cat !== name);
                appSettings.categories[type] = updated;
                saveSettings();
                renderSettingsView();
                updateCategorySelect();
            }

            function handleCategoryMove(type, name, direction) {
                const categories = getCategoryOptions(type);
                const index = categories.findIndex(cat => cat === name);
                if (index === -1) return;
                const targetIndex = index + direction;
                if (targetIndex < 0 || targetIndex >= categories.length) return;
                const reordered = [...categories];
                const [removed] = reordered.splice(index, 1);
                reordered.splice(targetIndex, 0, removed);
                appSettings.categories[type] = reordered;
                saveSettings();
                renderSettingsView();
                updateCategorySelect();
            }
            
            function openCategoryEditModal(type, name) {
                if (!categoryEditModal || !categoryEditInput) return;
                categoryEditTarget = { type, oldName: name };
                if (categoryEditTitle) {
                    categoryEditTitle.textContent = `${type === 'income' ? '収入' : '支出'}カテゴリを編集`;
                }
                if (categoryEditHelper) {
                    categoryEditHelper.textContent = `${name} の名前を変更します`;
                }
                categoryEditInput.value = name;
                categoryEditInput.focus();
                categoryEditInput.setSelectionRange(0, name.length);
                if (categoryEditError) {
                    categoryEditError.textContent = '';
                    categoryEditError.classList.add('hidden');
                }
                categoryEditModal.classList.remove('hidden');
                categoryEditModal.setAttribute('aria-hidden', 'false');
            }

            function closeCategoryEditModal() {
                categoryEditTarget = { type: null, oldName: null };
                if (categoryEditInput) {
                    categoryEditInput.value = '';
                }
                if (categoryEditError) {
                    categoryEditError.textContent = '';
                    categoryEditError.classList.add('hidden');
                }
                if (categoryEditModal) {
                    categoryEditModal.classList.add('hidden');
                    categoryEditModal.setAttribute('aria-hidden', 'true');
                }
            }

            function showCategoryEditError(message) {
                if (!categoryEditError) return;
                categoryEditError.textContent = message;
                categoryEditError.classList.remove('hidden');
            }

            async function performCategoryRename(type, oldName, newName) {
                const categories = getCategoryOptions(type);
                if (!newName) {
                    showCategoryEditError('カテゴリ名を入力してください');
                    return;
                }
                if (newName === oldName) {
                    closeCategoryEditModal();
                    return;
                }
                const normalized = newName.toLowerCase();
                const exists = categories.some(cat => cat.toLowerCase() === normalized);
                if (exists) {
                    showCategoryEditError('同じ名前のカテゴリが既にあります');
                    return;
                }

                appSettings.categories[type] = categories.map(cat => cat === oldName ? newName : cat);

                // 既存トランザクションのカテゴリ名を更新
                Object.values(records || {}).forEach((dayRecord) => {
                    if (!dayRecord || !Array.isArray(dayRecord.transactions)) return;
                    dayRecord.transactions = dayRecord.transactions.map((t) => {
                        if (t && t.type === type && t.category === oldName) {
                            return { ...t, category: newName };
                        }
                        return t;
                    });
                });

                // 定額エントリのカテゴリ名を更新
                if (Array.isArray(appSettings.recurringEntries)) {
                    appSettings.recurringEntries = appSettings.recurringEntries.map((entry) => {
                        if (entry && entry.type === type && entry.category === oldName) {
                            return { ...entry, category: newName };
                        }
                        return entry;
                    });
                }

                renderSettingsView();
                updateCategorySelect();
                updateRecurringCategoryOptions();
                renderDiaryFinanceList();
                renderDailyTransactions(getDayRecord(selectedDateStr).transactions);
                renderCalendar();
                renderAnalysis();
                saveSettings();
                await saveRecords();
                closeCategoryEditModal();
            }

            async function confirmCategoryEdit() {
                if (!categoryEditTarget.type || !categoryEditInput) return;
                const newName = categoryEditInput.value.trim();
                await performCategoryRename(categoryEditTarget.type, categoryEditTarget.oldName, newName);
            }

            function updateRecurringCategoryOptions() {
                if (!recurringCategoryInput) return;
                const type = recurringTypeSelect?.value === 'income' ? 'income' : 'expense';
                const options = getCategoryOptions(type);
                const currentValue = recurringCategoryInput.value;
                recurringCategoryInput.innerHTML = '';
                options.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    recurringCategoryInput.appendChild(option);
                });
                if (options.includes(currentValue)) {
                    recurringCategoryInput.value = currentValue;
                } else if (currentValue) {
                    const fallback = document.createElement('option');
                    fallback.value = currentValue;
                    fallback.textContent = `${currentValue} (廃止)`;
                    recurringCategoryInput.appendChild(fallback);
                    recurringCategoryInput.value = currentValue;
                }
            }

            function updateRecurringScheduleUI(schedule = recurringScheduleType?.value || 'date') {
                const isWeekday = schedule === 'weekday';
                if (recurringDayRow) {
                    recurringDayRow.classList.toggle('hidden', isWeekday);
                }
                if (recurringWeekdaysRow) {
                    recurringWeekdaysRow.classList.toggle('hidden', !isWeekday);
                }
            }

            function setSelectedRecurringWeekdays(weekdays = []) {
                const selected = new Set(weekdays);
                recurringWeekdayButtons.forEach((btn) => {
                    const value = Number.parseInt(btn.dataset.recurringWeekday, 10);
                    const isActive = selected.has(value);
                    btn.classList.toggle('active', isActive);
                    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                });
            }

            function getSelectedRecurringWeekdays() {
                return recurringWeekdayButtons
                    .filter((btn) => btn.classList.contains('active'))
                    .map((btn) => Number.parseInt(btn.dataset.recurringWeekday, 10))
                    .filter((w) => Number.isInteger(w) && w >= 0 && w <= 6);
            }

            function setRecurringScheduleType(schedule) {
                const normalized = schedule === 'weekday' ? 'weekday' : 'date';
                if (recurringScheduleType) {
                    recurringScheduleType.value = normalized;
                }
                updateRecurringScheduleUI(normalized);
            }

            function resetRecurringForm() {
                editingRecurringId = null;
                if (recurringSaveBtn) {
                    recurringSaveBtn.textContent = '追加';
                }
                if (recurringTypeSelect) recurringTypeSelect.value = 'expense';
                setRecurringScheduleType('date');
                setSelectedRecurringWeekdays([]);
                if (recurringDayInput) recurringDayInput.value = '';
                if (recurringAmountInput) recurringAmountInput.value = '';
                if (recurringMemoInput) recurringMemoInput.value = '';
                if (recurringStartInput) recurringStartInput.value = formatDate(new Date());
                if (recurringEndInput) recurringEndInput.value = '';
                if (recurringNoEndInput) recurringNoEndInput.checked = true;
                updateRecurringCategoryOptions();
            }

            function getRecurringSkipKey(recurringId, dateStr) {
                return `${recurringId}:${dateStr}`;
            }

            function getRecurringSkipSet() {
                const raw = Array.isArray(appSettings.recurringSkipInstances) ? appSettings.recurringSkipInstances : [];
                return new Set(raw);
            }

            function markRecurringInstanceSkipped(recurringId, dateStr) {
                if (!recurringId || !dateStr) return;
                const key = getRecurringSkipKey(recurringId, dateStr);
                const list = Array.isArray(appSettings.recurringSkipInstances) ? appSettings.recurringSkipInstances : [];
                if (list.includes(key)) return;
                appSettings.recurringSkipInstances = [...list, key];
                saveSettings();
            }

            function handleRecurringSave() {
                if (!recurringTypeSelect || !recurringAmountInput || !recurringCategoryInput) return;
                const type = recurringTypeSelect.value === 'income' ? 'income' : 'expense';
                const schedule = recurringScheduleType?.value === 'weekday' ? 'weekday' : 'date';
                const day = Number.parseInt(recurringDayInput?.value, 10);
                const selectedWeekdays = getSelectedRecurringWeekdays().sort((a, b) => a - b);
                const amount = parseInt(recurringAmountInput.value, 10);
                const category = recurringCategoryInput.value;
                const memo = recurringMemoInput?.value?.trim() || '';
                const startDateStr = recurringStartInput?.value || '';
                const endDateStr = recurringEndInput?.value || '';
                const noEnd = recurringNoEndInput?.checked;

                if (schedule === 'date') {
                    if (!Number.isFinite(day) || day < 1 || day > 31) {
                        alert('1〜31の間で日付を入力してください。');
                        return;
                    }
                } else if (selectedWeekdays.length === 0) {
                    alert('曜日を1つ以上選択してください。');
                    return;
                }
                if (!amount || amount <= 0) {
                    alert('金額を入力してください。');
                    return;
                }
                if (!category) {
                    alert('カテゴリを選択してください。');
                    return;
                }
                if (!startDateStr) {
                    alert('開始日を入力してください。');
                    return;
                }

                const startDateObj = new Date(startDateStr);
                if (Number.isNaN(startDateObj.getTime())) {
                    alert('有効な開始日を入力してください。');
                    return;
                }

                let endDateObj = null;
                if (!noEnd && endDateStr) {
                    endDateObj = new Date(endDateStr);
                    if (Number.isNaN(endDateObj.getTime())) {
                        alert('有効な終了日を入力してください。');
                        return;
                    }
                    if (endDateObj < startDateObj) {
                        alert('終了日は開始日以降に設定してください。');
                        return;
                    }
                }

                const entry = {
                    id: editingRecurringId || `rec-${Date.now()}`,
                    type,
                    schedule,
                    day: schedule === 'date' ? day : null,
                    weekdays: schedule === 'weekday' ? selectedWeekdays : [],
                    amount,
                    category,
                    memo,
                    startDate: formatDate(startDateObj),
                    endDate: endDateObj ? formatDate(endDateObj) : null
                };

                const entries = Array.isArray(appSettings.recurringEntries) ? [...appSettings.recurringEntries] : [];
                const existingIndex = entries.findIndex(e => e.id === entry.id);
                if (existingIndex >= 0) {
                    entries[existingIndex] = entry;
                } else {
                    entries.push(entry);
                }
                entries.sort(compareRecurringEntries);
                appSettings.recurringEntries = normalizeRecurringEntries(entries);
                saveSettings();
                renderRecurringList();
                resetRecurringForm();
                applyRecurringEntriesForMonth(currentDate);
                renderCalendar();
                renderAnalysis();
            }

            function handleRecurringDelete(id) {
                if (!id) return;
                const confirmed = confirm('この定額記録を削除してもよろしいですか？');
                if (!confirmed) return;
                appSettings.recurringEntries = (appSettings.recurringEntries || []).filter(e => e.id !== id);
                saveSettings();
                renderRecurringList();
            }

            function startRecurringEdit(id) {
                if (!id) return;
                const entry = (appSettings.recurringEntries || []).find(e => e.id === id);
                if (!entry) return;
                editingRecurringId = id;
                if (recurringSaveBtn) recurringSaveBtn.textContent = '更新';
                if (recurringTypeSelect) recurringTypeSelect.value = entry.type;
                updateRecurringCategoryOptions();
                const schedule = getRecurringScheduleType(entry);
                setRecurringScheduleType(schedule);
                if (schedule === 'weekday') {
                    setSelectedRecurringWeekdays(getRecurringWeekdays(entry));
                    if (recurringDayInput) recurringDayInput.value = '';
                } else if (recurringDayInput) {
                    recurringDayInput.value = entry.day;
                    setSelectedRecurringWeekdays([]);
                }
                if (recurringAmountInput) recurringAmountInput.value = entry.amount;
                if (recurringCategoryInput) recurringCategoryInput.value = entry.category;
                if (recurringMemoInput) recurringMemoInput.value = entry.memo || '';
                if (recurringStartInput) recurringStartInput.value = entry.startDate || formatDate(new Date());
                if (recurringEndInput) recurringEndInput.value = entry.endDate || '';
                if (recurringNoEndInput) recurringNoEndInput.checked = !entry.endDate;
            }

            function renderRecurringList() {
                if (!recurringListContainer) return;
                recurringListContainer.innerHTML = '';
                const entries = normalizeRecurringEntries(appSettings.recurringEntries);
                if (entries.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'text-center text-sm text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300 p-4';
                    empty.textContent = '定期的な記録はまだありません';
                    recurringListContainer.appendChild(empty);
                    return;
                }

                entries.sort(compareRecurringEntries);
                entries.forEach(entry => {
                    const row = document.createElement('div');
                    row.className = 'flex items-center justify-between gap-3 border border-gray-200 rounded-lg px-3 py-2 bg-gray-50';
                    row.style.backgroundColor = 'var(--color-panel-muted)';
                    row.style.borderColor = 'var(--color-border)';
                    const left = document.createElement('div');
                    left.className = 'space-y-0.5';
                    const title = document.createElement('p');
                    title.className = 'text-sm font-semibold text-gray-800';
                    title.style.color = 'var(--color-text)';
                    title.textContent = `${formatRecurringScheduleText(entry)}: ${entry.category}`;
                    const meta = document.createElement('p');
                    meta.className = 'text-xs text-gray-500';
                    meta.style.color = 'var(--color-text-muted)';
                    const typeLabel = entry.type === 'income' ? '収入' : '支出';
                    const startText = entry.startDate ? entry.startDate : '未設定';
                    const endText = entry.endDate ? entry.endDate : 'なし';
                    meta.textContent = `${typeLabel} / ¥${Number(entry.amount || 0).toLocaleString()} ${entry.memo ? ` / ${entry.memo}` : ''}`;

                    const period = document.createElement('p');
                    period.className = 'text-xs';
                    period.style.color = 'var(--color-text-muted)';
                    period.textContent = `期間: ${startText} 〜 ${endText}`;

                    left.appendChild(title);
                    left.appendChild(meta);
                    left.appendChild(period);

                    const actions = document.createElement('div');
                    actions.className = 'flex items-center gap-1 text-sm';
                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'category-action-btn';
                    editBtn.dataset.recurringAction = 'edit';
                    editBtn.dataset.recurringId = entry.id;
                    editBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 11l6.232-6.232a2 2 0 012.828 0l1.172 1.172a2 2 0 010 2.828L13 15l-4 1 1-4z"></path></svg>';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'category-action-btn text-red-500 hover:text-red-600';
                    deleteBtn.dataset.recurringAction = 'delete';
                    deleteBtn.dataset.recurringId = entry.id;
                    deleteBtn.innerHTML = '&times;';

                    actions.appendChild(editBtn);
                    actions.appendChild(deleteBtn);

                    row.appendChild(left);
                    row.appendChild(actions);
                    recurringListContainer.appendChild(row);
                });
            }

            function getRecurringTargetDatesForMonth(entry, year, month) {
                const dates = [];
                const lastDay = new Date(year, month + 1, 0).getDate();
                const schedule = getRecurringScheduleType(entry);
                if (schedule === 'weekday') {
                    const weekdays = getRecurringWeekdays(entry);
                    if (weekdays.length === 0) return dates;
                    for (let day = 1; day <= lastDay; day++) {
                        const targetDate = new Date(year, month, day);
                        if (weekdays.includes(targetDate.getDay())) {
                            dates.push(targetDate);
                        }
                    }
                    return dates;
                }
                const targetDay = Math.min(Math.max(1, Number.parseInt(entry.day, 10) || 1), lastDay);
                dates.push(new Date(year, month, targetDay));
                return dates;
            }

            function applyRecurringEntriesForMonth(baseDate = currentDate) {
                if (!currentUser) return;
                const entries = Array.isArray(appSettings.recurringEntries) ? appSettings.recurringEntries : [];
                if (entries.length === 0) return;

                const skipSet = getRecurringSkipSet();
                const year = baseDate.getFullYear();
                const month = baseDate.getMonth();
                const today = new Date();
                const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                let updated = false;

                entries.forEach(entry => {
                    const targetDates = getRecurringTargetDatesForMonth(entry, year, month);
                    targetDates.forEach((targetDate) => {
                        const dateStr = formatDate(targetDate);
                        const record = getDayRecord(dateStr);
                        const existingIndex = record.transactions.findIndex(t => t.recurringId === entry.id);
                        const skipKey = getRecurringSkipKey(entry.id, dateStr);

                        const isActive = isRecurringActiveOnDate(entry, targetDate, todayDate);
                        if (isActive && !skipSet.has(skipKey)) {
                            const payload = {
                                id: `${entry.id}-${dateStr}`,
                                type: entry.type,
                                amount: entry.amount,
                                category: entry.category,
                                memo: entry.memo || '',
                                recurringId: entry.id,
                                createdAt: Date.now()
                            };
                            if (existingIndex < 0) {
                                record.transactions.push(payload);
                                updated = true;
                            }
                        }
                    });
                });

                if (updated) {
                    saveRecords();
                }
            }

            function isRecurringActiveOnDate(entry, targetDate, todayDate = new Date()) {
                const dateOnly = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
                const today = new Date(todayDate.getFullYear(), todayDate.getMonth(), todayDate.getDate());
                if (dateOnly > today) return false; // 未来日は反映しない

                if (entry.startDate) {
                    const start = new Date(entry.startDate);
                    if (!Number.isNaN(start.getTime()) && dateOnly < new Date(start.getFullYear(), start.getMonth(), start.getDate())) {
                        return false;
                    }
                }
                if (entry.endDate) {
                    const end = new Date(entry.endDate);
                    if (!Number.isNaN(end.getTime()) && dateOnly > new Date(end.getFullYear(), end.getMonth(), end.getDate())) {
                        return false;
                    }
                }
                return true;
            }

            // 感情セレクター描画
            function renderMoodSelector() {
                moodSelector.innerHTML = '';
                MOODS.forEach(mood => {
                    const btn = document.createElement('button');
                    btn.textContent = mood;
                    btn.type = 'button';
                    btn.className = 'mood-icon text-3xl p-2 rounded-full hover:bg-gray-100 transition-all duration-200';
                    btn.dataset.mood = mood;
                    btn.setAttribute('aria-pressed', 'false');
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (selectedMood === mood) {
                            selectedMood = null;
                        } else {
                            selectedMood = mood;
                        }
                        updateMoodSelectorUI(selectedMood);
                    });
                    moodSelector.appendChild(btn);
                });
            }

            // モーダル表示
            function showInputModal(targetDateStr = selectedDateStr, options = {}) {
                if (!currentUser) {
                    showAuthScreen();
                    return;
                }
                if (targetDateStr) {
                    selectedDateStr = targetDateStr;
                }
                modalDateHeader.textContent = selectedDateStr;
                
                const record = getDayRecord(selectedDateStr);
                
                // 収支フォームのリセット
                amountInput.value = '';
                memoInput.value = '';
                typeToggle.checked = false; // デフォルトを支出に
                handleTypeToggleChange();
                editingTransactionId = null;
                updateTransactionButtonLabel();

                // 収支一覧の描画
                renderDailyTransactions(record.transactions);
                
                // 日記フォームの読み込み
                diaryTextInput.value = record.diary.text || '';
                selectedMood = record.diary.mood;
                updateMoodSelectorUI(selectedMood);
                
                // 写真の読み込み
                tempPhotoData = record.diary.photo;
                if (tempPhotoData) {
                    photoPreview.src = tempPhotoData;
                    photoPreview.classList.remove('hidden');
                    photoPreviewText.classList.add('hidden');
                    photoRemoveBtn.classList.remove('hidden');
                } else {
                    photoPreview.src = '';
                    photoPreview.classList.add('hidden');
                    photoPreviewText.classList.remove('hidden');
                    photoRemoveBtn.classList.add('hidden');
                }

                // モーダル表示
                inputModal.classList.remove('hidden');
                // 初期タブ
                const defaultTab = options.focusTab === 'diary' ? 'diary' : 'expense';
                showTab(defaultTab);

                if (options.transactionId && record.transactions?.length) {
                    const targetTx = record.transactions.find(t => t.id === options.transactionId);
                    if (targetTx) {
                        startTransactionEdit(targetTx);
                    }
                }
            }

            // モーダル非表示
            function hideInputModal() {
                inputModal.classList.add('hidden');
                // 一時データをリセット
                tempPhotoData = null;
                selectedMood = null;
            }

            // --- UIヘルパー ---
            
            // ナビゲーションUI更新
            function updateNavUI() {
                const viewMap = {
                    calendar: calendarView,
                    analysis: analysisView,
                    diary: diaryView,
                    settings: settingsView
                };

                Object.values(viewMap).forEach(view => {
                    if (!view) return;
                    view.classList.add('hidden');
                });
                if (viewMap[currentView]) {
                    viewMap[currentView].classList.remove('hidden');
                }

                const navMap = {
                    calendar: navCalendar,
                    analysis: navAnalysis,
                    diary: navDiary,
                    settings: navSettings
                };
                Object.values(navMap).forEach(btn => {
                    if (!btn) return;
                    btn.classList.add('text-gray-500');
                    btn.classList.remove('text-blue-600');
                });
                if (navMap[currentView]) {
                    navMap[currentView].classList.add('text-blue-600');
                    navMap[currentView].classList.remove('text-gray-500');
                }

                if (currentView === 'analysis') {
                    renderAnalysis();
                } else if (currentView === 'diary') {
                    setDiaryMode(currentDiaryMode);
                } else if (currentView === 'settings') {
                    renderSettingsView();
                }
            }
            
            // モーダルタブ切り替え
            function showTab(tabName) {
                if (tabName === 'expense') {
                    expenseForm.classList.remove('hidden');
                    diaryForm.classList.add('hidden');
                    tabExpense.classList.add('bg-white', 'shadow', 'text-blue-600');
                    tabExpense.classList.remove('text-gray-600');
                    tabDiary.classList.remove('bg-white', 'shadow', 'text-blue-600');
                    tabDiary.classList.add('text-gray-600');
                } else {
                    expenseForm.classList.add('hidden');
                    diaryForm.classList.remove('hidden');
                    tabExpense.classList.remove('bg-white', 'shadow', 'text-blue-600');
                    tabExpense.classList.add('text-gray-600');
                    tabDiary.classList.add('bg-white', 'shadow', 'text-blue-600');
                    tabDiary.classList.remove('text-gray-600');
                }
            }

            // 集計タブUI更新
            function updateAnalysisTabUI() {
                const tabs = [
                    document.getElementById('tab-week'),
                    document.getElementById('tab-month'),
                    document.getElementById('tab-year')
                ];
                tabs.forEach(tab => {
                    tab.classList.remove('bg-white', 'shadow', 'text-blue-600');
                    tab.classList.add('text-gray-600');
                });
                
                if (currentAnalysisView === 'week') {
                    document.getElementById('tab-week').classList.add('bg-white', 'shadow', 'text-blue-600');
                } else if (currentAnalysisView === 'year') {
                    document.getElementById('tab-year').classList.add('bg-white', 'shadow', 'text-blue-600');
                } else { // month
                    document.getElementById('tab-month').classList.add('bg-white', 'shadow', 'text-blue-600');
                }
            }
            
            // 感情セレクタUI更新
            function updateMoodSelectorUI(mood) {
                document.querySelectorAll('.mood-icon').forEach(icon => {
                    if (icon.dataset.mood === mood) {
                        icon.classList.add('selected');
                        icon.setAttribute('aria-pressed', 'true');
                        icon.dataset.selected = 'true';
                    } else {
                        icon.classList.remove('selected');
                        icon.setAttribute('aria-pressed', 'false');
                        icon.dataset.selected = 'false';
                    }
                });
            }

            // カテゴリー選択肢更新 (収入/支出)
            function updateCategorySelect() {
                if (!categorySelect) return;
                const type = typeToggle.checked ? 'income' : 'expense';
                const options = getCategoryOptions(type);

                categorySelect.innerHTML = '';
                const prevValue = categorySelect.value;
                options.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categorySelect.appendChild(option);
                });
                if (prevValue && options.includes(prevValue)) {
                    categorySelect.value = prevValue;
                } else if (prevValue && prevValue.length > 0 && !options.includes(prevValue)) {
                    const extra = document.createElement('option');
                    extra.value = prevValue;
                    extra.textContent = `${prevValue} (廃止)`;
                    categorySelect.appendChild(extra);
                    categorySelect.value = prevValue;
                }
            }

            function updateTypeToggleUI() {
                if (!typeToggle) return;
                const isIncome = typeToggle.checked;
                if (typeToggleControl) {
                    typeToggleControl.classList.toggle('mode-income', isIncome);
                    typeToggleControl.classList.toggle('mode-expense', !isIncome);
                }
                if (toggleExpenseBtn) {
                    toggleExpenseBtn.classList.toggle('active', !isIncome);
                    toggleExpenseBtn.setAttribute('aria-pressed', (!isIncome).toString());
                }
                if (toggleIncomeBtn) {
                    toggleIncomeBtn.classList.toggle('active', isIncome);
                    toggleIncomeBtn.setAttribute('aria-pressed', isIncome.toString());
                }
            }

            function handleTypeToggleChange() {
                updateCategorySelect();
                updateTypeToggleUI();
            }

            function getFinanceCategoryOptions() {
                const expense = getCategoryOptions('expense').map(name => ({ value: `expense:${name}`, label: `支出: ${name}` }));
                const income = getCategoryOptions('income').map(name => ({ value: `income:${name}`, label: `収入: ${name}` }));
                return [
                    { value: 'all', label: 'すべて' },
                    ...expense,
                    ...income
                ];
            }

            function populateFinanceCategoryFilter() {
                if (!diaryFinanceCategoryFilter) return;
                const previous = diaryFinanceCategoryFilter.value || 'all';
                diaryFinanceCategoryFilter.innerHTML = '';
                getFinanceCategoryOptions().forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    diaryFinanceCategoryFilter.appendChild(option);
                });
                diaryFinanceCategoryFilter.value = previous && diaryFinanceCategoryFilter.querySelector(`option[value="${previous}"]`) ? previous : 'all';
            }

            function updateTransactionButtonLabel() {
                if (!addTransactionBtn) return;
                if (editingTransactionId) {
                    addTransactionBtn.textContent = 'この収支を更新';
                } else {
                    addTransactionBtn.textContent = 'この収支を追加';
                }
            }

            function startTransactionEdit(transaction) {
                if (!transaction) return;
                editingTransactionId = transaction.id;
                typeToggle.checked = transaction.type === 'income';
                updateTypeToggleUI();
                updateCategorySelect();
                categorySelect.value = transaction.category;
                amountInput.value = transaction.amount;
                memoInput.value = transaction.memo || '';
                updateTransactionButtonLabel();
                renderDailyTransactions(getDayRecord(selectedDateStr).transactions);
            }

            // 日別収支一覧を描画
            function renderDailyTransactions(transactions) {
                dailyTransactionsList.innerHTML = '';
                if (transactions.length === 0) {
                    dailyTransactionsList.innerHTML = '<li class="text-sm text-gray-500 text-center">この日の収支はありません</li>';
                    return;
                }
                
                transactions.forEach(t => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg cursor-pointer border border-transparent hover:border-blue-200';
                    li.dataset.transactionId = t.id;
                    if (editingTransactionId && t.id === editingTransactionId) {
                        li.classList.add('ring-1', 'ring-blue-400', 'bg-blue-50');
                    }
                    
                    const left = document.createElement('div');
                    const category = document.createElement('span');
                    category.textContent = t.category;
                    category.className = 'font-medium text-sm';
                    const memo = document.createElement('span');
                    memo.textContent = t.memo ? ` (${t.memo})` : '';
                    memo.className = 'text-xs text-gray-500 ml-1';
                    left.appendChild(category);
                    left.appendChild(memo);

                    const right = document.createElement('div');
                    const amount = document.createElement('span');
                    amount.textContent = `¥${t.amount.toLocaleString()}`;
                    amount.className = `font-semibold text-sm ${t.type === 'income' ? 'text-blue-600' : 'text-red-600'}`;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;'; // ×
                    deleteBtn.className = 'ml-2 text-red-500 hover:text-red-700 font-bold';
                    deleteBtn.onclick = (event) => {
                        event.stopPropagation();
                        handleDeleteTransaction(t.id);
                    };

                    right.appendChild(amount);
                    right.appendChild(deleteBtn);
                    li.appendChild(left);
                    li.appendChild(right);
                    li.addEventListener('click', () => startTransactionEdit(t));
                    dailyTransactionsList.appendChild(li);
                });
            }
            
            // --- イベントハンドラ ---
            
            function setupEventListeners() {
                // ナビゲーション
                if (navCalendar) {
                    navCalendar.addEventListener('click', () => {
                        currentView = 'calendar';
                        updateNavUI();
                    });
                }
                if (navAnalysis) {
                    navAnalysis.addEventListener('click', () => {
                        currentView = 'analysis';
                        updateNavUI();
                    });
                }
                if (navDiary) {
                    navDiary.addEventListener('click', () => {
                        currentView = 'diary';
                        updateNavUI();
                    });
                }
                if (navSettings) {
                    navSettings.addEventListener('click', () => {
                        currentView = 'settings';
                        updateNavUI();
                    });
                }

                // 月移動 (カレンダー)
                document.getElementById('prev-month-btn').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });
                document.getElementById('next-month-btn').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });

                // 期間移動 (集計)
                document.getElementById('prev-period-analysis-btn').addEventListener('click', () => {
                    if (currentAnalysisView === 'week') {
                        currentDate.setDate(currentDate.getDate() - 7);
                    } else if (currentAnalysisView === 'year') {
                        currentDate.setFullYear(currentDate.getFullYear() - 1);
                    } else { // month
                        currentDate.setMonth(currentDate.getMonth() - 1);
                    }
                    renderAnalysis();
                });
                document.getElementById('next-period-analysis-btn').addEventListener('click', () => {
                    if (currentAnalysisView === 'week') {
                        currentDate.setDate(currentDate.getDate() - 7);
                    } else if (currentAnalysisView === 'year') {
                        currentDate.setFullYear(currentDate.getFullYear() - 1);
                    } else { // month
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                    renderAnalysis();
                });
                
                // 集計タブ
                document.getElementById('tab-week').addEventListener('click', () => {
                    currentAnalysisView = 'week';
                    currentDate = new Date(); // 週表示は今日を基準にリセット
                    renderAnalysis();
                });
                document.getElementById('tab-month').addEventListener('click', () => {
                    currentAnalysisView = 'month';
                    currentDate = new Date(); // 月表示は今月にリセット
                    renderAnalysis();
                });
                document.getElementById('tab-year').addEventListener('click', () => {
                    currentAnalysisView = 'year';
                    currentDate = new Date(); // 年表示は今年にリセット
                    renderAnalysis();
                });

                // モーダル開閉 (新規追加ボタン -> 選択モーダル)
                addNewBtn.addEventListener('click', () => {
                    entryMethodModal.classList.remove('hidden');
                });
                
                // 選択モーダルのアクション
                if (methodManualBtn) {
                    methodManualBtn.addEventListener('click', () => {
                        entryMethodModal.classList.add('hidden');
                        selectedDateStr = formatDate(new Date()); // 新規追加は今日
                        showInputModal();
                    });
                }
                if (methodScanBtn) {
                    methodScanBtn.addEventListener('click', () => {
                        entryMethodModal.classList.add('hidden');
                        isScanningFromCalendar = true; // カレンダー画面からのスキャン扱いにする
                        if (receiptUpload) receiptUpload.click();
                    });
                }
                const closeEntryMethod = () => entryMethodModal.classList.add('hidden');
                if (methodCancelBtn) methodCancelBtn.addEventListener('click', closeEntryMethod);
                if (entryMethodOverlay) entryMethodOverlay.addEventListener('click', closeEntryMethod);

                closeModalBtn.addEventListener('click', hideInputModal);

                // モーダルタブ
                tabExpense.addEventListener('click', () => showTab('expense'));
                tabDiary.addEventListener('click', () => showTab('diary'));

                // 保存
                saveBtn.addEventListener('click', handleSave);
                
                // 収支フォーム
                if (typeToggle) {
                    typeToggle.addEventListener('change', handleTypeToggleChange);
                }
                if (toggleExpenseBtn) {
                    toggleExpenseBtn.addEventListener('click', () => {
                        if (typeToggle.checked) {
                            typeToggle.checked = false;
                            typeToggle.dispatchEvent(new Event('change'));
                        } else {
                            updateTypeToggleUI();
                        }
                    });
                }
                if (toggleIncomeBtn) {
                    toggleIncomeBtn.addEventListener('click', () => {
                        if (!typeToggle.checked) {
                            typeToggle.checked = true;
                            typeToggle.dispatchEvent(new Event('change'));
                        } else {
                            updateTypeToggleUI();
                        }
                    });
                }

                // レシートスキャン
                if (scanReceiptBtn && receiptUpload) {
                    scanReceiptBtn.addEventListener('click', () => {
                        isScanningFromCalendar = false;
                        receiptUpload.click();
                    });
                }
                if (receiptUpload) {
                    receiptUpload.addEventListener('change', handleReceiptScan);
                }

                addTransactionBtn.addEventListener('click', handleAddTransaction); // 追加
                
                // 日記フォーム (写真)
                photoUpload.addEventListener('change', handlePhotoUpload);
                photoRemoveBtn.addEventListener('click', handlePhotoRemove);

                // 日記フィルター
                if (diaryFilterMood) {
                    diaryFilterMood.addEventListener('change', (event) => {
                        diaryFilters.mood = event.target.value;
                        renderDiaryList();
                    });
                }
                if (diaryFilterPhoto) {
                    diaryFilterPhoto.addEventListener('change', (event) => {
                        diaryFilters.photo = event.target.value;
                        renderDiaryList();
                    });
                }
                if (diaryFilterSearch) {
                    diaryFilterSearch.addEventListener('input', (event) => {
                        diaryFilters.search = event.target.value.trim().toLowerCase();
                        renderDiaryList();
                    });
                }

                if (toggleDiaryFiltersBtn) {
                    toggleDiaryFiltersBtn.addEventListener('click', toggleDiaryFilters);
                }
                if (diaryModeDiaryBtn && diaryModeFinanceBtn) {
                    diaryModeDiaryBtn.addEventListener('click', () => setDiaryMode(DIARY_MODES.diary));
                    diaryModeFinanceBtn.addEventListener('click', () => setDiaryMode(DIARY_MODES.finance));
                }
                if (diaryFinanceCategoryFilter) {
                    diaryFinanceCategoryFilter.addEventListener('change', (event) => {
                        financeFilters.category = event.target.value;
                        renderDiaryFinanceList();
                    });
                }
                if (diaryFinanceMinInput) {
                    diaryFinanceMinInput.addEventListener('input', (event) => {
                        financeFilters.min = event.target.value;
                        renderDiaryFinanceList();
                    });
                }
                if (diaryFinanceMaxInput) {
                    diaryFinanceMaxInput.addEventListener('input', (event) => {
                        financeFilters.max = event.target.value;
                        renderDiaryFinanceList();
                    });
                }

                if (monthYearHeader) {
                    monthYearHeader.addEventListener('click', openDatePicker);
                }
                if (datePickerOverlay) {
                    datePickerOverlay.addEventListener('click', closeDatePicker);
                }
                if (datePickerCloseBtn) {
                    datePickerCloseBtn.addEventListener('click', closeDatePicker);
                }
                if (datePickerCancelBtn) {
                    datePickerCancelBtn.addEventListener('click', closeDatePicker);
                }
                if (datePickerConfirmBtn) {
                    datePickerConfirmBtn.addEventListener('click', confirmDatePickerSelection);
                }
                if (datePickerYearMinus) {
                    datePickerYearMinus.addEventListener('click', () => adjustDatePickerYear(-1));
                }
                if (datePickerYearPlus) {
                    datePickerYearPlus.addEventListener('click', () => adjustDatePickerYear(1));
                }
                datePickerMonthButtons.forEach((btn) => {
                    btn.addEventListener('click', () => setDatePickerMonth(Number(btn.dataset.monthOption)));
                });

                if (googleLoginBtn) {
                    googleLoginBtn.addEventListener('click', handleGoogleLogin);
                }
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', handleLogout);
                }
                if (analysisAiButton) {
                    analysisAiButton.addEventListener('click', handleAnalysisAdviceRequest);
                }

                // テーマ・カテゴリ設定
                if (themeLightBtn) {
                    themeLightBtn.addEventListener('click', () => setThemePreference('light'));
                }
                if (themeDarkBtn) {
                    themeDarkBtn.addEventListener('click', () => setThemePreference('dark'));
                }
                if (monthlyBudgetSaveBtn) {
                    monthlyBudgetSaveBtn.addEventListener('click', handleBudgetSave);
                }
                if (monthlyBudgetClearBtn) {
                    monthlyBudgetClearBtn.addEventListener('click', handleBudgetClear);
                }
                if (monthlyBudgetInput) {
                    monthlyBudgetInput.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            handleBudgetSave();
                        }
                    });
                }

                if (categoryEditCancel) {
                    categoryEditCancel.addEventListener('click', closeCategoryEditModal);
                }
                if (categoryEditSave) {
                    categoryEditSave.addEventListener('click', confirmCategoryEdit);
                }
                if (categoryEditModal) {
                    categoryEditModal.addEventListener('click', (event) => {
                        if (event.target === categoryEditModal) {
                            closeCategoryEditModal();
                        }
                    });
                }
                if (categoryEditInput) {
                    categoryEditInput.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            confirmCategoryEdit();
                        }
                    });
                }
                if (recurringTypeSelect) {
                    recurringTypeSelect.addEventListener('change', updateRecurringCategoryOptions);
                }
                if (recurringScheduleType) {
                    recurringScheduleType.addEventListener('change', (event) => {
                        updateRecurringScheduleUI(event.target.value);
                    });
                }
                if (recurringWeekdayButtons.length) {
                    recurringWeekdayButtons.forEach((btn) => {
                        btn.addEventListener('click', () => {
                            btn.classList.toggle('active');
                            const isActive = btn.classList.contains('active');
                            btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                        });
                    });
                }
                if (recurringNoEndInput && recurringEndInput) {
                    recurringNoEndInput.addEventListener('change', () => {
                        if (recurringNoEndInput.checked) {
                            recurringEndInput.value = '';
                        }
                    });
                }
                if (recurringEndInput && recurringNoEndInput) {
                    recurringEndInput.addEventListener('input', () => {
                        if (recurringEndInput.value) {
                            recurringNoEndInput.checked = false;
                        }
                    });
                }
                if (recurringSaveBtn) {
                    recurringSaveBtn.addEventListener('click', handleRecurringSave);
                }
                if (recurringListContainer) {
                    recurringListContainer.addEventListener('click', (event) => {
                        const actionTarget = event.target.closest('[data-recurring-action]');
                        if (!actionTarget) return;
                        const action = actionTarget.dataset.recurringAction;
                        const id = actionTarget.dataset.recurringId;
                        if (action === 'delete') {
                            handleRecurringDelete(id);
                        } else if (action === 'edit') {
                            startRecurringEdit(id);
                        }
                    });
                }

                if (addExpenseCategoryBtn) {
                    addExpenseCategoryBtn.addEventListener('click', () => handleCategoryAdd('expense'));
                }
                if (addIncomeCategoryBtn) {
                    addIncomeCategoryBtn.addEventListener('click', () => handleCategoryAdd('income'));
                }
                if (expenseCategoryInput) {
                    expenseCategoryInput.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            handleCategoryAdd('expense');
                        }
                    });
                }
                if (incomeCategoryInput) {
                    incomeCategoryInput.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            handleCategoryAdd('income');
                        }
                    });
                }

                if (expenseCategoryList) {
                    expenseCategoryList.addEventListener('click', (event) => {
                        const target = event.target.closest('[data-category-action]');
                        if (!target) return;
                        const action = target.dataset.categoryAction;
                        const name = target.dataset.categoryName;
                        if (action === 'remove') {
                            handleCategoryRemove('expense', name);
                        } else if (action === 'move-up') {
                            handleCategoryMove('expense', name, -1);
                        } else if (action === 'move-down') {
                            handleCategoryMove('expense', name, 1);
                        } else if (action === 'edit') {
                            openCategoryEditModal('expense', name);
                        }
                    });
                }
                if (incomeCategoryList) {
                    incomeCategoryList.addEventListener('click', (event) => {
                        const target = event.target.closest('[data-category-action]');
                        if (!target) return;
                        const action = target.dataset.categoryAction;
                        const name = target.dataset.categoryName;
                        if (action === 'remove') {
                            handleCategoryRemove('income', name);
                        } else if (action === 'move-up') {
                            handleCategoryMove('income', name, -1);
                        } else if (action === 'move-down') {
                            handleCategoryMove('income', name, 1);
                        } else if (action === 'edit') {
                            openCategoryEditModal('income', name);
                        }
                    });
                }

                if (photoPreviewModalClose) {
                    photoPreviewModalClose.addEventListener('click', (event) => {
                        event.preventDefault();
                        closePhotoPreview();
                    });
                }
                if (photoPreviewModal) {
                    photoPreviewModal.addEventListener('click', (event) => {
                        if (event.target === photoPreviewModal) {
                            closePhotoPreview();
                        }
                    });
                }
                document.addEventListener('keydown', handleGlobalKeydown);
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape' && photoPreviewModal && !photoPreviewModal.classList.contains('hidden')) {
                        closePhotoPreview();
                    }
                });
            }
            
            // 収支追加処理 (連続入力用)
            function handleAddTransaction(resetForm = true) {
                const amount = parseInt(amountInput.value);
                if (!amount || amount <= 0) {
                    // 金額が0または未入力の場合は何もしない
                    if(resetForm) {
                         alert("金額を入力してください。"); // 将来的にカスタムアラートに置き換える
                    }
                    return false; // 追加されなかったことを示す
                }

                const record = getDayRecord(selectedDateStr);
                const transactionPayload = {
                    id: editingTransactionId || Date.now().toString(),
                    type: typeToggle.checked ? 'income' : 'expense',
                    amount,
                    category: categorySelect.value,
                    memo: memoInput.value,
                    createdAt: Date.now()
                };

                if (editingTransactionId) {
                    const index = record.transactions.findIndex(t => t.id === editingTransactionId);
                    if (index >= 0) {
                        transactionPayload.createdAt = record.transactions[index].createdAt || transactionPayload.createdAt;
                        transactionPayload.recurringId = record.transactions[index].recurringId;
                        record.transactions[index] = { ...record.transactions[index], ...transactionPayload };
                    } else {
                        record.transactions.push(transactionPayload);
                    }
                } else {
                    record.transactions.push(transactionPayload);
                }
                
                renderDailyTransactions(record.transactions);
                renderDiaryFinanceList();
                renderMonthSummary();
                if (currentView === 'analysis') {
                    renderAnalysis();
                }
                
                if (resetForm) {
                    amountInput.value = '';
                    memoInput.value = '';
                    editingTransactionId = null;
                    updateTransactionButtonLabel();
                }
                
                return true; // 追加または更新されたことを示す
            }

            // 保存処理 (モーダルを閉じる)
            async function handleSave() {
                // フォームに残っている収支があれば追加する
                handleAddTransaction(false); // リセットしない
                editingTransactionId = null;
                updateTransactionButtonLabel();

                const record = getDayRecord(selectedDateStr);

                // 日記保存
                record.diary.text = diaryTextInput.value;
                record.diary.mood = selectedMood;
                record.diary.photo = tempPhotoData;

                await saveRecords();
                
                // UI更新
                hideInputModal();
                renderCalendar(); // カレンダーのアイコン更新
                renderDiaryList(); // 日記一覧の更新
                renderDiaryFinanceList();
                if (currentView === 'analysis') {
                    renderAnalysis();
                }
            }

            // 収支削除
            async function handleDeleteTransaction(transactionId) {
                const record = getDayRecord(selectedDateStr);
                const target = record.transactions.find(t => t.id === transactionId);
                record.transactions = record.transactions.filter(t => t.id !== transactionId);
                if (target?.recurringId) {
                    markRecurringInstanceSkipped(target.recurringId, selectedDateStr);
                }
                if (editingTransactionId === transactionId) {
                    editingTransactionId = null;
                    updateTransactionButtonLabel();
                }
                await saveRecords();
                // 収支一覧を再描画
                renderDailyTransactions(record.transactions);
                renderDiaryFinanceList();
                renderMonthSummary();
                if (currentView === 'analysis') {
                    renderAnalysis();
                }
            }

            // レシートスキャン処理
            async function handleReceiptScan(event) {
                const file = event.target.files[0];
                if (!file) return;

                // UI Loading
                if (isScanningFromCalendar) {
                    showLoadingScreen('画像解析中...');
                } else {
                    scanReceiptBtn.classList.add('hidden');
                    scanLoading.classList.remove('hidden');
                }

                try {
                    // 画像をリサイズしてBase64化
                    const base64Data = await resizeImage(file, 1024);
                    
                    const matches = base64Data.match(/^data:(.+);base64,(.+)$/);
                    if (!matches) throw new Error('Invalid image data');

                    const mimeType = matches[1];
                    const image = matches[2];

                    // クライアントサイドから直接Gemini APIを呼び出す
                    // 配列が返ってくることを期待
                    const items = await analyzeReceiptWithGemini(image, mimeType);

                    if (!Array.isArray(items) || items.length === 0) {
                        throw new Error('有効なデータが見つかりませんでした。');
                    }

                    // 結果確認モーダルを表示
                    showScanResultModal(items);

                } catch (error) {
                    console.error('Scan Error:', error);
                    alert(`画像の読み取りに失敗しました: ${error.message}`);
                } finally {
                    // UI Reset
                    if (isScanningFromCalendar) {
                        hideLoadingScreen();
                        isScanningFromCalendar = false;
                    } else {
                        scanLoading.classList.add('hidden');
                        scanReceiptBtn.classList.remove('hidden');
                    }
                    receiptUpload.value = ''; // リセット
                }
            }
            
            function showScanResultModal(items) {
                scanResultList.innerHTML = '';
                // 空の配列対策
                if (!items || items.length === 0) {
                    addScanResultRow({});
                } else {
                    items.forEach(item => {
                        addScanResultRow(item);
                    });
                }
                scanResultModal.classList.remove('hidden');
            }

            function closeScanResultModal() {
                scanResultModal.classList.add('hidden');
            }

            function addScanResultRow(item = {}) {
                const row = document.createElement('div');
                row.className = 'flex gap-2 items-start bg-white p-3 rounded-lg border border-gray-200 shadow-sm transition-all hover:shadow-md';
                
                // 日付 (YYYY-MM-DD)
                // アイテムに日付がない場合は、現在選択中の日付(selectedDateStr)を初期値とする
                // selectedDateStrも未定義なら今日の日付
                const dateVal = item.date || selectedDateStr || formatDate(new Date());

                // 重複チェック
                let isDuplicate = false;
                let duplicateInfo = null;
                const record = records[dateVal];
                if (record && record.transactions) {
                    const itemAmount = parseInt(item.amount, 10);
                    if (!isNaN(itemAmount)) {
                        // 金額が一致する支出があるか確認
                        const found = record.transactions.find(t => 
                            t.type === 'expense' && 
                            t.amount === itemAmount
                        );
                        if (found) {
                            isDuplicate = true;
                            duplicateInfo = found;
                        }
                    }
                }
                
                // カテゴリ選択肢の生成と初期選択
                const predictedCategory = item.category || 'その他';
                const categoryOptions = appSettings.categories.expense.map(c => {
                    const isSelected = c === predictedCategory ? 'selected' : '';
                    return `<option value="${c}" ${isSelected}>${c}</option>`;
                }).join('');
                
                // "その他"がリストにない場合のフォールバック対応
                const otherSelected = !appSettings.categories.expense.includes(predictedCategory) ? 'selected' : '';

                // 重複アラートHTML
                const duplicateAlert = isDuplicate 
                    ? `<div class="text-xs text-orange-700 bg-orange-50 border border-orange-200 p-2 rounded mt-2 flex items-start gap-2">
                         <span class="text-lg leading-none">⚠️</span>
                         <span>
                           <strong>重複の可能性:</strong> 既存の記録と金額が一致しています。<br>
                           <span class="opacity-75">登録済: ¥${duplicateInfo.amount.toLocaleString()} (${duplicateInfo.category} / ${duplicateInfo.memo || 'メモなし'})</span>
                         </span>
                       </div>` 
                    : '';

                // 重複時はチェックを外す
                const checkState = isDuplicate ? '' : 'checked';

                row.innerHTML = `
                    <div class="pt-2">
                        <input type="checkbox" class="scan-check w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${checkState}>
                    </div>
                    <div class="flex-1 space-y-2 min-w-0">
                        <div class="flex gap-2">
                            <input type="date" class="scan-date w-full sm:w-32 py-1.5 px-2 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" value="${dateVal}">
                            <input type="text" class="scan-desc flex-1 py-1.5 px-2 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" placeholder="内容" value="${escapeHtml(item.description || '')}">
                        </div>
                        <div class="flex gap-2 items-center">
                            <span class="text-gray-500 text-xs">¥</span>
                            <input type="number" class="scan-amount w-24 sm:flex-1 py-1.5 px-2 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 font-bold" placeholder="金額" value="${item.amount || ''}">
                            <select class="scan-cat flex-1 sm:w-24 py-1.5 px-2 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 text-gray-600">
                                ${categoryOptions}
                                <option value="その他" ${otherSelected}>その他</option>
                            </select>
                            <button type="button" class="scan-remove text-gray-400 hover:text-red-500 p-1 rounded-full hover:bg-red-50 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                        ${duplicateAlert}
                    </div>
                `;
                
                // 削除ボタン
                row.querySelector('.scan-remove').addEventListener('click', () => {
                    row.remove();
                    if (scanResultList.children.length === 0) {
                        addScanResultRow(); // 最後の1行が消えたら空行を追加
                    }
                });

                scanResultList.appendChild(row);
            }

            async function saveScanResults() {
                const rows = Array.from(scanResultList.children);
                let savedCount = 0;

                for (const row of rows) {
                    const checkbox = row.querySelector('.scan-check');
                    if (!checkbox || !checkbox.checked) continue;

                    const dateInput = row.querySelector('.scan-date');
                    const descInput = row.querySelector('.scan-desc');
                    const amountInput = row.querySelector('.scan-amount');
                    const catInput = row.querySelector('.scan-cat');

                    const dateStr = dateInput.value;
                    const amount = parseInt(amountInput.value, 10);
                    const desc = descInput.value.trim();
                    const category = catInput.value;

                    if (!dateStr || isNaN(amount) || amount <= 0) continue;

                    // レコード保存
                    const record = getDayRecord(dateStr);
                    record.transactions.push({
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                        type: 'expense', // レシートは基本支出
                        amount: amount,
                        category: category,
                        memo: desc
                    });
                    savedCount++;
                }

                if (savedCount > 0) {
                    await saveRecords();
                    renderCalendar(); // カレンダー更新
                    renderAnalysis(); // 集計更新
                    // 現在のビューに応じて更新
                    if (currentView === 'diary') {
                        renderDiaryList();
                    } else if (currentView === 'calendar' && selectedDateStr) {
                         // もし現在選択中の日のデータが増えたならモーダル開け直す手もあるが、
                         // 今回はモーダル閉じてカレンダービューに戻るで良い
                    }
                    
                    closeScanResultModal();
                    alert(`${savedCount}件の明細を保存しました。`);
                } else {
                    alert('保存するデータがありません。金額と日付を確認してください。');
                }
            }

            // イベントリスナー (スキャン結果モーダル)
            if (scanResultClose) scanResultClose.addEventListener('click', closeScanResultModal);
            if (scanResultCancel) scanResultCancel.addEventListener('click', closeScanResultModal);
            if (scanResultAddRow) scanResultAddRow.addEventListener('click', () => addScanResultRow());
            if (scanResultSave) scanResultSave.addEventListener('click', saveScanResults);

            function resizeImage(file, maxDimension) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > maxDimension) {
                                    height *= maxDimension / width;
                                    width = maxDimension;
                                }
                            } else {
                                if (height > maxDimension) {
                                    width *= maxDimension / height;
                                    height = maxDimension;
                                }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            // JPEG形式、品質0.8で圧縮
                            resolve(canvas.toDataURL('image/jpeg', 0.8));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                });
            }

            // 写真アップロード処理
            function handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    tempPhotoData = e.target.result;
                    photoPreview.src = tempPhotoData;
                    photoPreview.classList.remove('hidden');
                    photoPreviewText.classList.add('hidden');
                    photoRemoveBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            // 写真削除処理
            function handlePhotoRemove() {
                tempPhotoData = null;
                photoPreview.src = '';
                photoPreview.classList.add('hidden');
                photoPreviewText.classList.remove('hidden');
                photoRemoveBtn.classList.add('hidden');
                photoUpload.value = null; // inputの値をリセット
            }

            // --- ヘルパー関数 ---
            // (古いformatDate関数は削除)

            // 短い日付フォーマット (M/D)
            function formatDate(date, format = 'long') {
                const y = date.getFullYear();
                const m = (date.getMonth() + 1).toString();
                const d = date.getDate().toString();
                if (format === 'short') {
                    return `${m}/${d}`;
                }
                // long (YYYY-MM-DD)
                return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
            }

            // 週の開始日（日曜）と終了日（土曜）を取得
            function getWeekRange(date) {
                const d = new Date(date);
                const dayOfWeek = d.getDay(); // 0 (Sun) - 6 (Sat)
                const startDate = new Date(d.setDate(d.getDate() - dayOfWeek));
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                
                return {
                    start: startDate,
                    end: endDate
                };
            }

            // --- 実行 ---
            initialize();
        });
    </script>
</body>
</html>
