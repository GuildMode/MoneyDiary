<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Diary</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

        <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ï¼ˆTailwindã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«åˆã‚ã›ã‚‹ï¼‰ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --color-bg: #f4f5f7;
            --color-panel: #ffffff;
            --color-panel-muted: #f2f3f7;
            --color-elevated: #edf1fb;
            --color-border: #dfe3ed;
            --color-border-strong: #ccd2df;
            --color-text: #111827;
            --color-text-muted: #6b7280;
            --color-accent: #5865f2;
            --color-accent-strong: #4752c4;
            --color-accent-soft: rgba(88, 101, 242, 0.12);
            --color-income: #3b82f6;
            --color-expense: #ef4444;
            --color-income-muted: rgba(59, 130, 246, 0.12);
            --color-expense-muted: rgba(239, 68, 68, 0.15);
            --color-overlay: rgba(9, 11, 16, 0.8);
        }

        body.dark-mode {
            --color-bg: #050b1f;
            --color-panel: #0f1b34;
            --color-panel-muted: #1a2643;
            --color-elevated: #142147;
            --color-border: #1f2a45;
            --color-border-strong: #2f3a5c;
            --color-text: #f8fafc;
            --color-text-muted: #94a3b8;
            --color-accent: #a78bfa;
            --color-accent-strong: #7c3aed;
            --color-accent-soft: rgba(167, 139, 250, 0.2);
            --color-income: #38bdf8;
            --color-expense: #f472b6;
            --color-income-muted: rgba(56, 189, 248, 0.18);
            --color-expense-muted: rgba(244, 114, 182, 0.2);
            --color-overlay: rgba(5, 7, 12, 0.9);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color 0.25s ease, color 0.25s ease;
        }
        body.dark-mode {
            color-scheme: dark;
        }

        body.auth-locked,
        body.date-picker-locked {
            overflow: hidden;
            height: 100vh;
            touch-action: none;
        }

        #app-container {
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
            background-color: var(--color-panel);
        }

        #main-content {
            height: calc(100vh - 60px - var(--safe-area-inset-top) - var(--safe-area-inset-bottom));
            background-color: transparent;
        }

        #bottom-nav {
            height: calc(60px + var(--safe-area-inset-bottom));
            padding-bottom: var(--safe-area-inset-bottom);
            background-color: var(--color-panel);
            border-top: 1px solid var(--color-border);
            box-shadow: 0 -8px 25px rgba(15, 23, 42, 0.1);
        }

        body.dark-mode .text-gray-800,
        body.dark-mode .text-gray-700 {
            color: var(--color-text) !important;
        }
        body.dark-mode .text-gray-600,
        body.dark-mode .text-gray-500 {
            color: var(--color-text-muted) !important;
        }
        body.dark-mode .bg-gray-100,
        body.dark-mode .bg-gray-50 {
            background-color: var(--color-panel-muted) !important;
        }
        body.dark-mode .bg-white {
            background-color: var(--color-panel) !important;
        }
        body.dark-mode .border-gray-200,
        body.dark-mode .border-gray-300 {
            border-color: var(--color-border) !important;
        }

        #month-year-header {
            background: transparent;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            color: inherit;
            cursor: pointer;
        }
        #month-year-header:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.35);
            border-radius: 0.5rem;
        }

        .date-picker-card {
            background-color: var(--color-panel);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.35);
        }
        body.dark-mode .date-picker-card {
            box-shadow: 0 30px 70px rgba(2, 6, 23, 0.85);
        }
        .date-picker-months button {
            background-color: var(--color-panel-muted);
            color: var(--color-text);
            border: 1px solid transparent;
            border-radius: 0.85rem;
            padding: 0.65rem 0;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .date-picker-months button.active {
            background: linear-gradient(135deg, var(--color-accent), var(--color-accent-strong));
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 12px 30px rgba(88, 101, 242, 0.35);
        }

        .date-picker-year-btn {
            background-color: var(--color-panel-muted);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .date-picker-year-btn:hover {
            background-color: var(--color-elevated);
        }

        .date-picker-input {
            padding: 0.8rem 1.25rem;
            border-radius: 0.9rem;
            border: 1px solid var(--color-border);
            background-color: var(--color-panel-muted);
            color: var(--color-text);
            font-size: 1.15rem;
            font-weight: 600;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .date-picker-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.35);
        }

        .date-picker-secondary {
            background-color: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .date-picker-secondary:hover {
            background-color: var(--color-panel-muted);
            color: var(--color-text);
        }

        .date-picker-primary {
            background: linear-gradient(135deg, var(--color-accent), var(--color-accent-strong));
            color: #ffffff;
            font-weight: 600;
            border: none;
            box-shadow: 0 15px 30px rgba(88, 101, 242, 0.35);
            transition: filter 0.2s ease;
        }
        .date-picker-primary:hover {
            filter: brightness(1.05);
        }

        body.dark-mode #logout-btn {
            background-color: var(--color-panel-muted) !important;
            color: var(--color-text) !important;
            border: 1px solid var(--color-border) !important;
        }

        .summary-card {
            background-color: var(--color-panel);
            border-radius: 0.9rem;
            border: 1px solid var(--color-border);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }
        .analysis-card {
            background-color: var(--color-panel);
            border-radius: 1rem;
            border: 1px solid var(--color-border);
            box-shadow: 0 15px 40px rgba(15, 23, 42, 0.12);
        }
        .analysis-card h4,
        .summary-card h3,
        .analysis-card p {
            color: var(--color-text);
        }

        #summary-income,
        #analysis-income {
            color: var(--color-income);
        }
        #summary-expense,
        #analysis-expense {
            color: var(--color-expense);
        }
        #summary-balance,
        #analysis-balance {
            color: var(--color-text);
        }

        #diary-filter-panel,
        #settings-view .bg-white {
            background-color: var(--color-panel);
            border: 1px solid var(--color-border);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }

        input,
        select,
        textarea {
            background-color: var(--color-panel);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }
        input::placeholder,
        textarea::placeholder {
            color: var(--color-text-muted);
        }

        #input-modal {
            background-color: var(--color-panel);
            color: var(--color-text);
            box-shadow: 0 18px 60px rgba(15, 23, 42, 0.35);
        }
        #input-modal header {
            border-color: var(--color-border);
        }
        #input-modal input,
        #input-modal select,
        #input-modal textarea {
            background-color: var(--color-panel-muted);
            border-color: var(--color-border);
        }

        #type-toggle-control {
            border: 1px solid var(--color-border);
            background-color: var(--color-panel-muted) !important;
            transition: background-color 0.2s ease;
        }
        #type-toggle-control.mode-income {
            background-color: var(--color-income-muted) !important;
        }
        #type-toggle-control.mode-expense {
            background-color: var(--color-expense-muted) !important;
        }

        #toggle-expense,
        #toggle-income {
            background: transparent !important;
            color: var(--color-text-muted) !important;
            border-radius: 9999px;
            transition: all 0.2s ease;
        }
        #toggle-expense.active,
        #toggle-income.active {
            background-color: var(--color-panel) !important;
            color: var(--color-accent) !important;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.18);
        }
        #toggle-expense.active {
            color: var(--color-expense) !important;
        }
        #toggle-income.active {
            color: var(--color-income) !important;
        }

        #add-transaction-btn {
            background: linear-gradient(135deg, var(--color-accent), var(--color-accent-strong)) !important;
            color: #ffffff !important;
            border: none;
            box-shadow: 0 15px 30px rgba(88, 101, 242, 0.35);
        }
        #add-transaction-btn:hover {
            filter: brightness(1.05);
        }

        #daily-transactions li {
            background-color: var(--color-panel-muted) !important;
            border: 1px solid var(--color-border);
        }

        .category-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background-color: var(--color-panel-muted);
            color: var(--color-text);
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.85rem;
        }
        .category-chip button {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            border: none;
            background: transparent;
            color: inherit;
            cursor: pointer;
            line-height: 1;
        }

        .diary-card {
            background-color: var(--color-panel);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .diary-card:hover {
            transform: translateY(-2px);
            background-color: var(--color-panel-muted);
        }

        .filter-toggle-btn {
            width: 42px;
            height: 42px;
            border-radius: 9999px;
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-panel);
            box-shadow: 0 5px 20px rgba(15, 23, 42, 0.15);
            transition: all 0.2s ease;
        }
        .filter-toggle-btn.active {
            background-color: var(--color-accent-soft);
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .photo-modal-overlay {
            background: var(--color-overlay);
            z-index: 60;
        }
        .photo-modal-content {
            background-color: #000;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .calendar-day {
            aspect-ratio: 1 / 1;
        }
        .calendar-day.other-month {
            opacity: 0.3;
        }

        #input-modal-content {
            max-height: calc(100vh - 120px);
        }
        
        .mood-icon.selected {
            transform: scale(1.1);
            background-color: var(--color-accent-soft);
        }

        #auth-screen {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            background: var(--color-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.25rem;
            padding: 2rem;
            text-align: center;
            z-index: 50;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        #auth-screen.hidden {
            display: none;
        }
        #auth-screen button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ã‚¢ãƒ—ãƒªå…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚¹ãƒãƒ›å¹…ã«åˆ¶é™ï¼‰ -->
    <div id="app-container" class="max-w-md mx-auto h-screen bg-white flex flex-col overflow-hidden relative">

        <!-- 1. ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <main id="main-content" class="flex-grow overflow-y-auto">
            
            <!-- 1-1. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ -->
            <div id="calendar-view" class
="p-4 space-y-4">
                <!-- ãƒ˜ãƒƒãƒ€ãƒ¼: æœˆç§»å‹• -->
                <div class="flex justify-between items-center px-2">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <button type="button" id="month-year-header" aria-label="å¹´æœˆã‚’é¸æŠ" class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span id="month-year-header-text"></span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="calendar-grid text-center text-sm font-medium text-gray-500">
                    <div class="text-red-500">æ—¥</div>
                    <div>æœˆ</div>
                    <div>ç«</div>
                    <div>æ°´</div>
                    <div>æœ¨</div>
                    <div>é‡‘</div>
                    <div class="text-blue-500">åœŸ</div>
                </div>

                <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ -->
                <div id="calendar-grid-body" class="calendar-grid">
                    <!-- JSã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>

                <!-- æœˆæ¬¡ã‚µãƒãƒªãƒ¼ -->
                <div class="space-y-2 p-4 summary-card">
                    <h3 class="text-lg font-semibold text-gray-700">ä»Šæœˆã®ã‚µãƒãƒªãƒ¼</h3>
                    <div class="flex justify-around text-center">
                        <div>
                            <span class="text-sm text-gray-500">åå…¥</span>
                            <p id="summary-income" class="text-lg font-bold text-blue-600">Â¥0</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">æ”¯å‡º</span>
                            <p id="summary-expense" class="text-lg font-bold text-red-600">Â¥0</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">åæ”¯</span>
                            <p id="summary-balance" class="text-lg font-bold text-gray-800">Â¥0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 1-2. é›†è¨ˆãƒ“ãƒ¥ãƒ¼ -->
            <div id="analysis-view" class="hidden p-4 space-y-4">
                <h2 class="text-xl font-bold text-gray-800 px-2">é›†è¨ˆãƒ»åˆ†æ</h2>

                <!-- é€±/æœˆ/å¹´ ã‚¿ãƒ– -->
                <div class="flex rounded-lg bg-gray-100 p-1">
                    <button id="tab-week" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-600">é€±</button>
                    <button id="tab-month" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white shadow text-blue-600">æœˆ</button>
                    <button id="tab-year" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-600">å¹´</button>
                </div>
                
                <!-- æ—¥ä»˜/æœŸé–“ ç§»å‹• -->
                <div class="flex justify-between items-center px-2">
                    <button id="prev-period-analysis-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h3 id="month-year-analysis-header" class="text-lg font-semibold text-gray-700"></h3>
                    <button id="next-period-analysis-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <!-- æœŸé–“ã‚µãƒãƒªãƒ¼ -->
                <div class="grid grid-cols-3 gap-2">
                    <div class="summary-card p-3 text-center">
                        <p class="text-xs text-gray-500">åå…¥</p>
                        <p id="analysis-income" class="text-lg font-bold text-blue-600">Â¥0</p>
                    </div>
                    <div class="summary-card p-3 text-center">
                        <p class="text-xs text-gray-500">æ”¯å‡º</p>
                        <p id="analysis-expense" class="text-lg font-bold text-red-600">Â¥0</p>
                    </div>
                    <div class="summary-card p-3 text-center">
                        <p class="text-xs text-gray-500">åæ”¯</p>
                        <p id="analysis-balance" class="text-lg font-bold text-gray-800">Â¥0</p>
                    </div>
                </div>

                <!-- æ”¯å‡ºã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰ -->
                <div class="analysis-card p-4">
                    <h4 class="text-md font-semibold text-gray-700 mb-2">æ”¯å‡ºã‚«ãƒ†ã‚´ãƒªãƒ¼</h4>
                    <div class="w-full max-w-xs mx-auto">
                        <canvas id="expense-chart"></canvas>
                    </div>
                </div>
                
                <!-- åæ”¯æ¨ç§»ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰ -->
                <div class="analysis-card p-4">
                    <h4 id="balance-chart-title" class="text-md font-semibold text-gray-700 mb-2">ä»Šæœˆã®æ—¥åˆ¥åæ”¯</h4>
                    <div class="w-full mx-auto">
                        <canvas id="balance-chart"></canvas>
                    </div>
                </div>

                <!-- AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ -->
                <div class="analysis-card p-4 space-y-3">
                    <div class="flex items-center justify-between gap-3">
                        <div>
                            <h4 class="text-md font-semibold text-gray-700">AIã«ã‚ˆã‚‹åæ”¯ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h4>
                            <p class="text-xs text-gray-500">GeminiãŒæœŸé–“å†…ã®å‚¾å‘ã‚’åˆ†æã—ã¾ã™</p>
                        </div>
                        <button id="analysis-ai-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-500 transition">AIã«èã</button>
                    </div>
                    <div id="analysis-ai-output" class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg min-h-[80px] whitespace-pre-wrap">æœŸé–“ã‚’é¸æŠã—ã¦ã€ŒAIã«èãã€ã‚’æŠ¼ã™ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
                </div>
            </div>

            <!-- 1-3. æ—¥è¨˜ãƒ“ãƒ¥ãƒ¼ -->
            <div id="diary-view" class="hidden p-4 space-y-4">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-xl font-bold text-gray-800">æ—¥è¨˜</h2>
                    <button id="toggle-diary-filters" class="filter-toggle-btn" aria-expanded="false" aria-label="æ—¥è¨˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆ">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707l-5.414 5.414A1 1 0 0015 12v5l-2 2-2-2v-5a1 1 0 00-.293-.707L5.293 6.707A1 1 0 015 6V4z"></path></svg>
                    </button>
                </div>

                <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div id="diary-filter-panel" class="bg-white p-4 rounded-lg shadow-sm space-y-3 hidden">
                    <div>
                        <label for="diary-filter-mood" class="text-sm font-medium text-gray-600">æ°—åˆ†</label>
                        <select id="diary-filter-mood" class="w-full mt-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                            <option value="all">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    <div>
                        <label for="diary-filter-photo" class="text-sm font-medium text-gray-600">å†™çœŸ</label>
                        <select id="diary-filter-photo" class="w-full mt-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                            <option value="all">ã™ã¹ã¦</option>
                            <option value="with">å†™çœŸã‚ã‚Š</option>
                            <option value="without">å†™çœŸãªã—</option>
                        </select>
                    </div>
                    <div>
                        <label for="diary-filter-search" class="text-sm font-medium text-gray-600">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="search" id="diary-filter-search" placeholder="ä¾‹: æ¥½ã—ã‹ã£ãŸ" class="w-full mt-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    </div>
                </div>

                <!-- æ—¥è¨˜ãƒªã‚¹ãƒˆ -->
                <div id="diary-list" class="space-y-3 pb-24">
                    <!-- JSã§å‹•çš„ã«è¡¨ç¤º -->
                </div>
            </div>

            <!-- 1-4. è¨­å®šãƒ“ãƒ¥ãƒ¼ -->
            <div id="settings-view" class="hidden p-4 space-y-4">
                <h2 class="text-xl font-bold text-gray-800 px-2">è¨­å®š</h2>

                <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ± -->
                <div class="bg-white p-4 rounded-lg shadow-sm flex items-center justify-between gap-4">
                    <div class="flex items-center gap-3 text-left">
                        <img id="account-photo" src="" alt="Avatar" class="w-12 h-12 rounded-full object-cover bg-gray-200 hidden">
                        <div>
                            <p id="account-name" class="text-md font-semibold text-gray-800">æœªãƒ­ã‚°ã‚¤ãƒ³</p>
                            <p id="account-email" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                    <button id="logout-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>

                <!-- ãƒ†ãƒ¼ãƒè¨­å®š -->
                <div class="bg-white p-4 rounded-lg shadow-sm space-y-3">
                    <div>
                        <h3 class="text-md font-semibold text-gray-800">ãƒ†ãƒ¼ãƒ</h3>
                        <p class="text-sm text-gray-500">ãƒ©ã‚¤ãƒˆ / ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã§ãã¾ã™</p>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">ãƒ©ã‚¤ãƒˆ</span>
                        <label for="theme-toggle" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="theme-toggle" class="sr-only peer">
                            <div class="w-16 h-8 bg-gray-300 rounded-full peer-checked:bg-blue-500 transition-colors duration-300"></div>
                            <div class="absolute left-1 top-1 w-6 h-6 bg-white rounded-full shadow transition-transform duration-300 peer-checked:translate-x-8"></div>
                        </label>
                        <span class="text-sm text-gray-600">ãƒ€ãƒ¼ã‚¯</span>
                    </div>
                </div>

                <!-- æ”¯å‡ºã‚«ãƒ†ã‚´ãƒªç®¡ç† -->
                <div class="bg-white p-4 rounded-lg shadow-sm space-y-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-md font-semibold text-gray-800">æ”¯å‡ºã‚«ãƒ†ã‚´ãƒª</h3>
                            <p class="text-sm text-gray-500">ã‚ˆãä½¿ã†åˆ†é¡ã‚’æ•´ç†ã—ã¾ã—ã‚‡ã†</p>
                        </div>
                        <span class="text-xs text-gray-500" id="expense-category-count"></span>
                    </div>
                    <div id="expense-category-list" class="flex flex-wrap gap-2"></div>
                    <div class="flex gap-2">
                        <input type="text" id="expense-category-input" placeholder="ã‚«ãƒ†ã‚´ãƒªå" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                        <button id="add-expense-category" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">è¿½åŠ </button>
                    </div>
                </div>

                <!-- åå…¥ã‚«ãƒ†ã‚´ãƒªç®¡ç† -->
                <div class="bg-white p-4 rounded-lg shadow-sm space-y-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-md font-semibold text-gray-800">åå…¥ã‚«ãƒ†ã‚´ãƒª</h3>
                            <p class="text-sm text-gray-500">å¿…è¦ã«å¿œã˜ã¦é …ç›®ã‚’è¿½åŠ ã§ãã¾ã™</p>
                        </div>
                        <span class="text-xs text-gray-500" id="income-category-count"></span>
                    </div>
                    <div id="income-category-list" class="flex flex-wrap gap-2"></div>
                    <div class="flex gap-2">
                        <input type="text" id="income-category-input" placeholder="ã‚«ãƒ†ã‚´ãƒªå" class="flex-1 py-2 px-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                        <button id="add-income-category" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">è¿½åŠ </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- 2. ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav id="bottom-nav" class="w-full max-w-md mx-auto bg-white border-t border-gray-200 flex justify-around items-center fixed bottom-0">
            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ -->
            <button id="nav-calendar" class="text-blue-600 p-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                <span class="text-xs">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
            </button>

            <!-- æ—¥è¨˜ãƒœã‚¿ãƒ³ -->
            <button id="nav-diary" class="text-gray-500 p-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M6 4a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2V6a2 2 0 00-2-2H6zm0 2h8v8H6V6zm2 1v6l4-3-4-3z"></path></svg>
                <span class="text-xs">æ—¥è¨˜</span>
            </button>
            
            <!-- æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ -->
            <button id="add-new-btn" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg -mt-8 flex justify-center items-center">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            </button>
            
            <!-- é›†è¨ˆãƒœã‚¿ãƒ³ -->
            <button id="nav-analysis" class="text-gray-500 p-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path></svg>
                <span class="text-xs">é›†è¨ˆ</span>
            </button>

            <!-- è¨­å®šãƒœã‚¿ãƒ³ -->
            <button id="nav-settings" class="text-gray-500 p-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.983 2.21a1 1 0 00-1.966 0l-.2.995a1 1 0 01-.993.802H8.11a1 1 0 00-.936.648l-.342.94a1 1 0 01-.857.648l-1.017.073a1 1 0 00-.887.63l-.342.939a1 1 0 000 .71l.342.94a1 1 0 00.887.63l1.017.073a1 1 0 01.857.648l.342.94a1 1 0 00.936.647h.714a1 1 0 01.993.803l.2.994a1 1 0 001.966 0l.2-.994a1 1 0 01.993-.803h.714a1 1 0 00.936-.648l.342-.94a1 1 0 01.857-.648l1.017-.073a1 1 0 00.887-.63l.342-.94a1 1 0 000-.71l-.342-.939a1 1 0 00-.887-.63l-1.017-.073a1 1 0 01-.857-.648l-.342-.94a1 1 0 00-.936-.648h-.714a1 1 0 01-.993-.802l-.2-.995zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path></svg>
                <span class="text-xs">è¨­å®š</span>
            </button>
        </nav>

        <!-- èªè¨¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
        <div id="auth-screen" class="px-6 text-center space-y-4">
            <div class="space-y-2">
                <h1 class="text-2xl font-bold text-gray-800">Money Diary</h1>
                <p id="auth-message" class="text-sm text-gray-500">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã€ã‚ãªãŸå°‚ç”¨ã®å®¶è¨ˆç°¿ã‚’ã¯ã˜ã‚ã¾ã—ã‚‡ã†ã€‚</p>
            </div>
            <button id="google-login-btn" class="bg-blue-600 text-white px-6 py-3 rounded-full text-sm font-semibold shadow-lg hover:bg-blue-500 transition-colors">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            <p id="auth-config-warning" class="text-xs text-red-400 hidden">Firebaseæ§‹æˆã‚’è¨­å®šã™ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚</p>
        </div>

    </div>

    <!-- 3. å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="input-modal" class="hidden fixed inset-0 max-w-md mx-auto h-screen bg-white flex flex-col z-50">
        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="flex justify-between items-center p-4 border-b border-gray-200">
            <button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-100">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 id="modal-date-header" class="text-lg font-bold text-gray-800"></h2>
            <button id="save-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">ä¿å­˜</button>
        </header>

        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="input-modal-content" class="flex-grow p-4 overflow-y-auto space-y-4">
            <!-- åæ”¯ãƒ»æ—¥è¨˜ã‚¿ãƒ– -->
            <div class="flex rounded-lg bg-gray-100 p-1">
                <button id="tab-expense" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white shadow text-blue-600">åæ”¯</button>
                <button id="tab-diary" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-600">æ—¥è¨˜</button>
            </div>

            <!-- åæ”¯å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="expense-form" class="space-y-4">
                <!-- åå…¥/æ”¯å‡º ãƒˆã‚°ãƒ« -->
                <div class="flex items-center justify-center">
                    <input type="checkbox" id="type-toggle" class="sr-only" />
                    <div id="type-toggle-control" class="grid grid-cols-2 gap-1 bg-red-100 rounded-full p-1 w-48">
                        <button type="button" id="toggle-expense" class="py-2 rounded-full text-sm font-semibold text-red-600 bg-white shadow">æ”¯å‡º</button>
                        <button type="button" id="toggle-income" class="py-2 rounded-full text-sm font-semibold text-gray-500">åå…¥</button>
                    </div>
                </div>

                <!-- é‡‘é¡ -->
                <div>
                    <label for="amount" class="text-sm font-medium text-gray-700">é‡‘é¡</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">Â¥</span>
                        <input type="number" id="amount" placeholder="0" class="w-full pl-8 pr-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-2xl font-bold">
                    </div>
                </div>

                <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ -->
                <div>
                    <label for="category" class="text-sm font-medium text-gray-700">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                    <select id="category" class="w-full mt-1 py-3 px-4 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option>é£Ÿè²»</option>
                        <option>äº¤é€šè²»</option>
                        <option>æ—¥ç”¨å“</option>
                        <option>è¶£å‘³</option>
                        <option>äº¤éš›è²»</option>
                        <option>å›ºå®šè²»</option>
                        <option>ãã®ä»–</option>
                        <option class="text-green-600" value="income-salary">çµ¦ä¸</option>
                        <option class="text-green-600" value="income-other">ãã®ä»–åå…¥</option>
                    </select>
                </div>

                <!-- ãƒ¡ãƒ¢ -->
                <div>
                    <label for="memo" class="text-sm font-medium text-gray-700">ãƒ¡ãƒ¢</label>
                    <input type="text" id="memo" placeholder="ï¼ˆä»»æ„ï¼‰ä¾‹: ã€‡ã€‡ã‚¹ãƒ¼ãƒ‘ãƒ¼" class="w-full mt-1 py-3 px-4 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- åæ”¯è¿½åŠ ãƒœã‚¿ãƒ³ -->
                <div>
                    <button id="add-transaction-btn" class="w-full bg-blue-100 text-blue-700 py-3 rounded-lg font-medium hover:bg-blue-200 transition-colors">
                        ã“ã®åæ”¯ã‚’è¿½åŠ 
                    </button>
                </div>

                <!-- ãã®æ—¥ã®åæ”¯ä¸€è¦§ -->
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">ã“ã®æ—¥ã®åæ”¯</h4>
                    <ul id="daily-transactions" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                    </ul>
                </div>
            </div>

            <!-- æ—¥è¨˜å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="diary-form" class="hidden space-y-4">
                <!-- æ„Ÿæƒ… -->
                <div>
                    <label class="text-sm font-medium text-gray-700">ä»Šæ—¥ã®æ°—åˆ†</label>
                    <div id="mood-selector" class="flex justify-around mt-2">
                        <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- æ—¥è¨˜æœ¬æ–‡ -->
                <div>
                    <label for="diary-text" class="text-sm font-medium text-gray-700">æ—¥è¨˜</label>
                    <textarea id="diary-text" rows="5" placeholder="ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚„æ„Ÿæƒ³..." class="w-full mt-1 p-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>

                <!-- å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                <div>
                    <label class="text-sm font-medium text-gray-700">å†™çœŸ (1æšã¾ã§)</label>
                    <div class="mt-1">
                        <input type="file" id="photo-upload" class="hidden" accept="image/*">
                        <label for="photo-upload" class="cursor-pointer w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex justify-center items-center text-gray-500 hover:bg-gray-50">
                            <span id="photo-preview-text">
                                <svg class="w-10 h-10 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01M3 10a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V10z"></path></svg>
                                å†™çœŸã‚’é¸æŠ
                            </span>
                            <img id="photo-preview" src="" class="hidden w-full h-full object-cover rounded-lg">
                        </label>
                        <button id="photo-remove-btn" class="hidden text-sm text-red-500 mt-1">å†™çœŸã‚’å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="photo-preview-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 photo-modal-overlay">
        <div class="photo-modal-content relative rounded-lg overflow-hidden max-w-md w-full">
            <button id="photo-preview-close" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <img id="photo-preview-image" src="" alt="æ—¥è¨˜å†™çœŸ" class="w-full max-h-[80vh] object-contain bg-black">
        </div>
    </div>

    <!-- å¹´æœˆã‚¸ãƒ£ãƒ³ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="date-picker-modal" class="hidden fixed inset-0 flex items-center justify-center px-4">
        <div id="date-picker-overlay" class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="relative z-10 w-full max-w-md">
            <div class="date-picker-card">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <p class="text-xs uppercase tracking-wide text-gray-500">ã‚¸ãƒ£ãƒ³ãƒ—</p>
                        <h3 class="text-lg font-semibold text-gray-800">å¹´æœˆã‚’é¸æŠ</h3>
                    </div>
                    <button id="date-picker-close" class="date-picker-secondary rounded-full p-2" aria-label="é–‰ã˜ã‚‹">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="space-y-5">
                    <div>
                        <label for="date-picker-year" class="text-sm font-medium text-gray-700">å¹´</label>
                        <div class="flex items-center gap-3 mt-2">
                            <button type="button" id="date-picker-year-minus" class="date-picker-year-btn" aria-label="å‰å¹´ã¸">âˆ’</button>
                            <input type="number" id="date-picker-year" class="date-picker-input flex-1" min="1900" max="3000" />
                            <button type="button" id="date-picker-year-plus" class="date-picker-year-btn" aria-label="æ¬¡ã®å¹´ã¸">ï¼‹</button>
                        </div>
                    </div>

                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2">æœˆ</p>
                        <div class="date-picker-months grid grid-cols-3 gap-2">
                            <button type="button" data-month-option="0">1æœˆ</button>
                            <button type="button" data-month-option="1">2æœˆ</button>
                            <button type="button" data-month-option="2">3æœˆ</button>
                            <button type="button" data-month-option="3">4æœˆ</button>
                            <button type="button" data-month-option="4">5æœˆ</button>
                            <button type="button" data-month-option="5">6æœˆ</button>
                            <button type="button" data-month-option="6">7æœˆ</button>
                            <button type="button" data-month-option="7">8æœˆ</button>
                            <button type="button" data-month-option="8">9æœˆ</button>
                            <button type="button" data-month-option="9">10æœˆ</button>
                            <button type="button" data-month-option="10">11æœˆ</button>
                            <button type="button" data-month-option="11">12æœˆ</button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="date-picker-cancel" class="px-4 py-2 rounded-lg date-picker-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" id="date-picker-confirm" class="px-4 py-2 rounded-lg date-picker-primary">ç§»å‹•</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- çŠ¶æ…‹ç®¡ç† ---

            // å®šæ•°
            const FIREBASE_CONFIG = {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };
            const isFirebaseConfigured = FIREBASE_CONFIG.apiKey && !FIREBASE_CONFIG.apiKey.includes('YOUR_API_KEY');
            const GEMINI_API_BASE = 'https://generativelanguage.googleapis.com';
            const GEMINI_API_VERSION = 'v1beta';
            const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY';
            const GEMINI_PREFERRED_MODELS = [
                'models/gemini-1.5-flash-latest',
                'models/gemini-1.5-flash-002',
                'models/gemini-1.5-flash',
                'models/gemini-1.5-flash-8b-latest',
                'models/gemini-1.5-pro-latest',
                'models/gemini-1.5-pro',
                'models/gemini-1.0-pro',
                'models/gemini-1.0-pro-001',
                'models/gemini-pro'
            ];
            let geminiModelOrderCache = null;
            const isGeminiConfigured = GEMINI_API_KEY && !GEMINI_API_KEY.includes('YOUR_GEMINI_API_KEY');
            const MOODS = ['ğŸ˜„', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜¡']; // 5æ®µéšã«å¤‰æ›´
            const DEFAULT_CATEGORIES = {
                expense: ['é£Ÿè²»', 'äº¤é€šè²»', 'æ—¥ç”¨å“', 'è¶£å‘³', 'äº¤éš›è²»', 'å›ºå®šè²»', 'ãã®ä»–'],
                income: ['çµ¦ä¸', 'ãã®ä»–åå…¥']
            };
            const SETTINGS_KEY = 'moneyDiarySettings';

            let currentView = 'calendar'; // 'calendar' | 'analysis' | 'diary' | 'settings'
            let currentAnalysisView = 'month'; // 'week', 'month', 'year'
            let currentDate = new Date(); // è¡¨ç¤ºç”¨ã®ç¾åœ¨æœˆãƒ»é€±ãƒ»å¹´
            let selectedDateStr = formatDate(new Date()); // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ (YYYY-MM-DD)
            let records = {}; // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
            let tempPhotoData = null; // ä¸€æ™‚çš„ãªå†™çœŸãƒ‡ãƒ¼ã‚¿(Base64)
            let selectedMood = null; // é¸æŠä¸­ã®æ„Ÿæƒ…
            let diaryFilters = { mood: 'all', photo: 'all', search: '' };
            let appSettings = {
                theme: 'light',
                categories: {
                    expense: [...DEFAULT_CATEGORIES.expense],
                    income: [...DEFAULT_CATEGORIES.income]
                }
            };
            let isDiaryFilterOpen = false;
            let firebaseApp = null;
            let auth = null;
            let db = null;
            let currentUser = null;
            const STORAGE_BASE_KEY = 'moneyDiaryRecords';
            const USER_AGENT = typeof navigator !== 'undefined' ? navigator.userAgent || '' : '';
            const IS_MOBILE_DEVICE = /Android|iPhone|iPad|iPod/i.test(USER_AGENT);
            const IS_IOS = /iPad|iPhone|iPod/i.test(USER_AGENT);
            let pendingDatePickerMonth = null;

            // ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
            let expenseChartInstance = null;
            let balanceChartInstance = null;

            // --- DOMè¦ç´  ---
            const calendarView = document.getElementById('calendar-view');
            const analysisView = document.getElementById('analysis-view');
            const diaryView = document.getElementById('diary-view');
            const settingsView = document.getElementById('settings-view');
            const navCalendar = document.getElementById('nav-calendar');
            const navAnalysis = document.getElementById('nav-analysis');
            const navDiary = document.getElementById('nav-diary');
            const navSettings = document.getElementById('nav-settings');
            const addNewBtn = document.getElementById('add-new-btn');
            const inputModal = document.getElementById('input-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const saveBtn = document.getElementById('save-btn');
            const modalDateHeader = document.getElementById('modal-date-header');
            const tabExpense = document.getElementById('tab-expense');
            const tabDiary = document.getElementById('tab-diary');
            const expenseForm = document.getElementById('expense-form');
            const diaryForm = document.getElementById('diary-form');
            const typeToggle = document.getElementById('type-toggle');
            const typeToggleControl = document.getElementById('type-toggle-control');
            const toggleExpenseBtn = document.getElementById('toggle-expense');
            const toggleIncomeBtn = document.getElementById('toggle-income');
            const amountInput = document.getElementById('amount');
            const categorySelect = document.getElementById('category');
            const memoInput = document.getElementById('memo');
            const addTransactionBtn = document.getElementById('add-transaction-btn'); // è¿½åŠ 
            const dailyTransactionsList = document.getElementById('daily-transactions');
            const moodSelector = document.getElementById('mood-selector');
            const diaryTextInput = document.getElementById('diary-text');
            const photoUpload = document.getElementById('photo-upload');
            const photoPreview = document.getElementById('photo-preview');
            const photoPreviewText = document.getElementById('photo-preview-text');
            const photoRemoveBtn = document.getElementById('photo-remove-btn');
            const diaryList = document.getElementById('diary-list');
            const diaryFilterMood = document.getElementById('diary-filter-mood');
            const diaryFilterPhoto = document.getElementById('diary-filter-photo');
            const diaryFilterSearch = document.getElementById('diary-filter-search');
            const toggleDiaryFiltersBtn = document.getElementById('toggle-diary-filters');
            const diaryFilterPanel = document.getElementById('diary-filter-panel');
            const authScreen = document.getElementById('auth-screen');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const authMessage = document.getElementById('auth-message');
            const authConfigWarning = document.getElementById('auth-config-warning');
            const monthYearHeader = document.getElementById('month-year-header');
            const monthYearHeaderText = document.getElementById('month-year-header-text');
            const datePickerModal = document.getElementById('date-picker-modal');
            const datePickerOverlay = document.getElementById('date-picker-overlay');
            const datePickerCloseBtn = document.getElementById('date-picker-close');
            const datePickerCancelBtn = document.getElementById('date-picker-cancel');
            const datePickerConfirmBtn = document.getElementById('date-picker-confirm');
            const datePickerYearInput = document.getElementById('date-picker-year');
            const datePickerYearMinus = document.getElementById('date-picker-year-minus');
            const datePickerYearPlus = document.getElementById('date-picker-year-plus');
            const datePickerMonthButtons = Array.from(document.querySelectorAll('[data-month-option]'));
            const accountNameEl = document.getElementById('account-name');
            const accountEmailEl = document.getElementById('account-email');
            const accountPhotoEl = document.getElementById('account-photo');
            const logoutBtn = document.getElementById('logout-btn');
            const analysisIncomeEl = document.getElementById('analysis-income');
            const analysisExpenseEl = document.getElementById('analysis-expense');
            const analysisBalanceEl = document.getElementById('analysis-balance');
            const themeToggle = document.getElementById('theme-toggle');
            const expenseCategoryList = document.getElementById('expense-category-list');
            const incomeCategoryList = document.getElementById('income-category-list');
            const expenseCategoryInput = document.getElementById('expense-category-input');
            const incomeCategoryInput = document.getElementById('income-category-input');
            const addExpenseCategoryBtn = document.getElementById('add-expense-category');
            const addIncomeCategoryBtn = document.getElementById('add-income-category');
            const expenseCategoryCount = document.getElementById('expense-category-count');
            const incomeCategoryCount = document.getElementById('income-category-count');
            const photoPreviewModal = document.getElementById('photo-preview-modal');
            const photoPreviewModalImg = document.getElementById('photo-preview-image');
            const photoPreviewModalClose = document.getElementById('photo-preview-close');
            const analysisAiButton = document.getElementById('analysis-ai-button');
            const analysisAiOutput = document.getElementById('analysis-ai-output');

            // --- åˆæœŸåŒ– ---
            function initialize() {
                loadSettings();
                renderCalendar();
                renderAnalysis(); // åˆæœŸæç”»
                renderMoodSelector();
                initializeDiaryFilters();
                updateDiaryFilterPanelVisibility();
                renderDiaryList();
                renderSettingsView();
                updateTypeToggleUI();
                setupEventListeners();
                updateNavUI();
                updateAuthAvailabilityUI();
                if (authScreen && !authScreen.classList.contains('hidden')) {
                    lockAuthScreenScroll();
                }
                initializeFirebase();
            }

            // --- ãƒ‡ãƒ¼ã‚¿æ“ä½œ ---
            function getUserStorageKey() {
                return currentUser ? `${STORAGE_BASE_KEY}_${currentUser.uid}` : `${STORAGE_BASE_KEY}_guest`;
            }

            function cacheRecordsLocally() {
                if (!currentUser) return;
                try {
                    localStorage.setItem(getUserStorageKey(), JSON.stringify(records));
                } catch (error) {
                    console.warn('ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async function loadRecords() {
                if (!currentUser) {
                    records = {};
                    return;
                }

                try {
                    const cached = localStorage.getItem(getUserStorageKey());
                    records = cached ? JSON.parse(cached) || {} : {};
                } catch (error) {
                    records = {};
                }

                if (!db) return;
                try {
                    const doc = await db.collection('users').doc(currentUser.uid).get();
                    if (doc.exists && doc.data().records) {
                        records = doc.data().records;
                        cacheRecordsLocally();
                    }
                } catch (error) {
                    console.error('Firestoreã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async function saveRecords() {
                if (!currentUser) return;
                cacheRecordsLocally();
                if (!db) return;
                try {
                    await db.collection('users').doc(currentUser.uid).set({
                        records,
                        profile: {
                            displayName: currentUser.displayName || '',
                            email: currentUser.email || '',
                            photoURL: currentUser.photoURL || ''
                        },
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } catch (error) {
                    console.error('Firestoreã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            function updateAuthAvailabilityUI() {
                if (!googleLoginBtn) return;
                if (isFirebaseConfigured) {
                    googleLoginBtn.disabled = false;
                    if (authConfigWarning) {
                        authConfigWarning.classList.add('hidden');
                    }
                } else {
                    googleLoginBtn.disabled = true;
                    if (authConfigWarning) {
                        authConfigWarning.classList.remove('hidden');
                    }
                    showAuthScreen('Firebaseã®è¨­å®šãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šå¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚');
                }
            }

            function lockAuthScreenScroll() {
                document.body?.classList.add('auth-locked');
            }

            function unlockAuthScreenScroll() {
                document.body?.classList.remove('auth-locked');
            }

            function lockDatePickerScroll() {
                document.body?.classList.add('date-picker-locked');
            }

            function unlockDatePickerScroll() {
                document.body?.classList.remove('date-picker-locked');
            }

            function showAuthScreen(message = 'Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã€ã‚ãªãŸå°‚ç”¨ã®å®¶è¨ˆç°¿ã‚’ã¯ã˜ã‚ã¾ã—ã‚‡ã†ã€‚') {
                if (!authScreen) return;
                if (message && authMessage) {
                    authMessage.textContent = message;
                }
                authScreen.classList.remove('hidden');
                lockAuthScreenScroll();
            }

            function hideAuthScreen() {
                if (!authScreen) return;
                authScreen.classList.add('hidden');
                unlockAuthScreenScroll();
            }

            function openDatePicker() {
                if (!datePickerModal) return;
                pendingDatePickerMonth = currentDate.getMonth();
                if (datePickerYearInput) {
                    datePickerYearInput.value = currentDate.getFullYear();
                }
                updateDatePickerMonthUI();
                datePickerModal.classList.remove('hidden');
                lockDatePickerScroll();
            }

            function closeDatePicker() {
                if (!datePickerModal) return;
                datePickerModal.classList.add('hidden');
                unlockDatePickerScroll();
            }

            function updateDatePickerMonthUI() {
                datePickerMonthButtons.forEach((btn) => {
                    const month = Number(btn.dataset.monthOption);
                    btn.classList.toggle('active', month === pendingDatePickerMonth);
                });
            }

            function setDatePickerMonth(month) {
                pendingDatePickerMonth = month;
                updateDatePickerMonthUI();
            }

            function adjustDatePickerYear(delta) {
                if (!datePickerYearInput) return;
                const baseYear = parseInt(datePickerYearInput.value, 10) || new Date().getFullYear();
                datePickerYearInput.value = baseYear + delta;
            }

            function confirmDatePickerSelection() {
                if (!datePickerYearInput) return;
                const year = parseInt(datePickerYearInput.value, 10);
                if (!Number.isFinite(year) || year < 1900 || year > 3000) {
                    alert('æœ‰åŠ¹ãªå¹´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const month = typeof pendingDatePickerMonth === 'number' ? pendingDatePickerMonth : currentDate.getMonth();
                currentDate = new Date(year, month, 1);
                renderCalendar();
                renderAnalysis();
                updateNavUI();
                closeDatePicker();
            }

            function handleGlobalKeydown(event) {
                if (event.key === 'Escape' && datePickerModal && !datePickerModal.classList.contains('hidden')) {
                    closeDatePicker();
                }
            }

            function initializeFirebase() {
                if (!window.firebase) {
                    showAuthScreen('Firebase SDKãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                    updateAuthAvailabilityUI();
                    return;
                }
                if (!isFirebaseConfigured) {
                    updateAuthAvailabilityUI();
                    return;
                }
                try {
                    firebaseApp = firebase.apps && firebase.apps.length > 0 ? firebase.app() : firebase.initializeApp(FIREBASE_CONFIG);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            currentUser = user;
                            hideAuthScreen();
                            await loadRecords();
                            renderCalendar();
                            renderAnalysis();
                            renderDiaryList();
                            renderSettingsView();
                            updateAccountInfoUI();
                            updateNavUI();
                        } else {
                            currentUser = null;
                            records = {};
                            renderCalendar();
                            renderAnalysis();
                            renderDiaryList();
                            renderSettingsView();
                            showAuthScreen();
                            updateNavUI();
                        }
                    });
                    handleRedirectResult();
                } catch (error) {
                    console.error('FirebaseåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                    showAuthScreen('Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    if (googleLoginBtn) {
                        googleLoginBtn.disabled = true;
                    }
                    if (authConfigWarning) {
                        authConfigWarning.classList.remove('hidden');
                    }
                }
            }

            async function handleRedirectResult() {
                if (!auth || typeof auth.getRedirectResult !== 'function') return;
                try {
                    const result = await auth.getRedirectResult();
                    if (result && result.user) {
                        // onAuthStateChanged handles the heavy lifting, but ensure UI unlocks immediately
                        hideAuthScreen();
                    }
                } catch (error) {
                    const ignorableCodes = new Set([
                        'auth/user-cancelled',
                        'auth/operation-not-supported-in-this-environment'
                    ]);
                    if (error && ignorableCodes.has(error.code)) {
                        return;
                    }
                    console.error('Googleãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                    showAuthScreen('Googleãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
            }

            async function handleGoogleLogin() {
                if (!auth) {
                    showAuthScreen('Firebaseã®æº–å‚™ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                try {
                    const popupUnsupportedErrors = new Set([
                        'auth/operation-not-supported-in-this-environment',
                        'auth/popup-blocked'
                    ]);

                    let popupWorked = true;
                    try {
                        // Always try popup first so that mobile browsers keep the SPA alive.
                        await auth.signInWithPopup(provider);
                    } catch (popupError) {
                        popupWorked = false;
                        if (!popupError || !popupUnsupportedErrors.has(popupError.code)) {
                            throw popupError;
                        }
                    }

                    if (popupWorked) {
                        return;
                    }

                    showAuthScreen('Googleãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¦ã„ã¾ã™...');
                    await auth.signInWithRedirect(provider);
                } catch (error) {
                    console.error('Googleãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                    alert('Googleãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ³ã‚’ã”ç¢ºèªã®ä¸Šã€å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
            }

            async function handleLogout() {
                if (!auth) return;
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
                }
            }

            function getDayRecord(dateStr) {
                // YYYY-MM-DD
                if (!records[dateStr]) {
                    records[dateStr] = {
                        transactions: [], // { id, type, amount, category, memo }
                        diary: { text: '', mood: null, photo: null }
                    };
                }
                return records[dateStr];
            }

            function getDefaultSettings() {
                return {
                    theme: 'light',
                    categories: {
                        expense: [...DEFAULT_CATEGORIES.expense],
                        income: [...DEFAULT_CATEGORIES.income]
                    }
                };
            }

            function loadSettings() {
                const defaults = getDefaultSettings();
                try {
                    const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY));
                    if (saved) {
                        defaults.theme = saved.theme === 'dark' ? 'dark' : 'light';
                        defaults.categories.expense = Array.isArray(saved.categories?.expense) && saved.categories.expense.length > 0
                            ? saved.categories.expense
                            : defaults.categories.expense;
                        defaults.categories.income = Array.isArray(saved.categories?.income) && saved.categories.income.length > 0
                            ? saved.categories.income
                            : defaults.categories.income;
                    }
                } catch (error) {
                    console.warn('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
                appSettings = defaults;
                applyTheme(appSettings.theme);
            }

            function saveSettings() {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
            }

            function applyTheme(theme) {
                if (!document.body) return;
                document.body.classList.toggle('dark-mode', theme === 'dark');
                document.documentElement.setAttribute('data-theme', theme);
                document.documentElement.style.colorScheme = theme === 'dark' ? 'dark' : 'light';
                if (window.Chart && Chart.defaults) {
                    const textColor = theme === 'dark' ? '#e2e8f0' : '#0f172a';
                    const gridColor = theme === 'dark' ? '#334155' : '#e5e7eb';
                    Chart.defaults.color = textColor;
                    Chart.defaults.borderColor = gridColor;
                    if (Chart.defaults.scale && Chart.defaults.scale.grid) {
                        Chart.defaults.scale.grid.color = gridColor;
                    }
                    if (Chart.defaults.plugins && Chart.defaults.plugins.legend && Chart.defaults.plugins.legend.labels) {
                        Chart.defaults.plugins.legend.labels.color = textColor;
                    }
                }
            }

            function getCategoryOptions(type) {
                return appSettings.categories[type] ? [...appSettings.categories[type]] : [];
            }

            // --- æç”» ---

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
            function renderCalendar() {
                const calendarGridBody = document.getElementById('calendar-grid-body');
                
                calendarGridBody.innerHTML = '';
                const headerText = `${currentDate.getFullYear()}å¹´ ${currentDate.getMonth() + 1}æœˆ`;
                if (monthYearHeaderText) {
                    monthYearHeaderText.textContent = headerText;
                } else if (monthYearHeader) {
                    monthYearHeader.textContent = headerText;
                }

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // å‰æœˆã®æ—¥ä»˜
                const prevDaysInMonth = new Date(year, month, 0).getDate();
                for (let i = firstDay - 1; i >= 0; i--) {
                    const day = prevDaysInMonth - i;
                    calendarGridBody.appendChild(createDayElement(day, true));
                }

                // ä»Šæœˆã®æ—¥ä»˜
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = formatDate(new Date(year, month, day));
                    const record = records[dateStr];
                    calendarGridBody.appendChild(createDayElement(day, false, record, dateStr));
                }

                // æ¥æœˆã®æ—¥ä»˜
                const totalCells = firstDay + daysInMonth;
                const nextDays = (7 - (totalCells % 7)) % 7;
                for (let day = 1; day <= nextDays; day++) {
                    calendarGridBody.appendChild(createDayElement(day, true));
                }
                
                renderMonthSummary();
            }
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚»ãƒ«ä½œæˆ
            function createDayElement(day, isOtherMonth, record, dateStr) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day p-1 text-sm cursor-pointer relative flex flex-col items-center justify-start rounded-lg hover:bg-blue-50';
                
                if (isOtherMonth) {
                    dayEl.classList.add('other-month');
                    dayEl.innerHTML = `<span>${day}</span>`;
                } else {
                    dayEl.dataset.date = dateStr;
                    
                    // æ—¥ä»˜
                    const dateNum = document.createElement('span');
                    dateNum.textContent = day;
                    dateNum.className = 'font-medium';
                    
                    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒãƒ¼ã‚¯
                    const todayStr = formatDate(new Date());
                    if (dateStr === todayStr) {
                        dateNum.className = 'bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold';
                    }
                    dayEl.appendChild(dateNum);

                    // è¨˜éŒ²ã‚¢ã‚¤ã‚³ãƒ³
                    if (record) {
                        const iconsWrapper = document.createElement('div');
                        iconsWrapper.className = 'flex flex-wrap justify-center items-center gap-1 mt-1';
                        
                        // æ„Ÿæƒ…
                        if (record.diary && record.diary.mood) {
                            const moodIcon = document.createElement('span');
                            moodIcon.textContent = record.diary.mood;
                            moodIcon.className = 'text-xs';
                            iconsWrapper.appendChild(moodIcon);
                        }

                        // å†™çœŸ
                        if (record.diary && record.diary.photo) {
                            const photoIcon = document.createElement('span');
                            photoIcon.innerHTML = 'ğŸ“·';
                            photoIcon.className = 'text-xs';
                            iconsWrapper.appendChild(photoIcon);
                        }

                        // åæ”¯ (æ”¯å‡º/åå…¥)
                        const totalExpense = record.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                        const totalIncome = record.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);

                        if (totalExpense > 0) {
                            const expenseDot = document.createElement('span');
                            expenseDot.className = 'w-1.5 h-1.5 bg-red-500 rounded-full';
                            iconsWrapper.appendChild(expenseDot);
                        }
                        if (totalIncome > 0) {
                            const incomeDot = document.createElement('span');
                            incomeDot.className = 'w-1.5 h-1.5 bg-blue-500 rounded-full';
                            iconsWrapper.appendChild(incomeDot);
                        }

                        dayEl.appendChild(iconsWrapper);
                    }
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                    dayEl.addEventListener('click', () => {
                        selectedDateStr = dateStr;
                        showInputModal();
                    });
                }
                return dayEl;
            }

            // æœˆæ¬¡ã‚µãƒãƒªãƒ¼æç”»
            function renderMonthSummary() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                let totalIncome = 0;
                let totalExpense = 0;

                for (const dateStr in records) {
                    const date = new Date(dateStr);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                totalIncome += t.amount;
                            } else {
                                totalExpense += t.amount;
                            }
                        });
                    }
                }

                document.getElementById('summary-income').textContent = `Â¥${totalIncome.toLocaleString()}`;
                document.getElementById('summary-expense').textContent = `Â¥${totalExpense.toLocaleString()}`;
                document.getElementById('summary-balance').textContent = `Â¥${(totalIncome - totalExpense).toLocaleString()}`;
            }
            
            // é›†è¨ˆç”»é¢æç”» (ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£)
            function renderAnalysis() {
                updateAnalysisTabUI();

                // æœŸé–“ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ›´æ–°
                const header = document.getElementById('month-year-analysis-header');
                let summary = { income: 0, expense: 0 };
                if (currentAnalysisView === 'week') {
                    const week = getWeekRange(currentDate);
                    header.textContent = `${formatDate(week.start, 'short')} ~ ${formatDate(week.end, 'short')}`;
                    document.getElementById('balance-chart-title').textContent = 'ä»Šé€±ã®æ—¥åˆ¥åæ”¯';
                    summary = renderWeekAnalysis(week) || summary;
                } else if (currentAnalysisView === 'year') {
                    header.textContent = `${currentDate.getFullYear()}å¹´`;
                    document.getElementById('balance-chart-title').textContent = 'ä»Šå¹´ã®æœˆåˆ¥åæ”¯';
                    summary = renderYearAnalysis() || summary;
                } else { // month
                    header.textContent = `${currentDate.getFullYear()}å¹´ ${currentDate.getMonth() + 1}æœˆ`;
                    document.getElementById('balance-chart-title').textContent = 'ä»Šæœˆã®æ—¥åˆ¥åæ”¯';
                    summary = renderMonthAnalysis() || summary;
                }

                updateAnalysisSummary(summary);
            }

            function updateAnalysisSummary(summary = { income: 0, expense: 0 }) {
                if (!analysisIncomeEl || !analysisExpenseEl || !analysisBalanceEl) return;
                const income = summary.income || 0;
                const expense = summary.expense || 0;
                const balance = income - expense;

                analysisIncomeEl.textContent = `Â¥${income.toLocaleString()}`;
                analysisExpenseEl.textContent = `Â¥${expense.toLocaleString()}`;
                analysisBalanceEl.textContent = `Â¥${balance.toLocaleString()}`;

                analysisBalanceEl.classList.remove('text-green-600', 'text-red-600', 'text-gray-800');
                if (balance > 0) {
                    analysisBalanceEl.classList.add('text-green-600');
                } else if (balance < 0) {
                    analysisBalanceEl.classList.add('text-red-600');
                } else {
                    analysisBalanceEl.classList.add('text-gray-800');
                }
            }

            function getCurrentAnalysisRange() {
                const base = new Date(currentDate);
                if (currentAnalysisView === 'week') {
                    const range = getWeekRange(base);
                    return { start: range.start, end: range.end, label: `${formatDate(range.start, 'short')}ã€œ${formatDate(range.end, 'short')}` };
                }
                if (currentAnalysisView === 'year') {
                    const start = new Date(base.getFullYear(), 0, 1);
                    const end = new Date(base.getFullYear(), 11, 31);
                    return { start, end, label: `${base.getFullYear()}å¹´` };
                }
                // month
                const start = new Date(base.getFullYear(), base.getMonth(), 1);
                const end = new Date(base.getFullYear(), base.getMonth() + 1, 0);
                return { start, end, label: `${base.getFullYear()}å¹´${base.getMonth() + 1}æœˆ` };
            }

            function getAnalysisSnapshot() {
                const range = getCurrentAnalysisRange();
                if (!range) return null;
                const transactions = [];
                for (const [dateStr, record] of Object.entries(records)) {
                    const date = new Date(dateStr);
                    if (Number.isNaN(date.getTime())) continue;
                    if (date < range.start || date > range.end) continue;
                    record.transactions.forEach(t => {
                        transactions.push({ ...t, date: dateStr });
                    });
                }
                const daySet = new Set(transactions.map(t => t.date));
                let totalIncome = 0;
                let totalExpense = 0;
                const categoryTotals = {};
                transactions.forEach(t => {
                    if (t.type === 'income') {
                        totalIncome += t.amount;
                    } else {
                        totalExpense += t.amount;
                        categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                    }
                });
                const topCategories = Object.entries(categoryTotals)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, amount]) => ({ name, amount }));
                return {
                    label: range.label,
                    view: currentAnalysisView,
                    transactionCount: transactions.length,
                    dayCount: daySet.size,
                    totalIncome,
                    totalExpense,
                    net: totalIncome - totalExpense,
                    topCategories
                };
            }

            function buildGeminiPrompt(snapshot) {
                return `ã‚ãªãŸã¯å®¶è¨ˆç°¿ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®æœŸé–“ãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«ã€ç¯€ç´„/æ”¹å–„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚„ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè¤’ã‚ãƒã‚¤ãƒ³ãƒˆã‚’æ—¥æœ¬èªã§ç°¡æ½”ã«æ•™ãˆã¦ãã ã•ã„ã€‚

æœŸé–“: ${snapshot.label}
åå…¥åˆè¨ˆ: ${snapshot.totalIncome}å††
æ”¯å‡ºåˆè¨ˆ: ${snapshot.totalExpense}å††
åæ”¯: ${snapshot.net}å††
ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ•°: ${snapshot.transactionCount}
æ—¥æ•°: ${snapshot.dayCount}
ä¸»ãªæ”¯å‡ºã‚«ãƒ†ã‚´ãƒª: ${snapshot.topCategories.map(cat => `${cat.name}:${cat.amount}å††`).join(', ') || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}

å›ç­”ã¯ç®‡æ¡æ›¸ãã§ã€æœ€å¤§4è¡Œç¨‹åº¦ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚`;
            }

            async function getGeminiModelInvocationOrder() {
                if (geminiModelOrderCache) {
                    return geminiModelOrderCache;
                }

                const fallbackOrder = GEMINI_PREFERRED_MODELS.map(name => `${GEMINI_API_VERSION}/${name}:generateContent`);
                if (!isGeminiConfigured) {
                    geminiModelOrderCache = fallbackOrder;
                    return geminiModelOrderCache;
                }

                try {
                    const response = await fetch(`${GEMINI_API_BASE}/${GEMINI_API_VERSION}/models?key=${GEMINI_API_KEY}`);
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.error?.message || `Gemini model list error (${response.status})`);
                    }
                    const models = Array.isArray(data?.models) ? data.models : [];
                    const supported = models
                        .filter(model => Array.isArray(model?.supportedGenerationMethods) && model.supportedGenerationMethods.includes('generateContent'))
                        .map(model => model.name);

                    if (supported.length === 0) {
                        throw new Error('Gemini APIã«åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    }

                    const ordered = [];
                    GEMINI_PREFERRED_MODELS.forEach(name => {
                        if (supported.includes(name)) {
                            ordered.push(name);
                        }
                    });
                    supported.forEach(name => {
                        if (!ordered.includes(name)) {
                            ordered.push(name);
                        }
                    });

                    geminiModelOrderCache = ordered.map(name => `${GEMINI_API_VERSION}/${name}:generateContent`);
                    return geminiModelOrderCache;
                } catch (error) {
                    console.warn('Geminiãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                    geminiModelOrderCache = fallbackOrder;
                    return geminiModelOrderCache;
                }
            }

            async function fetchGeminiAdvice(prompt) {
                const modelPaths = await getGeminiModelInvocationOrder();
                let lastError = 'ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';

                for (const path of modelPaths) {
                    try {
                        const response = await fetch(`${GEMINI_API_BASE}/${path}?key=${GEMINI_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ role: 'user', parts: [{ text: prompt }] }]
                            })
                        });
                        const data = await response.json().catch(() => ({}));
                        if (!response.ok) {
                            const message = data?.error?.message || `Gemini API error (${response.status})`;
                            const shouldTryNext =
                                response.status === 404 || /not found/i.test(message) || /not supported/i.test(message);
                            if (shouldTryNext) {
                                lastError = message;
                                continue;
                            }
                            throw new Error(message);
                        }
                        const text = data?.candidates?.[0]?.content?.parts?.map(part => part?.text).filter(Boolean).join('\n');
                        if (text) {
                            return text;
                        }
                        lastError = 'ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                    } catch (error) {
                        lastError = error?.message || 'Gemini APIã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    }
                }

                throw new Error(lastError);
            }

            async function handleAnalysisAdviceRequest() {
                if (!analysisAiOutput) return;
                if (!isGeminiConfigured) {
                    analysisAiOutput.textContent = 'Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`GEMINI_API_KEY` ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                    return;
                }
                const snapshot = getAnalysisSnapshot();
                if (!snapshot || snapshot.transactionCount === 0) {
                    analysisAiOutput.textContent = 'ã“ã®æœŸé–“ã«ã¯åˆ†æã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                    return;
                }
                analysisAiOutput.textContent = 'GeminiãŒåˆ†æã—ã¦ã„ã¾ã™â€¦';
                try {
                    const prompt = buildGeminiPrompt(snapshot);
                    const text = await fetchGeminiAdvice(prompt);
                    analysisAiOutput.textContent = text || 'ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                } catch (error) {
                    console.error('Geminiåˆ†æã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                    analysisAiOutput.textContent = error?.message
                        ? `ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`
                        : 'ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚„APIã‚­ãƒ¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
                }
            }

            // æœˆæ¬¡é›†è¨ˆ
            function renderMonthAnalysis() {
                // document.getElementById('month-year-analysis-header').textContent = `${currentDate.getFullYear()}å¹´ ${currentDate.getMonth() + 1}æœˆ`;
                
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                // ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
                const expenseData = {};
                const dailyData = {}; // æ—¥åˆ¥ã®åæ”¯
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let day = 1; day <= daysInMonth; day++) {
                    dailyData[day] = { income: 0, expense: 0 };
                }

                for (const dateStr in records) {
                    const date = new Date(dateStr);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        const day = date.getDate();
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                dailyData[day].income += t.amount;
                            } else {
                                dailyData[day].expense += t.amount;
                                expenseData[t.category] = (expenseData[t.category] || 0) + t.amount;
                            }
                        });
                    }
                }

                // 1. æ”¯å‡ºå††ã‚°ãƒ©ãƒ•
                const expenseCtx = document.getElementById('expense-chart').getContext('2d');
                const labels = Object.keys(expenseData);
                const data = Object.values(expenseData);
                
                if (expenseChartInstance) {
                    expenseChartInstance.destroy();
                }

                if (labels.length > 0) {
                    expenseChartInstance = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'æ”¯å‡º',
                                data: data,
                                backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#8b5cf6', '#64748b'],
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                },
                            }
                        }
                    });
                } else {
                     expenseCtx.clearRect(0, 0, expenseCtx.canvas.width, expenseCtx.canvas.height);
                     expenseCtx.fillText("ã“ã®æœˆã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“", expenseCtx.canvas.width/2, expenseCtx.canvas.height/2);
                     expenseCtx.textAlign = 'center';
                }

                // 2. æ—¥åˆ¥åæ”¯æ£’ã‚°ãƒ©ãƒ•
                const balanceCtx = document.getElementById('balance-chart').getContext('2d');
                const dayLabels = Object.keys(dailyData).map(day => `${day}æ—¥`);
                const incomeValues = Object.values(dailyData).map(d => d.income);
                const expenseValues = Object.values(dailyData).map(d => d.expense);
                const totalIncome = incomeValues.reduce((sum, value) => sum + value, 0);
                const totalExpense = expenseValues.reduce((sum, value) => sum + value, 0);

                if (balanceChartInstance) {
                    balanceChartInstance.destroy();
                }

                balanceChartInstance = new Chart(balanceCtx, {
                    type: 'bar',
                    data: {
                        labels: dayLabels,
                        datasets: [
                            {
                                label: 'åå…¥',
                                data: incomeValues,
                                backgroundColor: '#3b82f6', // blue-500
                            },
                            {
                                label: 'æ”¯å‡º',
                                data: expenseValues,
                                backgroundColor: '#ef4444', // red-500
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });

                return { income: totalIncome, expense: totalExpense };
            }

            // é€±æ¬¡é›†è¨ˆ
            function renderWeekAnalysis(week) {
                const expenseData = {};
                const dailyData = {};
                const labels = [];

                // é€±ã®å„æ—¥ã‚’åˆæœŸåŒ–
                for (let d = new Date(week.start); d <= week.end; d.setDate(d.getDate() + 1)) {
                    const dateStr = formatDate(d);
                    labels.push(`${d.getMonth() + 1}/${d.getDate()}æ—¥`);
                    dailyData[dateStr] = { income: 0, expense: 0 };
                }

                // ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
                for (const dateStr in dailyData) {
                    if (records[dateStr]) {
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                dailyData[dateStr].income += t.amount;
                            } else {
                                dailyData[dateStr].expense += t.amount;
                                expenseData[t.category] = (expenseData[t.category] || 0) + t.amount;
                            }
                        });
                    }
                }

                // 1. æ”¯å‡ºå††ã‚°ãƒ©ãƒ•
                const expenseCtx = document.getElementById('expense-chart').getContext('2d');
                const expenseLabels = Object.keys(expenseData);
                const doughnutData = Object.values(expenseData); // å¤‰æ•°åã‚’ 'expenseValues' ã‹ã‚‰ 'doughnutData' ã«å¤‰æ›´
                
                if (expenseChartInstance) expenseChartInstance.destroy();
                if (expenseLabels.length > 0) {
                    expenseChartInstance = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: {
                            labels: expenseLabels,
                            datasets: [{ data: doughnutData, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#8b5cf6', '#64748b'] }] // 'doughnutData' ã‚’ä½¿ç”¨
                        },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });
                } else {
                     expenseCtx.clearRect(0, 0, expenseCtx.canvas.width, expenseCtx.canvas.height);
                     expenseCtx.fillText("ã“ã®é€±ã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“", expenseCtx.canvas.width/2, expenseCtx.canvas.height/2);
                     expenseCtx.textAlign = 'center';
                }

                // 2. æ—¥åˆ¥åæ”¯æ£’ã‚°ãƒ©ãƒ•
                const balanceCtx = document.getElementById('balance-chart').getContext('2d');
                const incomeValues = Object.values(dailyData).map(d => d.income);
                const expenseValues = Object.values(dailyData).map(d => d.expense);
                const totalIncome = incomeValues.reduce((sum, value) => sum + value, 0);
                const totalExpense = expenseValues.reduce((sum, value) => sum + value, 0);

                if (balanceChartInstance) balanceChartInstance.destroy();
                balanceChartInstance = new Chart(balanceCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'åå…¥', data: incomeValues, backgroundColor: '#3b82f6' },
                            { label: 'æ”¯å‡º', data: expenseValues, backgroundColor: '#ef4444' }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: { x: { stacked: true }, y: { stacked: true } },
                        plugins: { legend: { position: 'bottom' } }
                    }
                });

                return { income: totalIncome, expense: totalExpense };
            }

            // å¹´æ¬¡é›†è¨ˆ
            function renderYearAnalysis() {
                const year = currentDate.getFullYear();
                const expenseData = {};
                const monthlyData = {};
                const labels = [];

                for (let m = 0; m < 12; m++) {
                    labels.push(`${m + 1}æœˆ`);
                    monthlyData[m] = { income: 0, expense: 0 };
                }

                for (const dateStr in records) {
                    const date = new Date(dateStr);
                    if (date.getFullYear() === year) {
                        const month = date.getMonth();
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                monthlyData[month].income += t.amount;
                            } else {
                                monthlyData[month].expense += t.amount;
                                expenseData[t.category] = (expenseData[t.category] || 0) + t.amount;
                            }
                        });
                    }
                }

                // 1. æ”¯å‡ºå††ã‚°ãƒ©ãƒ•
                const expenseCtx = document.getElementById('expense-chart').getContext('2d');
                const expenseLabels = Object.keys(expenseData);
                const yearDoughnutData = Object.values(expenseData); // å¤‰æ•°åã‚’ 'expenseValues' ã‹ã‚‰ 'yearDoughnutData' ã«å¤‰æ›´
                
                if (expenseChartInstance) expenseChartInstance.destroy();
                if (expenseLabels.length > 0) {
                    expenseChartInstance = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: {
                            labels: expenseLabels,
                            datasets: [{ data: yearDoughnutData, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#8b5cf6', '#64748b'] }] // 'yearDoughnutData' ã‚’ä½¿ç”¨
                        },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });
                } else {
                     expenseCtx.clearRect(0, 0, expenseCtx.canvas.width, expenseCtx.canvas.height);
                     expenseCtx.fillText("ã“ã®å¹´ã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“", expenseCtx.canvas.width/2, expenseCtx.canvas.height/2);
                     expenseCtx.textAlign = 'center';
                }

                // 2. æœˆåˆ¥åæ”¯æ£’ã‚°ãƒ©ãƒ•
                const balanceCtx = document.getElementById('balance-chart').getContext('2d');
                const incomeValues = Object.values(monthlyData).map(d => d.income);
                const expenseValues = Object.values(monthlyData).map(d => d.expense);
                const totalIncome = incomeValues.reduce((sum, value) => sum + value, 0);
                const totalExpense = expenseValues.reduce((sum, value) => sum + value, 0);

                if (balanceChartInstance) balanceChartInstance.destroy();
                balanceChartInstance = new Chart(balanceCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'åå…¥', data: incomeValues, backgroundColor: '#3b82f6' },
                            { label: 'æ”¯å‡º', data: expenseValues, backgroundColor: '#ef4444' }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: { x: { stacked: true }, y: { stacked: true } },
                        plugins: { legend: { position: 'bottom' } }
                    }
                });

                return { income: totalIncome, expense: totalExpense };
            }

            // æ—¥è¨˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–
            function initializeDiaryFilters() {
                if (diaryFilterMood) {
                    // æ—¢å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€Œã™ã¹ã¦ã€ã®ã¿æƒ³å®š
                    MOODS.forEach(mood => {
                        const option = document.createElement('option');
                        option.value = mood;
                        option.textContent = mood;
                        diaryFilterMood.appendChild(option);
                    });
                    diaryFilterMood.value = diaryFilters.mood;
                }
                if (diaryFilterPhoto) {
                    diaryFilterPhoto.value = diaryFilters.photo;
                }
                if (diaryFilterSearch) {
                    diaryFilterSearch.value = diaryFilters.search;
                }
            }

            // æ—¥è¨˜ãƒªã‚¹ãƒˆæç”»
            function renderDiaryList() {
                if (!diaryList) return;
                if (!currentUser) {
                    diaryList.innerHTML = '<div class="text-center text-sm text-gray-500 bg-white p-4 rounded-lg shadow-sm">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨æ—¥è¨˜ä¸€è¦§ã‚’é–²è¦§ã§ãã¾ã™ã€‚</div>';
                    return;
                }

                const entries = Object.entries(records)
                    .map(([dateStr, record]) => ({
                        dateStr,
                        diary: record.diary || {}
                    }))
                    .filter(({ diary }) => {
                        const hasText = diary.text && diary.text.trim().length > 0;
                        return hasText || diary.mood || diary.photo;
                    })
                    .sort((a, b) => new Date(b.dateStr) - new Date(a.dateStr));

                const filteredEntries = entries.filter(({ diary }) => {
                    if (diaryFilters.mood !== 'all' && diary.mood !== diaryFilters.mood) {
                        return false;
                    }
                    if (diaryFilters.photo === 'with' && !diary.photo) {
                        return false;
                    }
                    if (diaryFilters.photo === 'without' && diary.photo) {
                        return false;
                    }
                    if (diaryFilters.search) {
                        const text = (diary.text || '').toLowerCase();
                        if (!text.includes(diaryFilters.search)) {
                            return false;
                        }
                    }
                    return true;
                });

                diaryList.innerHTML = '';

                if (filteredEntries.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'text-center text-sm text-gray-500 bg-white p-4 rounded-lg shadow-sm';
                    empty.textContent = 'æ¡ä»¶ã«åˆã†æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“';
                    diaryList.appendChild(empty);
                    return;
                }

                filteredEntries.forEach(({ dateStr, diary }) => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-sm space-y-3 diary-card cursor-pointer transition-colors duration-150 hover:bg-blue-50';
                    card.dataset.date = dateStr;

                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-start';

                    const dateEl = document.createElement('div');
                    dateEl.innerHTML = `
                        <p class="text-sm font-semibold text-gray-800">${formatDiaryDate(dateStr)}</p>
                    `;
                    header.appendChild(dateEl);

                    const moodEl = document.createElement('span');
                    moodEl.className = 'text-2xl';
                    moodEl.textContent = diary.mood || 'â€”';
                    header.appendChild(moodEl);

                    card.appendChild(header);

                    const textEl = document.createElement('p');
                    textEl.className = 'text-sm text-gray-700 whitespace-pre-wrap leading-relaxed';
                    textEl.textContent = diary.text && diary.text.trim().length > 0 ? diary.text : 'ãƒ†ã‚­ã‚¹ãƒˆã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“';
                    card.appendChild(textEl);

                    if (diary.photo) {
                        const photoEl = document.createElement('img');
                        photoEl.src = diary.photo;
                        photoEl.alt = `${dateStr} ã®æ—¥è¨˜å†™çœŸ`;
                        photoEl.className = 'w-full h-40 object-cover rounded-lg cursor-zoom-in';
                        photoEl.dataset.photoPreview = 'true';
                        photoEl.addEventListener('click', (event) => {
                            event.stopPropagation();
                            openPhotoPreview(diary.photo);
                        });
                        card.appendChild(photoEl);
                    }

                    card.addEventListener('click', () => handleDiaryCardOpen(dateStr));

                    diaryList.appendChild(card);
                });
            }

            function handleDiaryCardOpen(dateStr) {
                if (!dateStr) return;
                if (!currentUser) {
                    showAuthScreen();
                    return;
                }
                showInputModal(dateStr);
            }

            function toggleDiaryFilters() {
                isDiaryFilterOpen = !isDiaryFilterOpen;
                updateDiaryFilterPanelVisibility();
            }

            function updateDiaryFilterPanelVisibility() {
                if (!diaryFilterPanel || !toggleDiaryFiltersBtn) return;
                if (isDiaryFilterOpen) {
                    diaryFilterPanel.classList.remove('hidden');
                    toggleDiaryFiltersBtn.classList.add('active');
                } else {
                    diaryFilterPanel.classList.add('hidden');
                    toggleDiaryFiltersBtn.classList.remove('active');
                }
                toggleDiaryFiltersBtn.setAttribute('aria-expanded', isDiaryFilterOpen.toString());
            }

            function openPhotoPreview(photoData) {
                if (!photoData || !photoPreviewModal || !photoPreviewModalImg) return;
                photoPreviewModalImg.src = photoData;
                photoPreviewModal.classList.remove('hidden');
            }

            function closePhotoPreview() {
                if (!photoPreviewModal || !photoPreviewModalImg) return;
                photoPreviewModalImg.src = '';
                photoPreviewModal.classList.add('hidden');
            }

            function formatDiaryDate(dateStr) {
                const date = new Date(dateStr);
                if (Number.isNaN(date.getTime())) {
                    return dateStr;
                }
                return date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    weekday: 'short'
                });
            }

            function renderSettingsView() {
                updateAccountInfoUI();
                if (themeToggle) {
                    themeToggle.checked = appSettings.theme === 'dark';
                }
                renderCategoryList('expense', expenseCategoryList, expenseCategoryCount);
                renderCategoryList('income', incomeCategoryList, incomeCategoryCount);
            }

            function renderCategoryList(type, container, countElement) {
                if (!container) return;
                container.innerHTML = '';
                const categories = getCategoryOptions(type);
                const canRemove = categories.length > 1;

                categories.forEach(name => {
                    const chip = document.createElement('span');
                    chip.className = 'category-chip';

                    const text = document.createElement('span');
                    text.textContent = name;
                    chip.appendChild(text);

                    if (canRemove) {
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.dataset.categoryAction = 'remove';
                        removeBtn.dataset.categoryName = name;
                        chip.appendChild(removeBtn);
                    } else {
                        const lock = document.createElement('span');
                        lock.className = 'text-xs text-gray-500';
                        lock.textContent = 'ä¿æŒ';
                        chip.appendChild(lock);
                    }

                    container.appendChild(chip);
                });

                if (countElement) {
                    countElement.textContent = `${categories.length} ä»¶`;
                }
            }

            function updateAccountInfoUI() {
                if (!accountNameEl || !accountEmailEl || !logoutBtn) return;
                if (currentUser) {
                    accountNameEl.textContent = currentUser.displayName || 'ã‚²ã‚¹ãƒˆ';
                    accountEmailEl.textContent = currentUser.email || '';
                    if (accountPhotoEl) {
                        if (currentUser.photoURL) {
                            accountPhotoEl.src = currentUser.photoURL;
                            accountPhotoEl.classList.remove('hidden');
                        } else {
                            accountPhotoEl.classList.add('hidden');
                        }
                    }
                    logoutBtn.classList.remove('hidden');
                } else {
                    accountNameEl.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“';
                    accountEmailEl.textContent = '';
                    if (accountPhotoEl) {
                        accountPhotoEl.classList.add('hidden');
                    }
                    logoutBtn.classList.add('hidden');
                }
            }

            function handleCategoryAdd(type) {
                const input = type === 'expense' ? expenseCategoryInput : incomeCategoryInput;
                if (!input) return;
                const newName = input.value.trim();
                if (!newName) return;

                const normalized = newName.toLowerCase();
                const categories = getCategoryOptions(type);
                const exists = categories.some(cat => cat.toLowerCase() === normalized);
                if (exists) {
                    input.value = '';
                    return;
                }

                appSettings.categories[type] = [...categories, newName];
                input.value = '';
                saveSettings();
                renderSettingsView();
                updateCategorySelect();
            }

            function handleCategoryRemove(type, name) {
                const categories = getCategoryOptions(type);
                if (categories.length <= 1) {
                    alert('ã‚«ãƒ†ã‚´ãƒªã¯å°‘ãªãã¨ã‚‚1ã¤å¿…è¦ã§ã™');
                    return;
                }

                const updated = categories.filter(cat => cat !== name);
                appSettings.categories[type] = updated;
                saveSettings();
                renderSettingsView();
                updateCategorySelect();
            }

            // æ„Ÿæƒ…ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æç”»
            function renderMoodSelector() {
                moodSelector.innerHTML = '';
                MOODS.forEach(mood => {
                    const btn = document.createElement('button');
                    btn.textContent = mood;
                    btn.className = 'mood-icon text-3xl p-2 rounded-full hover:bg-gray-100 transition-all duration-200';
                    btn.dataset.mood = mood;
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (selectedMood === mood) {
                            selectedMood = null;
                        } else {
                            selectedMood = mood;
                        }
                        updateMoodSelectorUI(selectedMood);
                    });
                    moodSelector.appendChild(btn);
                });
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            function showInputModal(targetDateStr = selectedDateStr) {
                if (!currentUser) {
                    showAuthScreen();
                    return;
                }
                if (targetDateStr) {
                    selectedDateStr = targetDateStr;
                }
                modalDateHeader.textContent = selectedDateStr;
                
                const record = getDayRecord(selectedDateStr);
                
                // åæ”¯ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚»ãƒƒãƒˆ
                amountInput.value = '';
                memoInput.value = '';
                typeToggle.checked = false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’æ”¯å‡ºã«
                handleTypeToggleChange();

                // åæ”¯ä¸€è¦§ã®æç”»
                renderDailyTransactions(record.transactions);
                
                // æ—¥è¨˜ãƒ•ã‚©ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿
                diaryTextInput.value = record.diary.text || '';
                selectedMood = record.diary.mood;
                updateMoodSelectorUI(selectedMood);
                
                // å†™çœŸã®èª­ã¿è¾¼ã¿
                tempPhotoData = record.diary.photo;
                if (tempPhotoData) {
                    photoPreview.src = tempPhotoData;
                    photoPreview.classList.remove('hidden');
                    photoPreviewText.classList.add('hidden');
                    photoRemoveBtn.classList.remove('hidden');
                } else {
                    photoPreview.src = '';
                    photoPreview.classList.add('hidden');
                    photoPreviewText.classList.remove('hidden');
                    photoRemoveBtn.classList.add('hidden');
                }

                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                inputModal.classList.remove('hidden');
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯åæ”¯ã‚¿ãƒ–
                showTab('expense');
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
            function hideInputModal() {
                inputModal.classList.add('hidden');
                // ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                tempPhotoData = null;
                selectedMood = null;
            }

            // --- UIãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³UIæ›´æ–°
            function updateNavUI() {
                const viewMap = {
                    calendar: calendarView,
                    analysis: analysisView,
                    diary: diaryView,
                    settings: settingsView
                };

                Object.values(viewMap).forEach(view => {
                    if (!view) return;
                    view.classList.add('hidden');
                });
                if (viewMap[currentView]) {
                    viewMap[currentView].classList.remove('hidden');
                }

                const navMap = {
                    calendar: navCalendar,
                    analysis: navAnalysis,
                    diary: navDiary,
                    settings: navSettings
                };
                Object.values(navMap).forEach(btn => {
                    if (!btn) return;
                    btn.classList.add('text-gray-500');
                    btn.classList.remove('text-blue-600');
                });
                if (navMap[currentView]) {
                    navMap[currentView].classList.add('text-blue-600');
                    navMap[currentView].classList.remove('text-gray-500');
                }

                if (currentView === 'analysis') {
                    renderAnalysis();
                } else if (currentView === 'diary') {
                    renderDiaryList();
                } else if (currentView === 'settings') {
                    renderSettingsView();
                }
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            function showTab(tabName) {
                if (tabName === 'expense') {
                    expenseForm.classList.remove('hidden');
                    diaryForm.classList.add('hidden');
                    tabExpense.classList.add('bg-white', 'shadow', 'text-blue-600');
                    tabExpense.classList.remove('text-gray-600');
                    tabDiary.classList.remove('bg-white', 'shadow', 'text-blue-600');
                    tabDiary.classList.add('text-gray-600');
                } else {
                    expenseForm.classList.add('hidden');
                    diaryForm.classList.remove('hidden');
                    tabExpense.classList.remove('bg-white', 'shadow', 'text-blue-600');
                    tabExpense.classList.add('text-gray-600');
                    tabDiary.classList.add('bg-white', 'shadow', 'text-blue-600');
                    tabDiary.classList.remove('text-gray-600');
                }
            }

            // é›†è¨ˆã‚¿ãƒ–UIæ›´æ–°
            function updateAnalysisTabUI() {
                const tabs = [
                    document.getElementById('tab-week'),
                    document.getElementById('tab-month'),
                    document.getElementById('tab-year')
                ];
                tabs.forEach(tab => {
                    tab.classList.remove('bg-white', 'shadow', 'text-blue-600');
                    tab.classList.add('text-gray-600');
                });
                
                if (currentAnalysisView === 'week') {
                    document.getElementById('tab-week').classList.add('bg-white', 'shadow', 'text-blue-600');
                } else if (currentAnalysisView === 'year') {
                    document.getElementById('tab-year').classList.add('bg-white', 'shadow', 'text-blue-600');
                } else { // month
                    document.getElementById('tab-month').classList.add('bg-white', 'shadow', 'text-blue-600');
                }
            }
            
            // æ„Ÿæƒ…ã‚»ãƒ¬ã‚¯ã‚¿UIæ›´æ–°
            function updateMoodSelectorUI(mood) {
                document.querySelectorAll('.mood-icon').forEach(icon => {
                    if (icon.dataset.mood === mood) {
                        icon.classList.add('selected');
                    } else {
                        icon.classList.remove('selected');
                    }
                });
            }

            // ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠè‚¢æ›´æ–° (åå…¥/æ”¯å‡º)
            function updateCategorySelect() {
                if (!categorySelect) return;
                const type = typeToggle.checked ? 'income' : 'expense';
                const options = getCategoryOptions(type);

                categorySelect.innerHTML = '';
                options.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categorySelect.appendChild(option);
                });
            }

            function updateTypeToggleUI() {
                if (!typeToggle) return;
                const isIncome = typeToggle.checked;
                if (typeToggleControl) {
                    typeToggleControl.classList.toggle('mode-income', isIncome);
                    typeToggleControl.classList.toggle('mode-expense', !isIncome);
                }
                if (toggleExpenseBtn) {
                    toggleExpenseBtn.classList.toggle('active', !isIncome);
                    toggleExpenseBtn.setAttribute('aria-pressed', (!isIncome).toString());
                }
                if (toggleIncomeBtn) {
                    toggleIncomeBtn.classList.toggle('active', isIncome);
                    toggleIncomeBtn.setAttribute('aria-pressed', isIncome.toString());
                }
            }

            function handleTypeToggleChange() {
                updateCategorySelect();
                updateTypeToggleUI();
            }

            // æ—¥åˆ¥åæ”¯ä¸€è¦§ã‚’æç”»
            function renderDailyTransactions(transactions) {
                dailyTransactionsList.innerHTML = '';
                if (transactions.length === 0) {
                    dailyTransactionsList.innerHTML = '<li class="text-sm text-gray-500 text-center">ã“ã®æ—¥ã®åæ”¯ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
                    return;
                }
                
                transactions.forEach(t => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg';
                    
                    const left = document.createElement('div');
                    const category = document.createElement('span');
                    category.textContent = t.category;
                    category.className = 'font-medium text-sm';
                    const memo = document.createElement('span');
                    memo.textContent = t.memo ? ` (${t.memo})` : '';
                    memo.className = 'text-xs text-gray-500 ml-1';
                    left.appendChild(category);
                    left.appendChild(memo);

                    const right = document.createElement('div');
                    const amount = document.createElement('span');
                    amount.textContent = `Â¥${t.amount.toLocaleString()}`;
                    amount.className = `font-semibold text-sm ${t.type === 'income' ? 'text-blue-600' : 'text-red-600'}`;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;'; // Ã—
                    deleteBtn.className = 'ml-2 text-red-500 hover:text-red-700 font-bold';
                    deleteBtn.onclick = () => handleDeleteTransaction(t.id);

                    right.appendChild(amount);
                    right.appendChild(deleteBtn);
                    li.appendChild(left);
                    li.appendChild(right);
                    dailyTransactionsList.appendChild(li);
                });
            }
            
            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
            
            function setupEventListeners() {
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
                if (navCalendar) {
                    navCalendar.addEventListener('click', () => {
                        currentView = 'calendar';
                        updateNavUI();
                    });
                }
                if (navAnalysis) {
                    navAnalysis.addEventListener('click', () => {
                        currentView = 'analysis';
                        updateNavUI();
                    });
                }
                if (navDiary) {
                    navDiary.addEventListener('click', () => {
                        currentView = 'diary';
                        updateNavUI();
                    });
                }
                if (navSettings) {
                    navSettings.addEventListener('click', () => {
                        currentView = 'settings';
                        updateNavUI();
                    });
                }

                // æœˆç§»å‹• (ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼)
                document.getElementById('prev-month-btn').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });
                document.getElementById('next-month-btn').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });

                // æœŸé–“ç§»å‹• (é›†è¨ˆ)
                document.getElementById('prev-period-analysis-btn').addEventListener('click', () => {
                    if (currentAnalysisView === 'week') {
                        currentDate.setDate(currentDate.getDate() - 7);
                    } else if (currentAnalysisView === 'year') {
                        currentDate.setFullYear(currentDate.getFullYear() - 1);
                    } else { // month
                        currentDate.setMonth(currentDate.getMonth() - 1);
                    }
                    renderAnalysis();
                });
                document.getElementById('next-period-analysis-btn').addEventListener('click', () => {
                    if (currentAnalysisView === 'week') {
                        currentDate.setDate(currentDate.getDate() - 7);
                    } else if (currentAnalysisView === 'year') {
                        currentDate.setFullYear(currentDate.getFullYear() - 1);
                    } else { // month
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                    renderAnalysis();
                });
                
                // é›†è¨ˆã‚¿ãƒ–
                document.getElementById('tab-week').addEventListener('click', () => {
                    currentAnalysisView = 'week';
                    currentDate = new Date(); // é€±è¡¨ç¤ºã¯ä»Šæ—¥ã‚’åŸºæº–ã«ãƒªã‚»ãƒƒãƒˆ
                    renderAnalysis();
                });
                document.getElementById('tab-month').addEventListener('click', () => {
                    currentAnalysisView = 'month';
                    currentDate = new Date(); // æœˆè¡¨ç¤ºã¯ä»Šæœˆã«ãƒªã‚»ãƒƒãƒˆ
                    renderAnalysis();
                });
                document.getElementById('tab-year').addEventListener('click', () => {
                    currentAnalysisView = 'year';
                    currentDate = new Date(); // å¹´è¡¨ç¤ºã¯ä»Šå¹´ã«ãƒªã‚»ãƒƒãƒˆ
                    renderAnalysis();
                });

                // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
                addNewBtn.addEventListener('click', () => {
                    selectedDateStr = formatDate(new Date()); // æ–°è¦è¿½åŠ ã¯ä»Šæ—¥
                    showInputModal();
                });
                closeModalBtn.addEventListener('click', hideInputModal);

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ãƒ–
                tabExpense.addEventListener('click', () => showTab('expense'));
                tabDiary.addEventListener('click', () => showTab('diary'));

                // ä¿å­˜
                saveBtn.addEventListener('click', handleSave);
                
                // åæ”¯ãƒ•ã‚©ãƒ¼ãƒ 
                if (typeToggle) {
                    typeToggle.addEventListener('change', handleTypeToggleChange);
                }
                if (toggleExpenseBtn) {
                    toggleExpenseBtn.addEventListener('click', () => {
                        if (typeToggle.checked) {
                            typeToggle.checked = false;
                            typeToggle.dispatchEvent(new Event('change'));
                        } else {
                            updateTypeToggleUI();
                        }
                    });
                }
                if (toggleIncomeBtn) {
                    toggleIncomeBtn.addEventListener('click', () => {
                        if (!typeToggle.checked) {
                            typeToggle.checked = true;
                            typeToggle.dispatchEvent(new Event('change'));
                        } else {
                            updateTypeToggleUI();
                        }
                    });
                }
                addTransactionBtn.addEventListener('click', handleAddTransaction); // è¿½åŠ 
                
                // æ—¥è¨˜ãƒ•ã‚©ãƒ¼ãƒ  (å†™çœŸ)
                photoUpload.addEventListener('change', handlePhotoUpload);
                photoRemoveBtn.addEventListener('click', handlePhotoRemove);

                // æ—¥è¨˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (diaryFilterMood) {
                    diaryFilterMood.addEventListener('change', (event) => {
                        diaryFilters.mood = event.target.value;
                        renderDiaryList();
                    });
                }
                if (diaryFilterPhoto) {
                    diaryFilterPhoto.addEventListener('change', (event) => {
                        diaryFilters.photo = event.target.value;
                        renderDiaryList();
                    });
                }
                if (diaryFilterSearch) {
                    diaryFilterSearch.addEventListener('input', (event) => {
                        diaryFilters.search = event.target.value.trim().toLowerCase();
                        renderDiaryList();
                    });
                }

                if (toggleDiaryFiltersBtn) {
                    toggleDiaryFiltersBtn.addEventListener('click', toggleDiaryFilters);
                }

                if (monthYearHeader) {
                    monthYearHeader.addEventListener('click', openDatePicker);
                }
                if (datePickerOverlay) {
                    datePickerOverlay.addEventListener('click', closeDatePicker);
                }
                if (datePickerCloseBtn) {
                    datePickerCloseBtn.addEventListener('click', closeDatePicker);
                }
                if (datePickerCancelBtn) {
                    datePickerCancelBtn.addEventListener('click', closeDatePicker);
                }
                if (datePickerConfirmBtn) {
                    datePickerConfirmBtn.addEventListener('click', confirmDatePickerSelection);
                }
                if (datePickerYearMinus) {
                    datePickerYearMinus.addEventListener('click', () => adjustDatePickerYear(-1));
                }
                if (datePickerYearPlus) {
                    datePickerYearPlus.addEventListener('click', () => adjustDatePickerYear(1));
                }
                datePickerMonthButtons.forEach((btn) => {
                    btn.addEventListener('click', () => setDatePickerMonth(Number(btn.dataset.monthOption)));
                });

                if (googleLoginBtn) {
                    googleLoginBtn.addEventListener('click', handleGoogleLogin);
                }
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', handleLogout);
                }
                if (analysisAiButton) {
                    analysisAiButton.addEventListener('click', handleAnalysisAdviceRequest);
                }

                // ãƒ†ãƒ¼ãƒãƒ»ã‚«ãƒ†ã‚´ãƒªè¨­å®š
                if (themeToggle) {
                    themeToggle.addEventListener('change', (event) => {
                        appSettings.theme = event.target.checked ? 'dark' : 'light';
                        applyTheme(appSettings.theme);
                        saveSettings();
                        if (currentView === 'analysis') {
                            renderAnalysis();
                        }
                    });
                }

                if (addExpenseCategoryBtn) {
                    addExpenseCategoryBtn.addEventListener('click', () => handleCategoryAdd('expense'));
                }
                if (addIncomeCategoryBtn) {
                    addIncomeCategoryBtn.addEventListener('click', () => handleCategoryAdd('income'));
                }
                if (expenseCategoryInput) {
                    expenseCategoryInput.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            handleCategoryAdd('expense');
                        }
                    });
                }
                if (incomeCategoryInput) {
                    incomeCategoryInput.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            handleCategoryAdd('income');
                        }
                    });
                }

                if (expenseCategoryList) {
                    expenseCategoryList.addEventListener('click', (event) => {
                        const target = event.target.closest('[data-category-action="remove"]');
                        if (!target) return;
                        handleCategoryRemove('expense', target.dataset.categoryName);
                    });
                }
                if (incomeCategoryList) {
                    incomeCategoryList.addEventListener('click', (event) => {
                        const target = event.target.closest('[data-category-action="remove"]');
                        if (!target) return;
                        handleCategoryRemove('income', target.dataset.categoryName);
                    });
                }

                if (photoPreviewModalClose) {
                    photoPreviewModalClose.addEventListener('click', (event) => {
                        event.preventDefault();
                        closePhotoPreview();
                    });
                }
                if (photoPreviewModal) {
                    photoPreviewModal.addEventListener('click', (event) => {
                        if (event.target === photoPreviewModal) {
                            closePhotoPreview();
                        }
                    });
                }
                document.addEventListener('keydown', handleGlobalKeydown);
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape' && photoPreviewModal && !photoPreviewModal.classList.contains('hidden')) {
                        closePhotoPreview();
                    }
                });
            }
            
            // åæ”¯è¿½åŠ å‡¦ç† (é€£ç¶šå…¥åŠ›ç”¨)
            function handleAddTransaction(resetForm = true) {
                const amount = parseInt(amountInput.value);
                if (!amount || amount <= 0) {
                    // é‡‘é¡ãŒ0ã¾ãŸã¯æœªå…¥åŠ›ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
                    if(resetForm) {
                         alert("é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); // å°†æ¥çš„ã«ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆã«ç½®ãæ›ãˆã‚‹
                    }
                    return false; // è¿½åŠ ã•ã‚Œãªã‹ã£ãŸã“ã¨ã‚’ç¤ºã™
                }

                const record = getDayRecord(selectedDateStr);
                const newTransaction = {
                    id: Date.now().toString(),
                    type: typeToggle.checked ? 'income' : 'expense',
                    amount: amount,
                    category: categorySelect.value,
                    memo: memoInput.value
                };
                record.transactions.push(newTransaction);
                
                // ã“ã®æ™‚ç‚¹ã§ã¯ä¿å­˜ã—ãªã„ (saveRecords() ã¯å‘¼ã°ãªã„)
                
                // UIã‚’æ›´æ–°
                renderDailyTransactions(record.transactions);
                
                if (resetForm) {
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    amountInput.value = '';
                    memoInput.value = '';
                    // typeToggle.checked = false; // ã‚¿ã‚¤ãƒ—ã¯ç¶­æŒã™ã‚‹æ–¹ãŒä¾¿åˆ©ã‹ã‚‚
                    // updateCategorySelect();
                }
                
                return true; // è¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™
            }

            // ä¿å­˜å‡¦ç† (ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹)
            async function handleSave() {
                // ãƒ•ã‚©ãƒ¼ãƒ ã«æ®‹ã£ã¦ã„ã‚‹åæ”¯ãŒã‚ã‚Œã°è¿½åŠ ã™ã‚‹
                handleAddTransaction(false); // ãƒªã‚»ãƒƒãƒˆã—ãªã„

                const record = getDayRecord(selectedDateStr);

                // æ—¥è¨˜ä¿å­˜
                record.diary.text = diaryTextInput.value;
                record.diary.mood = selectedMood;
                record.diary.photo = tempPhotoData;

                await saveRecords();
                
                // UIæ›´æ–°
                hideInputModal();
                renderCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
                renderDiaryList(); // æ—¥è¨˜ä¸€è¦§ã®æ›´æ–°
                if (currentView === 'analysis') {
                    renderAnalysis();
                }
            }

            // åæ”¯å‰Šé™¤
            async function handleDeleteTransaction(transactionId) {
                const record = getDayRecord(selectedDateStr);
                record.transactions = record.transactions.filter(t => t.id !== transactionId);
                await saveRecords();
                // åæ”¯ä¸€è¦§ã‚’å†æç”»
                renderDailyTransactions(record.transactions);
            }

            // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            function handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    tempPhotoData = e.target.result;
                    photoPreview.src = tempPhotoData;
                    photoPreview.classList.remove('hidden');
                    photoPreviewText.classList.add('hidden');
                    photoRemoveBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            // å†™çœŸå‰Šé™¤å‡¦ç†
            function handlePhotoRemove() {
                tempPhotoData = null;
                photoPreview.src = '';
                photoPreview.classList.add('hidden');
                photoPreviewText.classList.remove('hidden');
                photoRemoveBtn.classList.add('hidden');
                photoUpload.value = null; // inputã®å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
            }

            // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
            // (å¤ã„formatDateé–¢æ•°ã¯å‰Šé™¤)

            // çŸ­ã„æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (M/D)
            function formatDate(date, format = 'long') {
                const y = date.getFullYear();
                const m = (date.getMonth() + 1).toString();
                const d = date.getDate().toString();
                if (format === 'short') {
                    return `${m}/${d}`;
                }
                // long (YYYY-MM-DD)
                return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
            }

            // é€±ã®é–‹å§‹æ—¥ï¼ˆæ—¥æ›œï¼‰ã¨çµ‚äº†æ—¥ï¼ˆåœŸæ›œï¼‰ã‚’å–å¾—
            function getWeekRange(date) {
                const d = new Date(date);
                const dayOfWeek = d.getDay(); // 0 (Sun) - 6 (Sat)
                const startDate = new Date(d.setDate(d.getDate() - dayOfWeek));
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                
                return {
                    start: startDate,
                    end: endDate
                };
            }

            // --- å®Ÿè¡Œ ---
            initialize();
        });
    </script>
</body>
</html>
        #date-picker-modal {
            z-index: 60;
        }
