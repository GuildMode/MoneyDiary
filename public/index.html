<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Diary</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ï¼ˆTailwindã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«åˆã‚ã›ã‚‹ï¼‰ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* iOSã§ã®"ãƒã‚¦ãƒ³ã‚¹"ï¼ˆã‚ªãƒ¼ãƒãƒ¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ã‚’é˜²ã */
        /* html, body {
            overflow: hidden;
            height: 100%;
        } */

        /* iPhoneã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ï¼ˆãƒãƒƒãƒã‚„ãƒ›ãƒ¼ãƒ ãƒãƒ¼ï¼‰ã‚’è€ƒæ…®ã—ãŸä½™ç™½ */
        :root {
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }

        /* ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠ */
        #app-container {
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
        }

        /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®é«˜ã• */
        #bottom-nav {
            height: calc(60px + var(--safe-area-inset-bottom));
            padding-bottom: var(--safe-area-inset-bottom);
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã®é«˜ã•è¨ˆç®— */
        #main-content {
            height: calc(100vh - 60px - var(--safe-area-inset-top) - var(--safe-area-inset-bottom));
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚°ãƒªãƒƒãƒ‰ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .calendar-day {
            aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢ã« */
        }
        .calendar-day.other-month {
            opacity: 0.3;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        #input-modal-content {
            max-height: calc(100vh - 120px); /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼åˆ†ã‚’å¼•ã */
        }
        
        /* æ„Ÿæƒ…ã‚¢ã‚¤ã‚³ãƒ³é¸æŠæ™‚ */
        .mood-icon.selected {
            transform: scale(1.2);
            background-color: #e0f2fe; /* sky-100 */
        }

        /* åæ”¯ãƒˆã‚°ãƒ« */
        #type-toggle:checked + label div:first-child {
            /* transform: translateX(100%); */
            transform: translateX(4.5rem); /* 72px (w-40(160) - w-1/2(80) - left-1(4) - right-margin(4)) */
        }
        #type-toggle:checked + label {
            background-color: #dcfce7; /* green-100 */
        }
        #type-toggle:not(:checked) + label {
            background-color: #fee2e2; /* red-100 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ã‚¢ãƒ—ãƒªå…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚¹ãƒãƒ›å¹…ã«åˆ¶é™ï¼‰ -->
    <div id="app-container" class="max-w-md mx-auto h-screen bg-white flex flex-col overflow-hidden">

        <!-- 1. ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <main id="main-content" class="flex-grow overflow-y-auto">
            
            <!-- 1-1. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ -->
            <div id="calendar-view" class
="p-4 space-y-4">
                <!-- ãƒ˜ãƒƒãƒ€ãƒ¼: æœˆç§»å‹• -->
                <div class="flex justify-between items-center px-2">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h2 id="month-year-header" class="text-xl font-bold text-gray-800"></h2>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="calendar-grid text-center text-sm font-medium text-gray-500">
                    <div class="text-red-500">æ—¥</div>
                    <div>æœˆ</div>
                    <div>ç«</div>
                    <div>æ°´</div>
                    <div>æœ¨</div>
                    <div>é‡‘</div>
                    <div class="text-blue-500">åœŸ</div>
                </div>

                <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ -->
                <div id="calendar-grid-body" class="calendar-grid">
                    <!-- JSã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>

                <!-- æœˆæ¬¡ã‚µãƒãƒªãƒ¼ -->
                <div class="space-y-2 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700">ä»Šæœˆã®ã‚µãƒãƒªãƒ¼</h3>
                    <div class="flex justify-around text-center">
                        <div>
                            <span class="text-sm text-gray-500">åå…¥</span>
                            <p id="summary-income" class="text-lg font-bold text-blue-600">Â¥0</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">æ”¯å‡º</span>
                            <p id="summary-expense" class="text-lg font-bold text-red-600">Â¥0</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">åæ”¯</span>
                            <p id="summary-balance" class="text-lg font-bold text-gray-800">Â¥0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 1-2. é›†è¨ˆãƒ“ãƒ¥ãƒ¼ -->
            <div id="analysis-view" class="hidden p-4 space-y-4">
                <h2 class="text-xl font-bold text-gray-800 px-2">é›†è¨ˆãƒ»åˆ†æ</h2>

                <!-- é€±/æœˆ/å¹´ ã‚¿ãƒ– -->
                <div class="flex rounded-lg bg-gray-100 p-1">
                    <button id="tab-week" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-600">é€±</button>
                    <button id="tab-month" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white shadow text-blue-600">æœˆ</button>
                    <button id="tab-year" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-600">å¹´</button>
                </div>
                
                <!-- æ—¥ä»˜/æœŸé–“ ç§»å‹• -->
                <div class="flex justify-between items-center px-2">
                    <button id="prev-period-analysis-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h3 id="month-year-analysis-header" class="text-lg font-semibold text-gray-700"></h3>
                    <button id="next-period-analysis-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <!-- æ”¯å‡ºã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰ -->
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h4 class="text-md font-semibold text-gray-700 mb-2">æ”¯å‡ºã‚«ãƒ†ã‚´ãƒªãƒ¼</h4>
                    <div class="w-full max-w-xs mx-auto">
                        <canvas id="expense-chart"></canvas>
                    </div>
                </div>
                
                <!-- åæ”¯æ¨ç§»ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰ -->
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h4 id="balance-chart-title" class="text-md font-semibold text-gray-700 mb-2">ä»Šæœˆã®æ—¥åˆ¥åæ”¯</h4>
                    <div class="w-full mx-auto">
                        <canvas id="balance-chart"></canvas>
                    </div>
                </div>
            </div>

        </main>

        <!-- 2. ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav id="bottom-nav" class="w-full max-w-md mx-auto bg-white border-t border-gray-200 flex justify-around items-center fixed bottom-0">
            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ -->
            <button id="nav-calendar" class="text-blue-600 p-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                <span class="text-xs">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
            </button>
            
            <!-- æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ -->
            <button id="add-new-btn" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg -mt-8 flex justify-center items-center">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            </button>
            
            <!-- é›†è¨ˆãƒœã‚¿ãƒ³ -->
            <button id="nav-analysis" class="text-gray-500 p-3 flex flex-col items-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path></svg>
                <span class="text-xs">é›†è¨ˆ</span>
            </button>
        </nav>

    </div>

    <!-- 3. å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="input-modal" class="hidden fixed inset-0 max-w-md mx-auto h-screen bg-white flex flex-col z-50">
        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="flex justify-between items-center p-4 border-b border-gray-200">
            <button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-100">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 id="modal-date-header" class="text-lg font-bold text-gray-800"></h2>
            <button id="save-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">ä¿å­˜</button>
        </header>

        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="input-modal-content" class="flex-grow p-4 overflow-y-auto space-y-4">
            <!-- åæ”¯ãƒ»æ—¥è¨˜ã‚¿ãƒ– -->
            <div class="flex rounded-lg bg-gray-100 p-1">
                <button id="tab-expense" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white shadow text-blue-600">åæ”¯</button>
                <button id="tab-diary" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-600">æ—¥è¨˜</button>
            </div>

            <!-- åæ”¯å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="expense-form" class="space-y-4">
                <!-- åå…¥/æ”¯å‡º ãƒˆã‚°ãƒ« -->
                <div class="flex items-center justify-center">
                    <input type="checkbox" id="type-toggle" class="hidden" />
                    <label for="type-toggle" class="relative w-40 h-10 rounded-lg flex items-center justify-between px-3 cursor-pointer transition-colors duration-300">
                        <span class="font-semibold text-red-600">æ”¯å‡º</span>
                        <div class="absolute left-1 top-1 w-1/2 h-8 bg-white rounded-md shadow transition-transform duration-300"></div>
                        <span class="font-semibold text-green-600">åå…¥</span>
                    </label>
                </div>

                <!-- é‡‘é¡ -->
                <div>
                    <label for="amount" class="text-sm font-medium text-gray-700">é‡‘é¡</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">Â¥</span>
                        <input type="number" id="amount" placeholder="0" class="w-full pl-8 pr-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-2xl font-bold">
                    </div>
                </div>

                <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ -->
                <div>
                    <label for="category" class="text-sm font-medium text-gray-700">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                    <select id="category" class="w-full mt-1 py-3 px-4 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option>é£Ÿè²»</option>
                        <option>äº¤é€šè²»</option>
                        <option>æ—¥ç”¨å“</option>
                        <option>è¶£å‘³</option>
                        <option>äº¤éš›è²»</option>
                        <option>å›ºå®šè²»</option>
                        <option>ãã®ä»–</option>
                        <option class="text-green-600" value="income-salary">çµ¦ä¸</option>
                        <option class="text-green-600" value="income-other">ãã®ä»–åå…¥</option>
                    </select>
                </div>

                <!-- ãƒ¡ãƒ¢ -->
                <div>
                    <label for="memo" class="text-sm font-medium text-gray-700">ãƒ¡ãƒ¢</label>
                    <input type="text" id="memo" placeholder="ï¼ˆä»»æ„ï¼‰ä¾‹: ã€‡ã€‡ã‚¹ãƒ¼ãƒ‘ãƒ¼" class="w-full mt-1 py-3 px-4 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- åæ”¯è¿½åŠ ãƒœã‚¿ãƒ³ -->
                <div>
                    <button id="add-transaction-btn" class="w-full bg-blue-100 text-blue-700 py-3 rounded-lg font-medium hover:bg-blue-200 transition-colors">
                        ã“ã®åæ”¯ã‚’è¿½åŠ 
                    </button>
                </div>

                <!-- ãã®æ—¥ã®åæ”¯ä¸€è¦§ -->
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">ã“ã®æ—¥ã®åæ”¯</h4>
                    <ul id="daily-transactions" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                    </ul>
                </div>
            </div>

            <!-- æ—¥è¨˜å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="diary-form" class="hidden space-y-4">
                <!-- æ„Ÿæƒ… -->
                <div>
                    <label class="text-sm font-medium text-gray-700">ä»Šæ—¥ã®æ°—åˆ†</label>
                    <div id="mood-selector" class="flex justify-around mt-2">
                        <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- æ—¥è¨˜æœ¬æ–‡ -->
                <div>
                    <label for="diary-text" class="text-sm font-medium text-gray-700">æ—¥è¨˜</label>
                    <textarea id="diary-text" rows="5" placeholder="ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚„æ„Ÿæƒ³..." class="w-full mt-1 p-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>

                <!-- å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                <div>
                    <label class="text-sm font-medium text-gray-700">å†™çœŸ (1æšã¾ã§)</label>
                    <div class="mt-1">
                        <input type="file" id="photo-upload" class="hidden" accept="image/*">
                        <label for="photo-upload" class="cursor-pointer w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex justify-center items-center text-gray-500 hover:bg-gray-50">
                            <span id="photo-preview-text">
                                <svg class="w-10 h-10 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01M3 10a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V10z"></path></svg>
                                å†™çœŸã‚’é¸æŠ
                            </span>
                            <img id="photo-preview" src="" class="hidden w-full h-full object-cover rounded-lg">
                        </label>
                        <button id="photo-remove-btn" class="hidden text-sm text-red-500 mt-1">å†™çœŸã‚’å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- çŠ¶æ…‹ç®¡ç† ---
            let currentView = 'calendar'; // 'calendar' or 'analysis'
            let currentAnalysisView = 'month'; // 'week', 'month', 'year'
            let currentDate = new Date(); // è¡¨ç¤ºç”¨ã®ç¾åœ¨æœˆãƒ»é€±ãƒ»å¹´
            let selectedDateStr = formatDate(new Date()); // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ (YYYY-MM-DD)
            let records = {}; // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
            let tempPhotoData = null; // ä¸€æ™‚çš„ãªå†™çœŸãƒ‡ãƒ¼ã‚¿(Base64)
            let selectedMood = null; // é¸æŠä¸­ã®æ„Ÿæƒ…

            // ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
            let expenseChartInstance = null;
            let balanceChartInstance = null;

            // å®šæ•°
            const MOODS = ['ğŸ˜„', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜¡']; // 5æ®µéšã«å¤‰æ›´
            const CATEGORIES = {
                expense: ['é£Ÿè²»', 'äº¤é€šè²»', 'æ—¥ç”¨å“', 'è¶£å‘³', 'äº¤éš›è²»', 'å›ºå®šè²»', 'ãã®ä»–'],
                income: ['çµ¦ä¸', 'ãã®ä»–åå…¥']
            };

            // --- DOMè¦ç´  ---
            const calendarView = document.getElementById('calendar-view');
            const analysisView = document.getElementById('analysis-view');
            const navCalendar = document.getElementById('nav-calendar');
            const navAnalysis = document.getElementById('nav-analysis');
            const addNewBtn = document.getElementById('add-new-btn');
            const inputModal = document.getElementById('input-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const saveBtn = document.getElementById('save-btn');
            const modalDateHeader = document.getElementById('modal-date-header');
            const tabExpense = document.getElementById('tab-expense');
            const tabDiary = document.getElementById('tab-diary');
            const expenseForm = document.getElementById('expense-form');
            const diaryForm = document.getElementById('diary-form');
            const typeToggle = document.getElementById('type-toggle');
            const amountInput = document.getElementById('amount');
            const categorySelect = document.getElementById('category');
            const memoInput = document.getElementById('memo');
            const addTransactionBtn = document.getElementById('add-transaction-btn'); // è¿½åŠ 
            const dailyTransactionsList = document.getElementById('daily-transactions');
            const moodSelector = document.getElementById('mood-selector');
            const diaryTextInput = document.getElementById('diary-text');
            const photoUpload = document.getElementById('photo-upload');
            const photoPreview = document.getElementById('photo-preview');
            const photoPreviewText = document.getElementById('photo-preview-text');
            const photoRemoveBtn = document.getElementById('photo-remove-btn');

            // --- åˆæœŸåŒ– ---
            function initialize() {
                loadRecords();
                renderCalendar();
                renderAnalysis(); // åˆæœŸæç”»
                setupEventListeners();
                updateNavUI();
                renderMoodSelector();
            }

            // --- ãƒ‡ãƒ¼ã‚¿æ“ä½œ ---
            function loadRecords() {
                records = JSON.parse(localStorage.getItem('moneyDiaryRecords')) || {};
            }

            function saveRecords() {
                localStorage.setItem('moneyDiaryRecords', JSON.stringify(records));
            }

            function getDayRecord(dateStr) {
                // YYYY-MM-DD
                if (!records[dateStr]) {
                    records[dateStr] = {
                        transactions: [], // { id, type, amount, category, memo }
                        diary: { text: '', mood: null, photo: null }
                    };
                }
                return records[dateStr];
            }

            // --- æç”» ---

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
            function renderCalendar() {
                const calendarGridBody = document.getElementById('calendar-grid-body');
                const monthYearHeader = document.getElementById('month-year-header');
                
                calendarGridBody.innerHTML = '';
                monthYearHeader.textContent = `${currentDate.getFullYear()}å¹´ ${currentDate.getMonth() + 1}æœˆ`;

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // å‰æœˆã®æ—¥ä»˜
                const prevDaysInMonth = new Date(year, month, 0).getDate();
                for (let i = firstDay - 1; i >= 0; i--) {
                    const day = prevDaysInMonth - i;
                    calendarGridBody.appendChild(createDayElement(day, true));
                }

                // ä»Šæœˆã®æ—¥ä»˜
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = formatDate(new Date(year, month, day));
                    const record = records[dateStr];
                    calendarGridBody.appendChild(createDayElement(day, false, record, dateStr));
                }

                // æ¥æœˆã®æ—¥ä»˜
                const totalCells = firstDay + daysInMonth;
                const nextDays = (7 - (totalCells % 7)) % 7;
                for (let day = 1; day <= nextDays; day++) {
                    calendarGridBody.appendChild(createDayElement(day, true));
                }
                
                renderMonthSummary();
            }
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚»ãƒ«ä½œæˆ
            function createDayElement(day, isOtherMonth, record, dateStr) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day p-1 text-sm cursor-pointer relative flex flex-col items-center justify-start rounded-lg hover:bg-blue-50';
                
                if (isOtherMonth) {
                    dayEl.classList.add('other-month');
                    dayEl.innerHTML = `<span>${day}</span>`;
                } else {
                    dayEl.dataset.date = dateStr;
                    
                    // æ—¥ä»˜
                    const dateNum = document.createElement('span');
                    dateNum.textContent = day;
                    dateNum.className = 'font-medium';
                    
                    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒãƒ¼ã‚¯
                    const todayStr = formatDate(new Date());
                    if (dateStr === todayStr) {
                        dateNum.className = 'bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold';
                    }
                    dayEl.appendChild(dateNum);

                    // è¨˜éŒ²ã‚¢ã‚¤ã‚³ãƒ³
                    if (record) {
                        const iconsWrapper = document.createElement('div');
                        iconsWrapper.className = 'flex flex-wrap justify-center items-center gap-1 mt-1';
                        
                        // æ„Ÿæƒ…
                        if (record.diary && record.diary.mood) {
                            const moodIcon = document.createElement('span');
                            moodIcon.textContent = record.diary.mood;
                            moodIcon.className = 'text-xs';
                            iconsWrapper.appendChild(moodIcon);
                        }

                        // å†™çœŸ
                        if (record.diary && record.diary.photo) {
                            const photoIcon = document.createElement('span');
                            photoIcon.innerHTML = 'ğŸ“·';
                            photoIcon.className = 'text-xs';
                            iconsWrapper.appendChild(photoIcon);
                        }

                        // åæ”¯ (æ”¯å‡º/åå…¥)
                        const totalExpense = record.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                        const totalIncome = record.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);

                        if (totalExpense > 0) {
                            const expenseDot = document.createElement('span');
                            expenseDot.className = 'w-1.5 h-1.5 bg-red-500 rounded-full';
                            iconsWrapper.appendChild(expenseDot);
                        }
                        if (totalIncome > 0) {
                            const incomeDot = document.createElement('span');
                            incomeDot.className = 'w-1.5 h-1.5 bg-blue-500 rounded-full';
                            iconsWrapper.appendChild(incomeDot);
                        }

                        dayEl.appendChild(iconsWrapper);
                    }
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                    dayEl.addEventListener('click', () => {
                        selectedDateStr = dateStr;
                        showInputModal();
                    });
                }
                return dayEl;
            }

            // æœˆæ¬¡ã‚µãƒãƒªãƒ¼æç”»
            function renderMonthSummary() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                let totalIncome = 0;
                let totalExpense = 0;

                for (const dateStr in records) {
                    const date = new Date(dateStr);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                totalIncome += t.amount;
                            } else {
                                totalExpense += t.amount;
                            }
                        });
                    }
                }

                document.getElementById('summary-income').textContent = `Â¥${totalIncome.toLocaleString()}`;
                document.getElementById('summary-expense').textContent = `Â¥${totalExpense.toLocaleString()}`;
                document.getElementById('summary-balance').textContent = `Â¥${(totalIncome - totalExpense).toLocaleString()}`;
            }
            
            // é›†è¨ˆç”»é¢æç”» (ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£)
            function renderAnalysis() {
                updateAnalysisTabUI();

                // æœŸé–“ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ›´æ–°
                const header = document.getElementById('month-year-analysis-header');
                if (currentAnalysisView === 'week') {
                    const week = getWeekRange(currentDate);
                    header.textContent = `${formatDate(week.start, 'short')} ~ ${formatDate(week.end, 'short')}`;
                    document.getElementById('balance-chart-title').textContent = 'ä»Šé€±ã®æ—¥åˆ¥åæ”¯';
                    renderWeekAnalysis(week);
                } else if (currentAnalysisView === 'year') {
                    header.textContent = `${currentDate.getFullYear()}å¹´`;
                    document.getElementById('balance-chart-title').textContent = 'ä»Šå¹´ã®æœˆåˆ¥åæ”¯';
                    renderYearAnalysis();
                } else { // month
                    header.textContent = `${currentDate.getFullYear()}å¹´ ${currentDate.getMonth() + 1}æœˆ`;
                    document.getElementById('balance-chart-title').textContent = 'ä»Šæœˆã®æ—¥åˆ¥åæ”¯';
                    renderMonthAnalysis();
                }
            }

            // æœˆæ¬¡é›†è¨ˆ
            function renderMonthAnalysis() {
                // document.getElementById('month-year-analysis-header').textContent = `${currentDate.getFullYear()}å¹´ ${currentDate.getMonth() + 1}æœˆ`;
                
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                // ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
                const expenseData = {};
                const dailyData = {}; // æ—¥åˆ¥ã®åæ”¯
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let day = 1; day <= daysInMonth; day++) {
                    dailyData[day] = { income: 0, expense: 0 };
                }

                for (const dateStr in records) {
                    const date = new Date(dateStr);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        const day = date.getDate();
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                dailyData[day].income += t.amount;
                            } else {
                                dailyData[day].expense += t.amount;
                                expenseData[t.category] = (expenseData[t.category] || 0) + t.amount;
                            }
                        });
                    }
                }

                // 1. æ”¯å‡ºå††ã‚°ãƒ©ãƒ•
                const expenseCtx = document.getElementById('expense-chart').getContext('2d');
                const labels = Object.keys(expenseData);
                const data = Object.values(expenseData);
                
                if (expenseChartInstance) {
                    expenseChartInstance.destroy();
                }

                if (labels.length > 0) {
                    expenseChartInstance = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'æ”¯å‡º',
                                data: data,
                                backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#8b5cf6', '#64748b'],
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                },
                            }
                        }
                    });
                } else {
                     expenseCtx.clearRect(0, 0, expenseCtx.canvas.width, expenseCtx.canvas.height);
                     expenseCtx.fillText("ã“ã®æœˆã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“", expenseCtx.canvas.width/2, expenseCtx.canvas.height/2);
                     expenseCtx.textAlign = 'center';
                }

                // 2. æ—¥åˆ¥åæ”¯æ£’ã‚°ãƒ©ãƒ•
                const balanceCtx = document.getElementById('balance-chart').getContext('2d');
                const dayLabels = Object.keys(dailyData).map(day => `${day}æ—¥`);
                const incomeValues = Object.values(dailyData).map(d => d.income);
                const expenseValues = Object.values(dailyData).map(d => d.expense);

                if (balanceChartInstance) {
                    balanceChartInstance.destroy();
                }

                balanceChartInstance = new Chart(balanceCtx, {
                    type: 'bar',
                    data: {
                        labels: dayLabels,
                        datasets: [
                            {
                                label: 'åå…¥',
                                data: incomeValues,
                                backgroundColor: '#3b82f6', // blue-500
                            },
                            {
                                label: 'æ”¯å‡º',
                                data: expenseValues,
                                backgroundColor: '#ef4444', // red-500
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });
            }

            // é€±æ¬¡é›†è¨ˆ
            function renderWeekAnalysis(week) {
                const expenseData = {};
                const dailyData = {};
                const labels = [];

                // é€±ã®å„æ—¥ã‚’åˆæœŸåŒ–
                for (let d = new Date(week.start); d <= week.end; d.setDate(d.getDate() + 1)) {
                    const dateStr = formatDate(d);
                    labels.push(`${d.getMonth() + 1}/${d.getDate()}æ—¥`);
                    dailyData[dateStr] = { income: 0, expense: 0 };
                }

                // ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
                for (const dateStr in dailyData) {
                    if (records[dateStr]) {
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                dailyData[dateStr].income += t.amount;
                            } else {
                                dailyData[dateStr].expense += t.amount;
                                expenseData[t.category] = (expenseData[t.category] || 0) + t.amount;
                            }
                        });
                    }
                }

                // 1. æ”¯å‡ºå††ã‚°ãƒ©ãƒ•
                const expenseCtx = document.getElementById('expense-chart').getContext('2d');
                const expenseLabels = Object.keys(expenseData);
                const doughnutData = Object.values(expenseData); // å¤‰æ•°åã‚’ 'expenseValues' ã‹ã‚‰ 'doughnutData' ã«å¤‰æ›´
                
                if (expenseChartInstance) expenseChartInstance.destroy();
                if (expenseLabels.length > 0) {
                    expenseChartInstance = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: {
                            labels: expenseLabels,
                            datasets: [{ data: doughnutData, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#8b5cf6', '#64748b'] }] // 'doughnutData' ã‚’ä½¿ç”¨
                        },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });
                } else {
                     expenseCtx.clearRect(0, 0, expenseCtx.canvas.width, expenseCtx.canvas.height);
                     expenseCtx.fillText("ã“ã®é€±ã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“", expenseCtx.canvas.width/2, expenseCtx.canvas.height/2);
                     expenseCtx.textAlign = 'center';
                }

                // 2. æ—¥åˆ¥åæ”¯æ£’ã‚°ãƒ©ãƒ•
                const balanceCtx = document.getElementById('balance-chart').getContext('2d');
                const incomeValues = Object.values(dailyData).map(d => d.income);
                const expenseValues = Object.values(dailyData).map(d => d.expense);

                if (balanceChartInstance) balanceChartInstance.destroy();
                balanceChartInstance = new Chart(balanceCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'åå…¥', data: incomeValues, backgroundColor: '#3b82f6' },
                            { label: 'æ”¯å‡º', data: expenseValues, backgroundColor: '#ef4444' }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: { x: { stacked: true }, y: { stacked: true } },
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }

            // å¹´æ¬¡é›†è¨ˆ
            function renderYearAnalysis() {
                const year = currentDate.getFullYear();
                const expenseData = {};
                const monthlyData = {};
                const labels = [];

                for (let m = 0; m < 12; m++) {
                    labels.push(`${m + 1}æœˆ`);
                    monthlyData[m] = { income: 0, expense: 0 };
                }

                for (const dateStr in records) {
                    const date = new Date(dateStr);
                    if (date.getFullYear() === year) {
                        const month = date.getMonth();
                        records[dateStr].transactions.forEach(t => {
                            if (t.type === 'income') {
                                monthlyData[month].income += t.amount;
                            } else {
                                monthlyData[month].expense += t.amount;
                                expenseData[t.category] = (expenseData[t.category] || 0) + t.amount;
                            }
                        });
                    }
                }

                // 1. æ”¯å‡ºå††ã‚°ãƒ©ãƒ•
                const expenseCtx = document.getElementById('expense-chart').getContext('2d');
                const expenseLabels = Object.keys(expenseData);
                const yearDoughnutData = Object.values(expenseData); // å¤‰æ•°åã‚’ 'expenseValues' ã‹ã‚‰ 'yearDoughnutData' ã«å¤‰æ›´
                
                if (expenseChartInstance) expenseChartInstance.destroy();
                if (expenseLabels.length > 0) {
                    expenseChartInstance = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: {
                            labels: expenseLabels,
                            datasets: [{ data: yearDoughnutData, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#8b5cf6', '#64748b'] }] // 'yearDoughnutData' ã‚’ä½¿ç”¨
                        },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });
                } else {
                     expenseCtx.clearRect(0, 0, expenseCtx.canvas.width, expenseCtx.canvas.height);
                     expenseCtx.fillText("ã“ã®å¹´ã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“", expenseCtx.canvas.width/2, expenseCtx.canvas.height/2);
                     expenseCtx.textAlign = 'center';
                }

                // 2. æœˆåˆ¥åæ”¯æ£’ã‚°ãƒ©ãƒ•
                const balanceCtx = document.getElementById('balance-chart').getContext('2d');
                const incomeValues = Object.values(monthlyData).map(d => d.income);
                const expenseValues = Object.values(monthlyData).map(d => d.expense);

                if (balanceChartInstance) balanceChartInstance.destroy();
                balanceChartInstance = new Chart(balanceCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'åå…¥', data: incomeValues, backgroundColor: '#3b82f6' },
                            { label: 'æ”¯å‡º', data: expenseValues, backgroundColor: '#ef4444' }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: { x: { stacked: true }, y: { stacked: true } },
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }

            // æ„Ÿæƒ…ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æç”»
            function renderMoodSelector() {
                moodSelector.innerHTML = '';
                MOODS.forEach(mood => {
                    const btn = document.createElement('button');
                    btn.textContent = mood;
                    btn.className = 'mood-icon text-3xl p-2 rounded-full hover:bg-gray-100 transition-all duration-200';
                    btn.dataset.mood = mood;
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        selectedMood = mood;
                        // é¸æŠçŠ¶æ…‹ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ›´æ–°
                        document.querySelectorAll('.mood-icon').forEach(icon => icon.classList.remove('selected'));
                        btn.classList.add('selected');
                    });
                    moodSelector.appendChild(btn);
                });
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            function showInputModal() {
                modalDateHeader.textContent = selectedDateStr;
                
                const record = getDayRecord(selectedDateStr);
                
                // åæ”¯ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚»ãƒƒãƒˆ
                amountInput.value = '';
                memoInput.value = '';
                typeToggle.checked = false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’æ”¯å‡ºã«
                updateCategorySelect();

                // åæ”¯ä¸€è¦§ã®æç”»
                renderDailyTransactions(record.transactions);
                
                // æ—¥è¨˜ãƒ•ã‚©ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿
                diaryTextInput.value = record.diary.text || '';
                selectedMood = record.diary.mood;
                updateMoodSelectorUI(selectedMood);
                
                // å†™çœŸã®èª­ã¿è¾¼ã¿
                tempPhotoData = record.diary.photo;
                if (tempPhotoData) {
                    photoPreview.src = tempPhotoData;
                    photoPreview.classList.remove('hidden');
                    photoPreviewText.classList.add('hidden');
                    photoRemoveBtn.classList.remove('hidden');
                } else {
                    photoPreview.src = '';
                    photoPreview.classList.add('hidden');
                    photoPreviewText.classList.remove('hidden');
                    photoRemoveBtn.classList.add('hidden');
                }

                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                inputModal.classList.remove('hidden');
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯åæ”¯ã‚¿ãƒ–
                showTab('expense');
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
            function hideInputModal() {
                inputModal.classList.add('hidden');
                // ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                tempPhotoData = null;
                selectedMood = null;
            }

            // --- UIãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³UIæ›´æ–°
            function updateNavUI() {
                if (currentView === 'calendar') {
                    calendarView.classList.remove('hidden');
                    analysisView.classList.add('hidden');
                    navCalendar.classList.add('text-blue-600');
                    navCalendar.classList.remove('text-gray-500');
                    navAnalysis.classList.add('text-gray-500');
                    navAnalysis.classList.remove('text-blue-600');
                } else {
                    calendarView.classList.add('hidden');
                    analysisView.classList.remove('hidden');
                    navCalendar.classList.add('text-gray-500');
                    navCalendar.classList.remove('text-blue-600');
                    navAnalysis.classList.add('text-blue-600');
                    navAnalysis.classList.remove('text-gray-500');
                    // analysisView è¡¨ç¤ºæ™‚ã«ã‚°ãƒ©ãƒ•ã‚’å†æç”»
                    renderAnalysis();
                }
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            function showTab(tabName) {
                if (tabName === 'expense') {
                    expenseForm.classList.remove('hidden');
                    diaryForm.classList.add('hidden');
                    tabExpense.classList.add('bg-white', 'shadow', 'text-blue-600');
                    tabExpense.classList.remove('text-gray-600');
                    tabDiary.classList.remove('bg-white', 'shadow', 'text-blue-600');
                    tabDiary.classList.add('text-gray-600');
                } else {
                    expenseForm.classList.add('hidden');
                    diaryForm.classList.remove('hidden');
                    tabExpense.classList.remove('bg-white', 'shadow', 'text-blue-600');
                    tabExpense.classList.add('text-gray-600');
                    tabDiary.classList.add('bg-white', 'shadow', 'text-blue-600');
                    tabDiary.classList.remove('text-gray-600');
                }
            }

            // é›†è¨ˆã‚¿ãƒ–UIæ›´æ–°
            function updateAnalysisTabUI() {
                const tabs = [
                    document.getElementById('tab-week'),
                    document.getElementById('tab-month'),
                    document.getElementById('tab-year')
                ];
                tabs.forEach(tab => {
                    tab.classList.remove('bg-white', 'shadow', 'text-blue-600');
                    tab.classList.add('text-gray-600');
                });
                
                if (currentAnalysisView === 'week') {
                    document.getElementById('tab-week').classList.add('bg-white', 'shadow', 'text-blue-600');
                } else if (currentAnalysisView === 'year') {
                    document.getElementById('tab-year').classList.add('bg-white', 'shadow', 'text-blue-600');
                } else { // month
                    document.getElementById('tab-month').classList.add('bg-white', 'shadow', 'text-blue-600');
                }
            }
            
            // æ„Ÿæƒ…ã‚»ãƒ¬ã‚¯ã‚¿UIæ›´æ–°
            function updateMoodSelectorUI(mood) {
                document.querySelectorAll('.mood-icon').forEach(icon => {
                    if (icon.dataset.mood === mood) {
                        icon.classList.add('selected');
                    } else {
                        icon.classList.remove('selected');
                    }
                });
            }

            // ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠè‚¢æ›´æ–° (åå…¥/æ”¯å‡º)
            function updateCategorySelect() {
                const isIncome = typeToggle.checked;
                const options = isIncome ? CATEGORIES.income : CATEGORIES.expense;
                
                categorySelect.innerHTML = '';
                options.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categorySelect.appendChild(option);
                });
            }

            // æ—¥åˆ¥åæ”¯ä¸€è¦§ã‚’æç”»
            function renderDailyTransactions(transactions) {
                dailyTransactionsList.innerHTML = '';
                if (transactions.length === 0) {
                    dailyTransactionsList.innerHTML = '<li class="text-sm text-gray-500 text-center">ã“ã®æ—¥ã®åæ”¯ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
                    return;
                }
                
                transactions.forEach(t => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg';
                    
                    const left = document.createElement('div');
                    const category = document.createElement('span');
                    category.textContent = t.category;
                    category.className = 'font-medium text-sm';
                    const memo = document.createElement('span');
                    memo.textContent = t.memo ? ` (${t.memo})` : '';
                    memo.className = 'text-xs text-gray-500 ml-1';
                    left.appendChild(category);
                    left.appendChild(memo);

                    const right = document.createElement('div');
                    const amount = document.createElement('span');
                    amount.textContent = `Â¥${t.amount.toLocaleString()}`;
                    amount.className = `font-semibold text-sm ${t.type === 'income' ? 'text-blue-600' : 'text-red-600'}`;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;'; // Ã—
                    deleteBtn.className = 'ml-2 text-red-500 hover:text-red-700 font-bold';
                    deleteBtn.onclick = () => handleDeleteTransaction(t.id);

                    right.appendChild(amount);
                    right.appendChild(deleteBtn);
                    li.appendChild(left);
                    li.appendChild(right);
                    dailyTransactionsList.appendChild(li);
                });
            }
            
            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
            
            function setupEventListeners() {
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
                navCalendar.addEventListener('click', () => {
                    currentView = 'calendar';
                    updateNavUI();
                });
                navAnalysis.addEventListener('click', () => {
                    currentView = 'analysis';
                    // renderAnalysis(); // updateNavUIå†…ã§å‘¼ã³å‡ºã•ã‚Œã‚‹
                    updateNavUI();
                });

                // æœˆç§»å‹• (ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼)
                document.getElementById('prev-month-btn').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });
                document.getElementById('next-month-btn').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });

                // æœŸé–“ç§»å‹• (é›†è¨ˆ)
                document.getElementById('prev-period-analysis-btn').addEventListener('click', () => {
                    if (currentAnalysisView === 'week') {
                        currentDate.setDate(currentDate.getDate() - 7);
                    } else if (currentAnalysisView === 'year') {
                        currentDate.setFullYear(currentDate.getFullYear() - 1);
                    } else { // month
                        currentDate.setMonth(currentDate.getMonth() - 1);
                    }
                    renderAnalysis();
                });
                document.getElementById('next-period-analysis-btn').addEventListener('click', () => {
                    if (currentAnalysisView === 'week') {
                        currentDate.setDate(currentDate.getDate() - 7);
                    } else if (currentAnalysisView === 'year') {
                        currentDate.setFullYear(currentDate.getFullYear() - 1);
                    } else { // month
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                    renderAnalysis();
                });
                
                // é›†è¨ˆã‚¿ãƒ–
                document.getElementById('tab-week').addEventListener('click', () => {
                    currentAnalysisView = 'week';
                    currentDate = new Date(); // é€±è¡¨ç¤ºã¯ä»Šæ—¥ã‚’åŸºæº–ã«ãƒªã‚»ãƒƒãƒˆ
                    renderAnalysis();
                });
                document.getElementById('tab-month').addEventListener('click', () => {
                    currentAnalysisView = 'month';
                    currentDate = new Date(); // æœˆè¡¨ç¤ºã¯ä»Šæœˆã«ãƒªã‚»ãƒƒãƒˆ
                    renderAnalysis();
                });
                document.getElementById('tab-year').addEventListener('click', () => {
                    currentAnalysisView = 'year';
                    currentDate = new Date(); // å¹´è¡¨ç¤ºã¯ä»Šå¹´ã«ãƒªã‚»ãƒƒãƒˆ
                    renderAnalysis();
                });

                // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
                addNewBtn.addEventListener('click', () => {
                    selectedDateStr = formatDate(new Date()); // æ–°è¦è¿½åŠ ã¯ä»Šæ—¥
                    showInputModal();
                });
                closeModalBtn.addEventListener('click', hideInputModal);

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ãƒ–
                tabExpense.addEventListener('click', () => showTab('expense'));
                tabDiary.addEventListener('click', () => showTab('diary'));

                // ä¿å­˜
                saveBtn.addEventListener('click', handleSave);
                
                // åæ”¯ãƒ•ã‚©ãƒ¼ãƒ 
                typeToggle.addEventListener('change', updateCategorySelect);
                addTransactionBtn.addEventListener('click', handleAddTransaction); // è¿½åŠ 
                
                // æ—¥è¨˜ãƒ•ã‚©ãƒ¼ãƒ  (å†™çœŸ)
                photoUpload.addEventListener('change', handlePhotoUpload);
                photoRemoveBtn.addEventListener('click', handlePhotoRemove);
            }
            
            // åæ”¯è¿½åŠ å‡¦ç† (é€£ç¶šå…¥åŠ›ç”¨)
            function handleAddTransaction(resetForm = true) {
                const amount = parseInt(amountInput.value);
                if (!amount || amount <= 0) {
                    // é‡‘é¡ãŒ0ã¾ãŸã¯æœªå…¥åŠ›ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
                    if(resetForm) {
                         alert("é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); // å°†æ¥çš„ã«ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆã«ç½®ãæ›ãˆã‚‹
                    }
                    return false; // è¿½åŠ ã•ã‚Œãªã‹ã£ãŸã“ã¨ã‚’ç¤ºã™
                }

                const record = getDayRecord(selectedDateStr);
                const newTransaction = {
                    id: Date.now().toString(),
                    type: typeToggle.checked ? 'income' : 'expense',
                    amount: amount,
                    category: categorySelect.value,
                    memo: memoInput.value
                };
                record.transactions.push(newTransaction);
                
                // ã“ã®æ™‚ç‚¹ã§ã¯ä¿å­˜ã—ãªã„ (saveRecords() ã¯å‘¼ã°ãªã„)
                
                // UIã‚’æ›´æ–°
                renderDailyTransactions(record.transactions);
                
                if (resetForm) {
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    amountInput.value = '';
                    memoInput.value = '';
                    // typeToggle.checked = false; // ã‚¿ã‚¤ãƒ—ã¯ç¶­æŒã™ã‚‹æ–¹ãŒä¾¿åˆ©ã‹ã‚‚
                    // updateCategorySelect();
                }
                
                return true; // è¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™
            }

            // ä¿å­˜å‡¦ç† (ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹)
            function handleSave() {
                // ãƒ•ã‚©ãƒ¼ãƒ ã«æ®‹ã£ã¦ã„ã‚‹åæ”¯ãŒã‚ã‚Œã°è¿½åŠ ã™ã‚‹
                handleAddTransaction(false); // ãƒªã‚»ãƒƒãƒˆã—ãªã„

                const record = getDayRecord(selectedDateStr);

                // æ—¥è¨˜ä¿å­˜
                record.diary.text = diaryTextInput.value;
                record.diary.mood = selectedMood;
                record.diary.photo = tempPhotoData;

                saveRecords();
                
                // UIæ›´æ–°
                hideInputModal();
                renderCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
                // renderAnalysis(); // analysisãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ã«æ›´æ–°ã•ã‚Œã‚‹
            }

            // åæ”¯å‰Šé™¤
            function handleDeleteTransaction(transactionId) {
                const record = getDayRecord(selectedDateStr);
                record.transactions = record.transactions.filter(t => t.id !== transactionId);
                saveRecords();
                // åæ”¯ä¸€è¦§ã‚’å†æç”»
                renderDailyTransactions(record.transactions);
            }

            // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            function handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    tempPhotoData = e.target.result;
                    photoPreview.src = tempPhotoData;
                    photoPreview.classList.remove('hidden');
                    photoPreviewText.classList.add('hidden');
                    photoRemoveBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            // å†™çœŸå‰Šé™¤å‡¦ç†
            function handlePhotoRemove() {
                tempPhotoData = null;
                photoPreview.src = '';
                photoPreview.classList.add('hidden');
                photoPreviewText.classList.remove('hidden');
                photoRemoveBtn.classList.add('hidden');
                photoUpload.value = null; // inputã®å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
            }

            // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
            // (å¤ã„formatDateé–¢æ•°ã¯å‰Šé™¤)

            // çŸ­ã„æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (M/D)
            function formatDate(date, format = 'long') {
                const y = date.getFullYear();
                const m = (date.getMonth() + 1).toString();
                const d = date.getDate().toString();
                if (format === 'short') {
                    return `${m}/${d}`;
                }
                // long (YYYY-MM-DD)
                return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
            }

            // é€±ã®é–‹å§‹æ—¥ï¼ˆæ—¥æ›œï¼‰ã¨çµ‚äº†æ—¥ï¼ˆåœŸæ›œï¼‰ã‚’å–å¾—
            function getWeekRange(date) {
                const d = new Date(date);
                const dayOfWeek = d.getDay(); // 0 (Sun) - 6 (Sat)
                const startDate = new Date(d.setDate(d.getDate() - dayOfWeek));
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                
                return {
                    start: startDate,
                    end: endDate
                };
            }

            // --- å®Ÿè¡Œ ---
            initialize();
        });
    </script>
</body>
</html>